# Networks {#sec-network}

```{r}
#| echo: false
library(knitr)
library(kableExtra)
library(fontawesome)
```

By the end of this chapter you should gain the following knowledge and practical skills.

::: {.callout-note}

## Knowledge

- [x] The special structure and vocabulary used to represent network data.
- [x] The strengths, weaknesses and trade-offs of network visualizations and of incorporating geographic context.

:::


::: {.callout-note}

## Practical skills

- [x] Write `ggplot2` specifications that use containment to analyse spatial network origin-destination data.

:::

## Introduction

Networks are a special class of data used to represent things (entities) and how they relate to one another. Network data consist of two types of element: *nodes*, the entities themselves, and *edges*, the connections between nodes. Both nodes and edges can have additional information attached to them -- counts, categories and directions. Network data are cumbersome to work with in R as they are not represented well  by flat data frames. A common workflow is to split the data across two tables -- one representing nodes and one representing edges [@wickham_ggplot2_2020].

A category of network data used heavily in geospatial analysis is origin-destination (OD) data describing, for example, flows of bikes [@beecham_connected_2023] and commuters [@beecham_characterising_2019] around a city, or [water](https://public.tableau.com/profile/robradburn#!/vizhome/LiquidCapital/VirtualWater) around a country. These data consist of *nodes*, origin and destination locations, and *edges*, flows linking those origins and destinations. Whilst statistics from [Network Science](https://en.wikipedia.org/wiki/Network_science) can and have been deployed in the analysis of geospatial OD data, visualization techniques provide much assistance in exposing the types of complex structural patterns and relations that result from locating OD flow data within geographic context.

In this chapter we will work with an accessible and widely used origin-destination network dataset: Census travel-to-work data. This records counts of individuals commuting between locations ([census geographies](https://www.ons.gov.uk/methodology/geography/ukgeographies/censusgeography#census-geography)) of the UK.


## Concepts

### Network data: nodes and edges

This chapter introduces techniques for visually representing networks and evaluates their usefulness through an analysis of Census OD travel-to-work data in London. The *nodes* in this dataset are London's 33 boroughs and the *edges* are directed OD pairs between these boroughs.

```{r nodes-data, echo=FALSE, out.width="50%"}

```{r}
#| label: tbl-nodes-data
#| tbl-cap: "Pedestrian casualties by vehicle involved and injury severity."
#| echo: false
#| eval: false
#| warning: false
#| out.width: 90%
data <- tibble::tibble(
  "borough" = c("Barking and Dagenham", "Barnet", "Bexley", "..."),
  "out" = c("54237", "117657", "77263", "..."),
  "in" = c("33605", "72024", "39232", "...")
  )
kbl(data,  caption = "Nodes table: London Boroughs.", escape = FALSE) |> kable_minimal()
```


```{r edges-data, echo=FALSE, out.width="50%"}
data <- tibble::tibble(
  "origin" = c("Barking and Dagenham", "Barking and Dagenham", "Barking and Dagenham", "..."),
  "destination" = c("Barking and Dagenham", "Barnet", "Bexley", "..."),
  "freq" = c("14650", "280", "155", "...")
  )
kbl(data,  caption = "Edges table: OD pairs between London Boroughs.", escape = FALSE) |> kable_minimal()
```

In @fig-flows-bor frequencies of the number of *jobs* available in each borough and *workers* living in each borough (the nodes) are represented. Note that job-rich boroughs in central London -- Westminster, City of London, Camden, Tower Hamlets -- contain many more *jobs* than *workers* residing in them. We can infer that there is a high level of in-commuting to those boroughs and the corollary, a high level of out-commuting for boroughs containing large numbers of *workers* but comparatively fewer *jobs*. 


### Node-link representations

Perhaps the most common class of network visualization tha could be used to represent the data in  @tbl-nodes-data and @tbl-edges-data are node-link diagrams. These depict graphs in two dimensions as a force-directed layout. Nodes are positioned such that those sharing greater connection -- edges with greater weights (frequencies) -- are closer than those that are less well-connected -- that do not share edges with such large weights. Edges are drawn as lines *connecting* nodes.

Figure @fig-flows-bor uses a force-directed layout to represent the travel-to-work data. This shows large numbers of flows between job-rich boroughs, particularly Westminster, and boroughs containing large resident populations: Wandsworth, Lambeth, Southwark close to central London; Barnet, Brent, Haringey further from central London. If the aim is to compare relative frequencies of flows and *locate* them in geographic context -- to understand both the distribution and geography of travel-to-work in London, then we can make better use of *position*. In Figure @fig-lines-geog, nodes (boroughs) are placed in their exact geographic position (geometric centroid of boroughs), and line width and transparency is used to encode flow frequency. In the plot on the bottom row, flow *direction* is encoded by making flow lines asymmetric [following @wood_visualizing_2011]: the straight ends are origins, the curved ends destinations.


The geophraphic positioning of nodes adds context and the encoding of direction provides further detail around, for example, the pattern of commuting into central London boroughs versus more peripheral boroughs (asymmetric flows into Westminster, more symmetric pattern between outer London boroughs like Brent and Enfield). However, there are problems that affect the usefulness of the graphic:

* Flows that start and end at the same location are not shown;
* Longer flows are more visually dominant than are shorter flows;
* The graphic is cluttered with a 'hairball' effect due to multiple overlapping lines;
* Aggregating to the somewhat arbitrary geometric centre of boroughs and drawing lines between these locations implies an undue level of spatial precision.

### Matrix representations

An alternative way to represent these edge frequencies is origin-destination matrices, as in Figure @fig-matrices. The columns are destinations, London boroughs to which residents commute for work; the rows are origins, London boroughs from which residents commute out for work. Edge frequencies are encoded using colour value -- the darker the colour, the larger the number of commutes between those boroughs. Boroughs are ordered left-to-right and top-to-bottom according to the total number of jobs accessed in each borough.

Whilst using colour rather than line width to show flow magnitude is a less effective encoding channel [following @munzner_visualization_2014], there are obvious advantages. The salience bias of longer flows is removed. Ordering cells of the matrix by destination size (number of jobs accessed in each borough) helps to emphasise patterns in the job-rich boroughs, but also encourages *within* and *between* borough comparison. For example, the lack of colour outside of the diagonals in the less job-rich boroughs, which also tend to be in outer London, suggests that labour markets there might be more self-contained: that is, people are less likely to commute-in from outside of those boroughs for work. The layout also supports 'look-up' type tasks -- for example in the top-right plot, where the same OD commutes are removed, we can efficiently identify the boroughs importing the second (WNS) and third (LAM) largest number of workers to Westminster. By applying a local scaling on destination (bottom plot), whereby a separate colour scale is created for each destination borough,  we can explore the theme of *self-containment* more directly. The vertical blue bars for Hammersmith and Kingston suggest that there are comparatively large numbers commuting into- these boroughs for work, especially given their size in terms of available jobs.

### OD maps

The OD matrices expose new structure that could not be so easily inferred from the node-link visualizations. Although their layout is space-efficient, clearly for phenomena such as commuting, *geographic context* is highly relevant. It is possible to make better use of layout and position to support the spatial dimension of analysis. [OD Maps](https://xeno.graphics/od-map/) were proposed by @wood_visualisation_2010 as a means of supporting such an analysis. They take a little to get your head around, but the idea is very elegant.

An OD map contains exactly the same cells as an OD matrix, but the cells are *re-ordered* with an approximate geographic arrangement, as in @fig-reordered-matrix. So, for example, we may be interested in focussing on *destination*, or workplace, boroughs. In the first highlighted example, commutes into Westminster are considered (the left-most column). Cells in the highlighted column are coloured according to the number of workers resident in each borough that travel into Westminster for work. These cells are then *re-ordered* spatially, as in the inset map for Westminster in the figure. The geographic ordering allows us to see that residents access jobs in Westminster in large numbers from many boroughs in London, but especially from Wandsworth, Lambeth and Southwark immediately to the south of Westminster. In the second example, we focus on *origins*: commutes out of Hackney are considered (the middle row). Cells in the highlighted row are coloured according to the number of jobs accessed in each borough by residents travelling out of Hackney for work. Cells are again reordered in the inset map. This demonstrates that patterns of commuting are reasonably localised. The modal destination/workplace borough remains Westminster, but relatively large numbers of jobs are accessed in Camden, Islington, Tower Hamlets and the City of London.



OD maps extend this idea by displaying *all cells* of the OD matrix with a geographic arrangement. This is achieved via a "map-within-map" layout. In the destination-focussed example in Figure \@ref(fig:od-map-layout), each larger (reference) cell identifies destinations and the smaller cells are coloured according to origins -- the number of residents in each borough commuting into the reference cell for work.

The first map uses a *global* colour scaling and the second a *local* colour scaling. Ordering cells geographically helps better appreciate this distinction. As demonstrated in @fig-flows-bor, Westminster contains a large portion of jobs filled by London residents. It makes sense then that, outside of the reference cells (residents living and working in the same borough), the darkest colours corresponding with the largest flow counts are in the map where Westminster is the reference cell. Due to this dominant pattern, however, it is difficult to read too much into the patterns of commuting outside of Westminster. This is where a local scaling is useful. Flow counts are summarised over each reference borough (destination in this case) and normalised according to the *maximum* flow count for that reference borough. Most often this maximum flow count (darkest blue) is  the reference cell -- residents living and working in the same borough. The City of London, which contains many jobs but few residents, is the obvious exception.

The local scaling allows us to characterise the geography of commuting into boroughs in some detail. The two job-rich boroughs -- Westminster and City of London -- clearly draw workers in large proportions across London boroughs and to a lesser extent this is the case for other central/inner boroughs such as Islington (ISL), Camden (CMD), Kingston (KNS). For many outer London boroughs, commuting patterns are very localised -- large numbers of available jobs are filled by workers living in those boroughs or immediately neighbouring boroughs.  Notice that for inner London boroughs south of the river -- Lambeth (LAM), Wandsworth (WNS), Southwark (SWR) --  they tend to draw workers in greater number from neighbouring boroughs that are also south of the river.  



## Techniques


* Use of `gridmappr` for analysing spatial structure in commuting. 