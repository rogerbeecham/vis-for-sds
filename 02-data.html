<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Visualization for Social Data Science - 2&nbsp; Data Fundamentals</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./03-visual.html" rel="next">
<link href="./01-intro.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="site_libs/kePrint-0.0.1/kePrint.js"></script><link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./02-data.html"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Fundamentals</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Visualization for Social Data Science</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/vis4sds/vis4sds/" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="https://twitter.com/intent/tweet?url=%7Curl%7C" rel="" title="Twitter" class="quarto-navigation-tool px-1" aria-label="Twitter"><i class="bi bi-twitter"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-data.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Fundamentals</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-visual.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Visualization Fundamentals</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-explore.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Exploratory Data Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-network.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Networks</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-model.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-uncertainty.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Uncertainty</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-storytelling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Data Storytelling</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">2.1</span> Introduction</a></li>
  <li>
<a href="#concepts" id="toc-concepts" class="nav-link" data-scroll-target="#concepts"><span class="header-section-number">2.2</span> Concepts</a>
  <ul class="collapse">
<li><a href="#data-frames" id="toc-data-frames" class="nav-link" data-scroll-target="#data-frames"><span class="header-section-number">2.2.1</span> Data frames</a></li>
  <li><a href="#types-of-variable" id="toc-types-of-variable" class="nav-link" data-scroll-target="#types-of-variable"><span class="header-section-number">2.2.2</span> Types of variable</a></li>
  <li><a href="#types-of-observation" id="toc-types-of-observation" class="nav-link" data-scroll-target="#types-of-observation"><span class="header-section-number">2.2.3</span> Types of observation</a></li>
  <li><a href="#tidy-data" id="toc-tidy-data" class="nav-link" data-scroll-target="#tidy-data"><span class="header-section-number">2.2.4</span> Tidy data</a></li>
  <li><a href="#tidy" id="toc-tidy" class="nav-link" data-scroll-target="#tidy"><span class="header-section-number">2.2.5</span> Tidy</a></li>
  </ul>
</li>
  <li><a href="#conclusions" id="toc-conclusions" class="nav-link" data-scroll-target="#conclusions"><span class="header-section-number">2.3</span> Conclusions</a></li>
  <li><a href="#further-reading" id="toc-further-reading" class="nav-link" data-scroll-target="#further-reading"><span class="header-section-number">2.4</span> Further Reading</a></li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/vis4sds/vis4sds/edit/master/02-data.qmd" class="toc-action">Edit this page</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="sec-data" class="quarto-section-identifier"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Fundamentals</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><p>By the end of this chapter you should gain the following knowledge and practical skills.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Knowledge outcomes
</div>
</div>
<div class="callout-body-container callout-body">
<ul class="task-list">
<li>
<input type="checkbox">Learn the vocabulary and concepts used to describe data.</li>
<li>
<input type="checkbox">Appreciate the characteristics and importance of tidy data <span class="citation" data-cites="wickham_tidy_2014">(<a href="references.html#ref-wickham_tidy_2014" role="doc-biblioref">Wickham 2014</a>)</span>.</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Skills outcomes
</div>
</div>
<div class="callout-body-container callout-body">
<ul class="task-list">
<li>
<input type="checkbox">Load flat file datasets.</li>
<li>
<input type="checkbox">Calculate descriptive summaries over datasets.</li>
<li>
<input type="checkbox">Apply high-level functions in <code>dplyr</code> and <code>tidyr</code> for working with data.</li>
<li>
<input type="checkbox">Create statistical graphics that expose high-level structure in data for cleaning purposes.</li>
</ul>
</div>
</div>
<section id="introduction" class="level2" data-number="2.1"><h2 data-number="2.1" class="anchored" data-anchor-id="introduction">
<span class="header-section-number">2.1</span> Introduction</h2>
<p>This chapter covers the basics of how to describe and organise data. Whilst this might sound prosaic, there are several reasons why being able to consistently describe a dataset is important. First, it is the initial step in any analysis and helps delimit the analytical procedures that can be deployed. This is especially relevant to modern data analysis, where it is common to apply the same analysis templates for working over many different datasets. Describing data using a consistent vocabulary enables you to identify which analysis templates to reuse. Second relates to the point in <a href="01-intro.html">Chapter&nbsp;<span>1</span></a> that social data science projects usually involve repurposing datasets for the first time. It is often not obvious whether a dataset contains sufficient detail and structure to characterise the behaviours being researched and the target populations it is assumed to represent. This leads to additional levels of uncertainty and places greater importance on the initial steps of data processing, description and exploration.</p>
<p>Through the chapter we will develop vocabulary for describing and thinking about data, as well as some of the most important data processing and organisation techniques in R . We will do so using data from New York’s <a href="https://www.citibikenyc.com/">Citibike</a> scheme.</p>
<!-- accessed through the `bikedata` package, an API to Citibike's [publicly available origin-destination trip data](https://www.citibikenyc.com/system-data). -->
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Data vocabulary
</div>
</div>
<div class="callout-body-container callout-body">
<p>Applying a consistent vocabulary to describing your data is especially useful to learning modern visualization toolkits (<a href="https://ggplot2.tidyverse.org/">ggplot2</a>, <a href="https://www.tableau.com/en-gb">Tableau</a>, <a href="https://vega.github.io/vega-lite/">vega-lite</a>). We will expand upon this in some detail in <a href="03-visual.html">Chapter&nbsp;<span>3</span></a> as we introduce Visualization Fundamentals and the <a href="https://www.springer.com/gp/book/9780387245447">Grammar of Graphics</a> <span class="citation" data-cites="wilkinson_grammar_1999">(<a href="references.html#ref-wilkinson_grammar_1999" role="doc-biblioref">Wilkinson 1999</a>)</span>.</p>
</div>
</div>
</section><section id="concepts" class="level2" data-number="2.2"><h2 data-number="2.2" class="anchored" data-anchor-id="concepts">
<span class="header-section-number">2.2</span> Concepts</h2>
<section id="data-frames" class="level3" data-number="2.2.1"><h3 data-number="2.2.1" class="anchored" data-anchor-id="data-frames">
<span class="header-section-number">2.2.1</span> Data frames</h3>
<p>Throughout this book we will work with data frames. These are spreadsheet-like representations where rows are observations and columns are variables. In an R data frame, variables are vectors that must be of equal length. Where observations have missing values for certain variables the missing values must be substituted with something, usually with <code>NA</code> or similar. This constraint can cause difficulties. For example, when working with variables that contain many values of different length for an observation. In these cases we create a special class of column, a <a href="https://jennybc.github.io/purrr-tutorial/ls13_list-columns.html"><code>list-column</code></a>. Organising data according to this simple structure – rows as observations, columns as variables – is especially useful for applying analysis templates typical of the <code>tidyverse</code> ecosystem.</p>
</section><section id="types-of-variable" class="level3" data-number="2.2.2"><h3 data-number="2.2.2" class="anchored" data-anchor-id="types-of-variable">
<span class="header-section-number">2.2.2</span> Types of variable</h3>
<p>A familiar classification for describing variables is that developed by <span class="citation" data-cites="stevens_on_1946">Stevens (<a href="references.html#ref-stevens_on_1946" role="doc-biblioref">1946</a>)</span> when considering the level of measurement of a variable. <span class="citation" data-cites="stevens_on_1946">Stevens (<a href="references.html#ref-stevens_on_1946" role="doc-biblioref">1946</a>)</span> organises variables into two classes: variables that describe <em>categories</em> of things and variables that describe <em>measurements</em> of things.</p>
<p>Categories include attributes like gender, customer segments, ranked orders (1st, 2nd, 3rd largest etc.). Measurements include quantities like distance, age, travel time. Categories can be further subdivided into those that are unordered (<em>nominal</em>) from those that are ordered (<em>ordinal</em>). Measurements can also be subdivided. <em>Interval</em> measurements are quantities where the computed difference between two values is meaningful. <em>Ratio</em> measurements have this property, but also have a meaningful <code>0</code>, where <code>0</code> means the absence of something, and the ratio of two values can be computed.</p>
<!-- The most common cited example of an interval measurement is temperature in &deg;C. Temperatures can be ordered and compared additively, but 0 in &deg;C does not mean the absence of temperature and 20&deg;C is not twice as hot as 10&deg;C. -->
<p>Why is this useful? The measurement level of a variable determines the types of data analysis operations that can be performed and therefore allows us to make quick decisions when working with a dataset for the first time (<a href="#tbl-variable-types">Table&nbsp;<span>2.1</span></a>).</p>
<div class="cell">
<div class="cell-output-display">
<div id="tbl-variable-types" class="anchored">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<caption>Table&nbsp;2.1: Breakdown of variable types and corresponding mathematical operations.</caption>
<thead><tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">Measurement</th>
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">Example</th>
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">Operators</th>
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">Midpoint</th>
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">Spread</th>
</tr></thead>
<tbody>
<tr class="odd" data-grouplength="2">
<td colspan="5" style="border-bottom: 0px solid">Categories</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em; width: 8em; font-family: Monospace;" data-indentlevel="1">Nominal</td>
<td style="text-align: left;">Political parties; street names</td>
<td style="text-align: left; width: 8em; font-family: Monospace;">= ≠</td>
<td style="text-align: left;">mode</td>
<td style="text-align: left;">entropy</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em; width: 8em; font-family: Monospace;" data-indentlevel="1">Ordinal</td>
<td style="text-align: left;">Terrorism threat levels</td>
<td style="text-align: left; width: 8em; font-family: Monospace;">= ≠ &lt;&gt;</td>
<td style="text-align: left;">median</td>
<td style="text-align: left;">percentile</td>
</tr>
<tr class="even" data-grouplength="2">
<td colspan="5" style="border-bottom: 0px solid">Measures</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em; width: 8em; font-family: Monospace;" data-indentlevel="1">Interval</td>
<td style="text-align: left;">Temperatures; years</td>
<td style="text-align: left; width: 8em; font-family: Monospace;">= ≠ &lt;&gt; + -</td>
<td style="text-align: left;">mean</td>
<td style="text-align: left;">variance</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em; width: 8em; font-family: Monospace;" data-indentlevel="1">Ratio</td>
<td style="text-align: left;">Distances; prices</td>
<td style="text-align: left; width: 8em; font-family: Monospace;">= ≠ &lt;&gt; + - | × ÷</td>
<td style="text-align: left;">mean</td>
<td style="text-align: left;">variance</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>Complete the data description table below identifying the <em>measurement level</em> of each variable in the New York bikeshare stations dataset.</p>
<table class="table">
<thead><tr class="header">
<th>Variable name</th>
<th>Variable value</th>
<th>Measurement level</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>name</code></td>
<td>“Central Park”</td>
<td><enter here=""></enter></td>
</tr>
<tr class="even">
<td><code>capacity</code></td>
<td>80</td>
<td></td>
</tr>
<tr class="odd">
<td><code>rank_capacity</code></td>
<td>45</td>
<td></td>
</tr>
<tr class="even">
<td><code>date_opened</code></td>
<td>“2014-05-23”</td>
<td></td>
</tr>
<tr class="odd">
<td><code>longitude</code></td>
<td>-74.00149746</td>
<td></td>
</tr>
<tr class="even">
<td><code>latitude</code></td>
<td>40.74177603</td>
<td></td>
</tr>
</tbody>
</table>
</div>
</div>
</section><section id="types-of-observation" class="level3" data-number="2.2.3"><h3 data-number="2.2.3" class="anchored" data-anchor-id="types-of-observation">
<span class="header-section-number">2.2.3</span> Types of observation</h3>
<p>Observations either together form an entire population or a sample that we expect is representative of a target population. In social data science applications we often work with datasets that are so-called population-level. The <a href="(https://www.citibikenyc.com/system-data)">Citibike dataset</a> is a complete, population-level dataset in that every journey made through the scheme is recorded. Whether or not this is truly a population-level dataset, however, depends on the analysis purpose. When analysing trips made by Citibike users are we interested only in describing use within Citibike? Or are we taking the patterns observed through our analysis to make claims and inferences about New York cycling more generally? If the latter, then there are problems as the level of detail we have on our sample is pretty trivial compared to traditional, actively-collected datasets, where data collection activities are designed with a target population in mind. It may therefore be difficult to gauge how representative Citibike users and Citibike cycling is of New York’s general cycling population. The flipside is that so-called passively-collected data may not suffer from the same problems such as non-response bias and social-desirability bias as traditional, actively-collected data.</p>
</section><section id="tidy-data" class="level3" data-number="2.2.4"><h3 data-number="2.2.4" class="anchored" data-anchor-id="tidy-data">
<span class="header-section-number">2.2.4</span> Tidy data</h3>
<p>Throughout the book we will work with data frames organised such that columns always and only refer to variables and rows always and only refer to observations. This arrangement, called <em>tidy</em> <span class="citation" data-cites="wickham_tidy_2014">(<a href="references.html#ref-wickham_tidy_2014" role="doc-biblioref">Wickham 2014</a>)</span>, has two key advantages. First, if data are arranged in this tidy form then it is easier to apply and re-use tools for wrangling them due to data having the same underlying structure. Second, placing variables into columns, with each column containing a vector of values, means that we can take advantage of R’s vectorised functions for transforming data. This is demonstrated in the technical element of the chapter.</p>
<p>The three rules for tidy data:</p>
<ol type="1">
<li>Each variable forms a column.</li>
<li>Each observation forms a row.</li>
<li>Each type of observation unit forms a table.</li>
</ol>
<p>The concept of tidy data, and its usefulness for tidyverse-style operations, is best explained through example. The technical element to this chapter is therefore comparatively lengthy and demonstrates key coding templates for organising and re-organising data frames for analysis.</p>

<!-- #### Drug treatment dataset {-}

To elaborate further, we can use the example given in @wickham_tidy_2014, a drug treatment dataset in which two different treatments are administered to participants.


::: {#tbl-drugs .cell layout-ncol="2" tbl-cap='Table 1 of Wickham 2014' tbl-subcap='["One untidy organisation","Alternative untidy organisation","Tidy organisation"]'}
::: {.cell-output-display}
`````{=html}

<table class="lightable-minimal" data-quarto-postprocess="true" style="font-family: &quot;Trebuchet MS&quot;, verdana, sans-serif; margin-left: auto; margin-right: auto;">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">person</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">treatment_a</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">treatment_b</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">John Smith</td>
<td style="text-align: left;">--</td>
<td style="text-align: left;">2</td>
</tr>
<tr class="even">
<td style="text-align: left;">Jane Doe</td>
<td style="text-align: left;">16</td>
<td style="text-align: left;">11</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Mary Johnson</td>
<td style="text-align: left;">3</td>
<td style="text-align: left;">1</td>
</tr>
</tbody>
</table>


<p>:::</p>
<div class="cell-output-display">
<table class="lightable-minimal" data-quarto-postprocess="true" style="font-family: &quot;Trebuchet MS&quot;, verdana, sans-serif; margin-left: auto; margin-right: auto;">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">treatment</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">John Smith</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Jane Doe</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Mary Johnson</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">treatment_a</td>
<td style="text-align: left;">--</td>
<td style="text-align: left;">16</td>
<td style="text-align: left;">3</td>
</tr>
<tr class="even">
<td style="text-align: left;">treatment_b</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">11</td>
<td style="text-align: left;">1</td>
</tr>
</tbody>
</table>


</div>
<div class="cell-output-display">
<table class="lightable-minimal" data-quarto-postprocess="true" style="font-family: &quot;Trebuchet MS&quot;, verdana, sans-serif; margin-left: auto; margin-right: auto;">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">person</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">treatment</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">John Smith</td>
<td style="text-align: left;">a</td>
<td style="text-align: left;">--</td>
</tr>
<tr class="even">
<td style="text-align: left;">John Smith</td>
<td style="text-align: left;">b</td>
<td style="text-align: left;">2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Jane Doe</td>
<td style="text-align: left;">a</td>
<td style="text-align: left;">16</td>
</tr>
<tr class="even">
<td style="text-align: left;">Jane Doe</td>
<td style="text-align: left;">b</td>
<td style="text-align: left;">11</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Mary Johnson</td>
<td style="text-align: left;">a</td>
<td style="text-align: left;">3</td>
</tr>
<tr class="even">
<td style="text-align: left;">Mary Johnson</td>
<td style="text-align: left;">b</td>
<td style="text-align: left;">1</td>
</tr>
</tbody>
</table>


</div>
<p>:::</p>
<p>Both untidy tables present the same information unambiguously – <a href="#tbl-drugs">Table <span class="quarto-unresolved-ref">tbl-drugs</span></a> (b) is simply <a href="#tbl-drugs">Table <span class="quarto-unresolved-ref">tbl-drugs</span></a> (a) transposed. However, neither is <em>tidy</em> as the observations are spread across both the rows and columns. This means that we need to apply different procedures to extract, perform computations on and visually represent, these data.</p>
<p>In the <em>tidy</em> form, each <em>observation</em> is a test result returned for each combination of <code>person</code> and <code>treatment</code>. To get to this formulation, it is necessary to identify the discrete variables:</p>
<ol type="1">
<li><code>person</code>: a categorical nominal variable which takes three values: John Smith, Jane Doe, Mary Johnson.</li>
<li><code>treatment</code>: a categorical nominal variable which takes values: a and b.</li>
<li><code>result</code>: a measurement ratio variable with six recorded values (including the missing value): –, 16, 3, 2, 11,</li>
</ol>
<section id="gapminder-population-dataset" class="level4 unnumbered">
<h4 class="unnumbered">Gapminder population dataset</h4>
<p>In <span class="citation" data-cites="wickham_r_2017">Wickham and Grolemund (<a href="#ref-wickham_r_2017" role="doc-biblioref">2017</a>)</span>, the benefits of tidy layouts are demonstrated using the <a href="https://www.gapminder.org/data/"><code>gapminder</code></a> dataset and with reference to key data processing functions in R. To consolidate our understanding of <em>tidy</em> data let’s quickly look at the <code>gapminder</code> data, as it is an example that we’re probably more likely to encounter in social science research.</p>
<div id="tbl-gapminder" class="cell tbl-parent quarto-layout-panel">
<div class="panel-caption table-caption">
<p>Table 2.2: Excerpts of <a href="https://www.gapminder.org/data/"><code>gapminder</code></a> dataset.</p>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div id="tbl-gapminder-1" class="quarto-layout-cell quarto-layout-cell-subref" data-ref-parent="tbl-gapminder" style="flex-basis: 50.0%;justify-content: center;">
<table class="lightable-minimal" data-quarto-postprocess="true" style="font-family: &quot;Trebuchet MS&quot;, verdana, sans-serif; margin-left: auto; margin-right: auto;">
<caption>(a) Tidy organisation</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">country</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">year</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">cases</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">pop</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Afghanistan</td>
<td style="text-align: left;">1999</td>
<td style="text-align: left;">745</td>
<td style="text-align: left;">19987071</td>
</tr>
<tr class="even">
<td style="text-align: left;">Afghanistan</td>
<td style="text-align: left;">2000</td>
<td style="text-align: left;">2666</td>
<td style="text-align: left;">20595360</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Brazil</td>
<td style="text-align: left;">1999</td>
<td style="text-align: left;">37737</td>
<td style="text-align: left;">172006362</td>
</tr>
<tr class="even">
<td style="text-align: left;">Brazil</td>
<td style="text-align: left;">2000</td>
<td style="text-align: left;">80488</td>
<td style="text-align: left;">174504898</td>
</tr>
<tr class="odd">
<td style="text-align: left;">China</td>
<td style="text-align: left;">1999</td>
<td style="text-align: left;">212258</td>
<td style="text-align: left;">1272915272</td>
</tr>
<tr class="even">
<td style="text-align: left;">China</td>
<td style="text-align: left;">2000</td>
<td style="text-align: left;">213766</td>
<td style="text-align: left;">1280428583</td>
</tr>
</tbody>
</table>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">


</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div id="tbl-gapminder-2" class="quarto-layout-cell quarto-layout-cell-subref" data-ref-parent="tbl-gapminder" style="flex-basis: 50.0%;justify-content: center;">
<table class="lightable-minimal" data-quarto-postprocess="true" style="font-family: &quot;Trebuchet MS&quot;, verdana, sans-serif; margin-left: auto; margin-right: auto;">
<caption>(b) Untidy organisation</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">country</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">year</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">type</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Afghanistan</td>
<td style="text-align: left;">1999</td>
<td style="text-align: left;">cases</td>
<td style="text-align: left;">745</td>
</tr>
<tr class="even">
<td style="text-align: left;">Afghanistan</td>
<td style="text-align: left;">1999</td>
<td style="text-align: left;">pop</td>
<td style="text-align: left;">19987071</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Afghanistan</td>
<td style="text-align: left;">2000</td>
<td style="text-align: left;">cases</td>
<td style="text-align: left;">2666</td>
</tr>
<tr class="even">
<td style="text-align: left;">Afghanistan</td>
<td style="text-align: left;">2000</td>
<td style="text-align: left;">pop</td>
<td style="text-align: left;">20595360</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Brazil</td>
<td style="text-align: left;">1999</td>
<td style="text-align: left;">cases</td>
<td style="text-align: left;">37737</td>
</tr>
<tr class="even">
<td style="text-align: left;">Brazil</td>
<td style="text-align: left;">1999</td>
<td style="text-align: left;">pop</td>
<td style="text-align: left;">174504898</td>
</tr>
<tr class="odd">
<td style="text-align: left;">...</td>
<td style="text-align: left;">...</td>
<td style="text-align: left;">...</td>
<td style="text-align: left;">...</td>
</tr>
</tbody>
</table>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">


</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div id="tbl-gapminder-3" class="quarto-layout-cell quarto-layout-cell-subref" data-ref-parent="tbl-gapminder" style="flex-basis: 50.0%;justify-content: center;">
<table class="lightable-minimal" data-quarto-postprocess="true" style="font-family: &quot;Trebuchet MS&quot;, verdana, sans-serif; margin-left: auto; margin-right: auto;">
<caption>(c) Another untidy organisation</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">country</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">year</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">f_cases</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">m_cases</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">f_pop</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">m_pop</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Afghanistan</td>
<td style="text-align: left;">1999</td>
<td style="text-align: left;">447</td>
<td style="text-align: left;">298</td>
<td style="text-align: left;">9993400</td>
<td style="text-align: left;">9993671</td>
</tr>
<tr class="even">
<td style="text-align: left;">Afghanistan</td>
<td style="text-align: left;">2000</td>
<td style="text-align: left;">1599</td>
<td style="text-align: left;">1067</td>
<td style="text-align: left;">10296280</td>
<td style="text-align: left;">10299080</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Brazil</td>
<td style="text-align: left;">1999</td>
<td style="text-align: left;">16982</td>
<td style="text-align: left;">20755</td>
<td style="text-align: left;">86001181</td>
<td style="text-align: left;">86005181</td>
</tr>
<tr class="even">
<td style="text-align: left;">Brazil</td>
<td style="text-align: left;">2000</td>
<td style="text-align: left;">39440</td>
<td style="text-align: left;">41048</td>
<td style="text-align: left;">87251329</td>
<td style="text-align: left;">87253569</td>
</tr>
<tr class="odd">
<td style="text-align: left;">China</td>
<td style="text-align: left;">1999</td>
<td style="text-align: left;">104007</td>
<td style="text-align: left;">108252</td>
<td style="text-align: left;">636451250</td>
<td style="text-align: left;">636464022</td>
</tr>
<tr class="even">
<td style="text-align: left;">China</td>
<td style="text-align: left;">2000</td>
<td style="text-align: left;">104746</td>
<td style="text-align: left;">109759</td>
<td style="text-align: left;">640212600</td>
<td style="text-align: left;">640215983</td>
</tr>
</tbody>
</table>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">


</div>
</div>
</div>
<p>From the <em>tidy</em> version of the data, we can identify the <em>variables</em> and note that each <em>observation</em> is a recorded count of cases and population for a country in a year.</p>
<ol type="1">
<li><code>country</code>: a categorical nominal variable.</li>
<li><code>year</code>: a date (interval) variable.</li>
<li><code>cases</code>: a ratio (count) variable.</li>
<li><code>population</code>: a ratio (count) variable.</li>
</ol>
<p>An alternative organisation is in <a href="#tbl-gapminder">Table <span class="quarto-unresolved-ref">tbl-gapminder</span></a> (b). This is <em>untidy</em> as the observations are spread across two rows, making operations that we might want to perform on the <code>cases</code> and <code>population</code> variables, for example computing exposure rates, somewhat tedious.</p>
<p>Imagine that the <code>gapminder</code> dataset reported values of <code>cases</code> separately by gender – <a href="#tbl-gapminder">Table <span class="quarto-unresolved-ref">tbl-gapminder</span></a> (c). A type of representation often seen in social science domains, probably as it is helpful for data entry, is where observations are spread across the columns. This too creates problems for performing aggregate functions, but also for specifying visualization designs in <a href="https://ggplot2.tidyverse.org/"><code>ggplot2</code></a>. –&gt;</p>
<pre><code>
## Techniques

The technical element to this chapter imports, describes, transforms and tidies data from New York&#39;s [Citibike](https://www.citibikenyc.com/) bikeshare system.

-   Download the [`02-template.qmd`](./files/02-template.qmd) file and save it to your `vis4sds` project, created in Chapter [-@sec-introduction].
-   Open your `vis4sds` project in RStudio and load the template file by clicking `File` \&gt; `Open File ...` \&gt; `02-template.qmd`.

### Import

In the template file there is documentation on how to setup your R session with key packages -- `tidyverse` , `fst`, `lubridate`, `sf`. The data were collected using the [`bikedata`](https://github.com/ropensci/bikedata) package. A subset of data from New York&#39;s bikeshare scheme, [Citibike](https://www.citibikenyc.com/), were collected for this chapter and can be downloaded from the book&#39;s accompanying [data repository](https://github.com/vis4sds/data)[^02-data-1]. Instructions for doing so are in the [`02-template.qmd`](./files/02-template.qmd) file.

[^02-data-1]: `https://github.com/vis4sds/data`

&lt;!-- -- and also the [`bikedata`](https://github.com/ropensci/bikedata) package for accessing bikeshare data. --&gt;

&lt;!-- Available via the `bikedata` package are trip and occupancy data for a number of bikeshare schemes (as below). We will work with data from New York&#39;s [Citibike](https://www.citibikenyc.com/) scheme for June 2020. A list of all cities covered by the `bikedata` package is below: --&gt;



The code for reading in these data may be familiar to most readers. The [`here`](https://here.r-lib.org/) package, which reliably creates paths relative to a project&#39;s root, is used to pass as a parameter to `read_csv()` and `read_fst()` the locations at which the New York trips and stations data are stored. Notice that we use *assignment* (`&lt;-`), so data are loaded as objects and appear in the Environment pane of your RStudio window.



&lt;!-- Some of the above may be familiar to you. The key arguments to look at are `read_csv()` and `read_fst()`, into which we pass the path to the file. In this case we create a `tmpfile()` within the R session. We then write these data out and save locally to the project&#39;s `data` folder. This is useful as we only want to download the data once. In the `write_*&lt;&gt;` functions we reference this location using the [`here`](https://here.r-lib.org/) package&#39;s `here()` function, useful for reliably creating paths relative to your project&#39;s root.  --&gt;

::: {.cell}

```{.r .cell-code}
# Read in local copies of the trips and stations data.
ny_trips &lt;- read_fst(here(&quot;data&quot;, &quot;ny_trips.fst&quot;))
ny_stations &lt;- read_csv(here(&quot;data&quot;, &quot;ny_stations.csv&quot;))
```
:::

::: callout-note
`fst` is a special class of file that implements in the background various operations to speed-up reading and writing of data. This makes it possible to work with large datasets in-memory in R rather than connecting to a database and returning data summaries/subsets.
:::

&lt;!-- `ny_stations` and `ny_trips` are data frames, spreadsheet type representations containing observations in rows and variables in columns.  --&gt;

Inspecting the layout of the stations data with `View(ny_stations)` you will notice that the top line is the header and contains column (variable) names.

::: {.cell}
::: {.cell-output-display}
![`ny_trips` and `ny_stations` as they appear when calling `View()`.](figs/02/view.png){#fig-view-annotate width=100%}
:::
:::

&lt;!-- ![`ny_trips` and `ny_stations` as they appear when calling `View()`](figs/01/view.png){#fig-view-annotate width=100% fig-align=&quot;center&quot;} --&gt;

The `glimpse()` function can be used to quickly describe a data frame&#39;s dimensions. We have 500,000 trip observations in `ny_trips` and 11 variables; the 500,000 represents a random sample of c.1.9 million trips recorded in June 2020. The function also prints out the object type for each of these variables, with the variables either of type `int`, `chr` or `dbl`.

In this case the assignment needs correcting. `start_time` and `stop_time` may be better represented in `date-time` format; the station identifier variables (e.g. `start_station_id`) are more efficient when converted to `int` types; and the geographic coordinates, currently stored as text strings (`chr`) are better converted as floating points (`dbl`) or [`POINT`](https://r-spatial.github.io/sf/articles/sf1.html#simple-feature-geometry-types) geometry types. In the [02-template.qmd]() file are code chunks for doing these conversions. There are some slightly more involved data transform procedures in this code, which you may wish to ignore at this stage.

::: {.cell}

```{.r .cell-code}
glimpse(ny_trips)
## Rows: 500,000
## Columns: 11
## $ id               &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21…
## $ city             &lt;chr&gt; &quot;ny&quot;, &quot;ny&quot;, &quot;ny&quot;, &quot;ny&quot;, &quot;ny&quot;, &quot;ny&quot;, &quot;ny&quot;, &quot;ny&quot;, &quot;ny&quot;, &quot;ny&quot;, &quot;ny&quot;, &quot;ny&quot;, &quot;…
## $ trip_duration    &lt;dbl&gt; 1062, 3810, 1017, 226, 1437, 355, 99, 1810, 87, 2714, 2096, 1611, 529, 69…
## $ start_time       &lt;chr&gt; &quot;2020-06-01 00:00:03&quot;, &quot;2020-06-01 00:00:03&quot;, &quot;2020-06-01 00:00:09&quot;, &quot;202…
## $ stop_time        &lt;chr&gt; &quot;2020-06-01 00:17:46&quot;, &quot;2020-06-01 01:03:33&quot;, &quot;2020-06-01 00:17:06&quot;, &quot;202…
## $ start_station_id &lt;chr&gt; &quot;ny3419&quot;, &quot;ny366&quot;, &quot;ny389&quot;, &quot;ny3255&quot;, &quot;ny367&quot;, &quot;ny248&quot;, &quot;ny3232&quot;, &quot;ny3263…
## $ end_station_id   &lt;chr&gt; &quot;ny3419&quot;, &quot;ny336&quot;, &quot;ny3562&quot;, &quot;ny505&quot;, &quot;ny497&quot;, &quot;ny247&quot;, &quot;ny390&quot;, &quot;ny496&quot;,…
## $ bike_id          &lt;chr&gt; &quot;39852&quot;, &quot;37558&quot;, &quot;37512&quot;, &quot;39674&quot;, &quot;21093&quot;, &quot;39594&quot;, &quot;43315&quot;, &quot;16571&quot;, &quot;…
## $ user_type        &lt;chr&gt; &quot;Customer&quot;, &quot;Subscriber&quot;, &quot;Customer&quot;, &quot;Customer&quot;, &quot;Customer&quot;, &quot;Subscriber…
## $ birth_year       &lt;chr&gt; &quot;1997&quot;, &quot;1969&quot;, &quot;1988&quot;, &quot;1969&quot;, &quot;1997&quot;, &quot;1990&quot;, &quot;1938&quot;, &quot;1995&quot;, &quot;1971&quot;, &quot;…
## $ gender           &lt;dbl&gt; 2, 0, 2, 0, 2, 1, 2, 2, 2, 1, 1, 0, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
```
:::

::: {.cell}

```{.r .cell-code}
glimpse(ny_stations)
## Rows: 1,010
## Columns: 6
## $ id        &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 2…
## $ city      &lt;chr&gt; &quot;ny&quot;, &quot;ny&quot;, &quot;ny&quot;, &quot;ny&quot;, &quot;ny&quot;, &quot;ny&quot;, &quot;ny&quot;, &quot;ny&quot;, &quot;ny&quot;, &quot;ny&quot;, &quot;ny&quot;, &quot;ny&quot;, &quot;ny&quot;, &quot;n…
## $ stn_id    &lt;chr&gt; &quot;ny116&quot;, &quot;ny119&quot;, &quot;ny120&quot;, &quot;ny127&quot;, &quot;ny128&quot;, &quot;ny143&quot;, &quot;ny144&quot;, &quot;ny146&quot;, &quot;ny150&quot;,…
## $ name      &lt;chr&gt; &quot;W 17 St &amp; 8 Ave&quot;, &quot;Park Ave &amp; St Edwards St&quot;, &quot;Lexington Ave &amp; Classon Ave&quot;, &quot;B…
## $ longitude &lt;chr&gt; &quot;-74.00149746&quot;, &quot;-73.97803415&quot;, &quot;-73.95928168&quot;, &quot;-74.00674436&quot;, &quot;-74.00297088&quot;, …
## $ latitude  &lt;chr&gt; &quot;40.74177603&quot;, &quot;40.69608941&quot;, &quot;40.68676793&quot;, &quot;40.73172428&quot;, &quot;40.72710258&quot;, &quot;40.6…
```
:::

::: {#tbl-data-types .cell tbl-cap=&#39;A breakdown of data types in R.&#39;}

:::

### Transform

#### Transform with `dplyr` and pipes (`|&gt;`) {.unnumbered}

[`dplyr`](https://dplyr.tidyverse.org/) is the foundational package within the tidyverse. It provides a *grammar of data manipulation*, with access to functions that can be variously combined to support most data processing and transformation tasks. Once familiar with `dplyr` functions you will find yourself generating analysis templates to re-use whenever working on a dataset.

All `dplyr` functions operate in a consistent way:

1.  Start with a data frame.
2.  Pass arguments to a function performing some updates to the data frame.
3.  Return the updated data frame.

So every `dplyr` function expects a data frame and will always return a data frame.

::: {#tbl-dplyr-verbs .cell tbl-cap=&#39;dplyr funcitions (verbs) for manipulating data frames.&#39;}
::: {.cell-output-display}
`````{=html}
&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style=&quot;text-align:left;border-bottom: 1px solid;&quot;&gt; function() &lt;/th&gt;
   &lt;th style=&quot;text-align:left;border-bottom: 1px solid;&quot;&gt; Description &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style=&quot;text-align:left;font-family:  Monospace&quot;&gt; filter() &lt;/td&gt;
   &lt;td style=&quot;text-align:left;&quot;&gt; Picks rows (observations) if their values match a specified criteria &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style=&quot;text-align:left;font-family:  Monospace&quot;&gt; arrange() &lt;/td&gt;
   &lt;td style=&quot;text-align:left;&quot;&gt; Reorders rows (observations) based on their values &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style=&quot;text-align:left;font-family:  Monospace&quot;&gt; select() &lt;/td&gt;
   &lt;td style=&quot;text-align:left;&quot;&gt; Picks a subset of columns (variables) by name (or name characteristics) &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style=&quot;text-align:left;font-family:  Monospace&quot;&gt; rename() &lt;/td&gt;
   &lt;td style=&quot;text-align:left;&quot;&gt; Changes the name of columns in the data frame &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style=&quot;text-align:left;font-family:  Monospace&quot;&gt; mutate() &lt;/td&gt;
   &lt;td style=&quot;text-align:left;&quot;&gt; Adds new columns &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style=&quot;text-align:left;font-family:  Monospace&quot;&gt; group_by() &lt;/td&gt;
   &lt;td style=&quot;text-align:left;&quot;&gt; Chunks the dataset into groups for grouped operations &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style=&quot;text-align:left;font-family:  Monospace&quot;&gt; summarise() &lt;/td&gt;
   &lt;td style=&quot;text-align:left;&quot;&gt; Calculates single-row (non-grouped) or multiple-row (if grouped) summary values &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style=&quot;text-align:left;font-family:  Monospace&quot;&gt; ... &lt;/td&gt;
   &lt;td style=&quot;text-align:left;&quot;&gt;  &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
</code></pre>
<p>::: :::</p>
<p><code>dplyr</code> functions are designed to be chained together – you will see this shortly as we explore the New York bikeshare data. This chaining of functions can be achieved using the <em>pipe</em> operator (<code>|&gt;</code>). Pipes are mechanisms for passing information in a program. They take the output of a set of code (a <code>dplyr</code> specification) and make it the input of the next set (another <code>dplyr</code> specification). Pipes can be easily applied to <code>dplyr</code> functions and the functions of all packages that form the <code>tidyverse</code>. We mentioned in <a href="#sec-introduction"><span class="quarto-unresolved-ref">sec-introduction</span></a> that ggplot2 provides a framework for specifying a <em>layered grammar of graphics</em> (more on this in <a href="#sec-visual"><span class="quarto-unresolved-ref">sec-visual</span></a>). Together with the pipe operator, <code>dplyr</code> supports a <em>layered grammar of data manipulation</em>. You will see this throughout the book as we develop and re-use code templates for performing some data manipulation that is then piped to a ggplot2 specification for visual analysis.</p>
</section>
<section id="count-and-summarise-over-rows" class="level4 unnumbered">
<h4 class="unnumbered"><code>count()</code> and <code>summarise()</code> over rows</h4>
<p>Let’s use and combine some <code>dplyr</code> functions to generate statistical summaries of the New York bikeshare data. First we’ll count the number of trips made in June 2020 by <code>user_type</code>, a variable distinguishing casual users from those formally registered to use the scheme (<code>Customer</code> vs. <code>Subscriber</code> cyclists). <code>dplyr</code> has a convenience function for counting, so we could run the code below, also in the <a href="./files/02-template.qmd"><code>02-template.qmd</code></a> for this chapter.</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Take the ny_trips data frame.</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>ny_trips <span class="sc">|&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Run the count function over the data frame</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and set the sort parameter to TRUE.</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(user_type, <span class="at">sort=</span><span class="cn">TRUE</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="do">##    user_type      n</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 Subscriber 347204</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 2   Customer 152796</span></span></code></pre></div>
</div>
<p>There are a few things happening in the <code>count()</code> function. It takes the <code>usr_type</code> variable from <code>ny_trips</code>, organises or <em>groups</em> the rows in the data frame according to its values (<code>Customer</code> | <code>Subscriber</code>), counts the rows and then orders the summarised output descending on the counts.</p>
<p>Often you will want to do more than simply counting and you may also want to be more explicit in the way the data frame is grouped for computation. We’ll demonstrate this with a more involved analysis of the usage data and with some key aggregate functions (<a href="#tbl-aggregate-functions">Table <span class="quarto-unresolved-ref">tbl-aggregate-functions</span></a>). A common workflow is to combine <code>group_by()</code> and <code>summarise()</code>, and in this case <code>arrange()</code> to replicate the <code>count()</code> example.</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Take the ny_trips data frame.</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>ny_trips <span class="sc">|&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Group by user_type.</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(user_type) <span class="sc">|&gt;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Count the number of observations per group.</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">count=</span><span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Arrange the grouped and summarised (collapsed) rows</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># according to count.</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(count))</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 2 × 2</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="do">##   user_type   count</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;chr&gt;       &lt;int&gt;</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 Subscriber 347204</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 Customer   152796</span></span></code></pre></div>
</div>
<p>In <code>ny_trips</code> there is a variable measuring trip duration in seconds (<code>trip_duration</code>). It may be instructive to calculate some summary statistics to see how trip duration varies between these groups. The code below uses <code>group_by()</code>, <code>summarise()</code> and <code>arrange()</code> in exactly the same way, but with the addition of other aggregate functions summarises the <code>trip_duration</code> variable according to central tendency (mean and standard deviation) and by <code>user_type</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Take the ny_trips data frame.</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>ny_trips <span class="sc">|&gt;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">trip_duration=</span>trip_duration<span class="sc">/</span><span class="dv">60</span>) <span class="sc">|&gt;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Group by user type.</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(user_type) <span class="sc">|&gt;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Summarise over the grouped rows,</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># generate a new variable for each type of summary.</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">count=</span><span class="fu">n</span>(),</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_duration=</span><span class="fu">mean</span>(trip_duration),</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">median_duration=</span><span class="fu">median</span>(trip_duration),</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd_duration=</span><span class="fu">sd</span>(trip_duration),</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_duration=</span><span class="fu">min</span>(trip_duration),</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_duration=</span><span class="fu">max</span>(trip_duration)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Arrange on the count variable.</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(count))</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 2 × 7</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="do">##   user_type   count avg_duration median_duration sd_duration min_duration max_dur…¹</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;chr&gt;       &lt;int&gt;        &lt;dbl&gt;           &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 Subscriber 347204         20.3            14.4        116.         1.02    33090.</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 Customer   152796         43.3            23.1        383.         1.02    46982.</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="do">## # … with abbreviated variable name ¹​max_duration</span></span></code></pre></div>
</div>
<p>As each line is commented you hopefully get a sense of what is happening in the code above. You will notice that <code>dplyr</code> functions read like verbs. With the code laid out as above – each <code>dplyr</code> verb occupying a single line, separated by a pipe (<code>|&gt;</code>) – the code can be understood at a glance. Once you are familiar with <code>dplyr</code> it becomes very easy to read, write, re-use and share code in this way.</p>
<div class="cell">
<div class="cell-output-display">
<div id="tbl-aggregate-functions">
<table data-quarto-postprocess="true">
<caption>Table 2.3: A breakdown of aggregate functions commonly used with <code>summarise()</code>.</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">Function</th>
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left; font-family: Monospace;">n()</td>
<td style="text-align: left;">Counts the number of observations</td>
</tr>
<tr class="even">
<td style="text-align: left; font-family: Monospace;">n_distinct(var)</td>
<td style="text-align: left;">Counts the number of unique observations</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-family: Monospace;">sum(var)</td>
<td style="text-align: left;">Sums the values of observations</td>
</tr>
<tr class="even">
<td style="text-align: left; font-family: Monospace;">max(var)|min(var)</td>
<td style="text-align: left;">Finds the min|max values of observations</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-family: Monospace;">mean(var)|median(var)| ...</td>
<td style="text-align: left;">Calculates central tendency of observations</td>
</tr>
<tr class="even">
<td style="text-align: left; font-family: Monospace;">...</td>
<td style="text-align: left;">Many more</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class='callout-icon'></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Remembering that pipes take the output of a set of code and make it the input of the next set, you will notice separate lines for each call to the pipe operator. This is good practice for supporting readability of your code, and for debugging and learning how your data is affected by each line of code. Especially if <code>dplyr</code> is new to you, we recommend you run each line of code separated by a pipe (<code>|&gt;</code>) in the Console and observe how the dataset is changed.</p>
</div>
</div>
</section>
<section id="manipulate-dates-with-lubridate" class="level4 unnumbered">
<h4 class="unnumbered">Manipulate dates with <a href="https://lubridate.tidyverse.org/"><code>lubridate</code></a></h4>
<p>Let’s continue this investigation of trips by user-type by profiling how usage varies over time. To do this we will need to work with <code>date-time</code> variables. The <a href="https://lubridate.tidyverse.org/"><code>lubridate</code></a> package provides various convenience functions for this.</p>
<p>In the code block below we extract the <em>day of week</em> and <em>hour of day</em> from the <code>start_time</code> variable using <code>lubridate</code>’s <a href="https://lubridate.tidyverse.org/reference/day.html">day accessor</a> functions. Documentation on these can be accessed in the usual way (<code>?&lt;function-name&gt;</code>). Next we count the number of trips made by hour of day, day of week and user-type. The summarised data frame will be re-used several times in our analysis, so we store it as an object with a suitable name (<code>ny_temporal</code>) using the assignment operator.</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an hour of day and day of week summary by user type</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># and assign it the name &quot;ny_temporal&quot;.</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>ny_temporal <span class="ot">&lt;-</span> ny_trips <span class="sc">|&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a new column to identify dow.</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">day=</span><span class="fu">wday</span>(start_time, <span class="at">label=</span><span class="cn">TRUE</span>),</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a new column to identify hod.</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">hour=</span><span class="fu">hour</span>(start_time)) <span class="sc">|&gt;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Group by day, hour, user_type.</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(user_type, day, hour) <span class="sc">|&gt;</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Count the grouped rows.</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">count=</span><span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class='callout-icon'></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Whether or not to store derived data frames, like the newly assigned <code>ny_temporal</code>, in a session is not an easy decision. You should avoid cluttering the Environment pane with many data objects. Often when generating charts it is necessary to create these sorts of derived tables as input data to ggplot2. Adding derived data frames to the RStudio Environment pane each time an exploratory plot is created risks an unhelpfully large number of such tables. A general rule: if the derived data frame is to be used more than three times in a data analysis or is computationally intensive, create and assign it (<code>&lt;-</code>) as a named object.</p>
</div>
</div>
<p>In <a href="#fig-plot-temporal">Figure <span class="quarto-unresolved-ref">fig-plot-temporal</span></a> these derived data are plotted. Code for creating this data graphic is in the template file. The plot demonstrates a familiar weekday-weekend pattern of usage. Trip frequencies peak in the morning and evening rush hours during weekdays and mid/late-morning and afternoon during weekends, with the weekday afternoon peak much larger than the morning peak. There are obvious differences in the type of trips made by subscribers versus customers – the temporal signature for subscribers appears to match slightly more closely what one would expect of commuting behaviour.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-plot-temporal" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="figs/02/hod_dow.png" class="img-fluid" style="width:100.0%" /></p>
<figcaption>Figure 2.1: Line charts generated with ggplot2. Plot data computed using <code>dplyr</code> and <code>lubridate</code>.</figcaption>
</figure>
</div>
</div>
</div>
<!-- ![Line charts generated with `ggplot2`. Plot data computed using `dplyr` and `lubridate`](figs/02/hod_dow.svg){#fig-plot-temporal width=100% fig-align="center"} -->
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This analysis is based on data from June 2020, a time when New York residents were emerging from lockdown. It would be instructive to compare with data from a non-Covid year. The fact that bikeshare is collected continuously makes this sort of behavioural change analysis possible.</p>
</div>
</div>
</section><section id="relate-tables-with-join" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="relate-tables-with-join">Relate tables with <code>join()</code>
</h4>
<p>Trip distance is not recorded directly in the <code>ny_trips</code> table, but may be important for profiling usage behaviour. Since <code>ny_stations</code> contains coordinates corresponding to station locations, distances can be calculated by linking these station coordinates to the origin and destination stations recorded in <code>ny_trips</code>. To relate the two tables we need to specify a join between them.</p>
<p>A sensible approach is to:</p>
<ol type="1">
<li>Select all uniquely cycled trip pairs (origin-destination pairs) that appear in the <code>ny_trips</code> table.</li>
<li>Bring in the corresponding coordinate pairs representing the origin and destination stations by joining on the <code>ny_stations</code> table.</li>
<li>Calculate the distance between the coordinate pairs representing the origin and destination.</li>
</ol>
<p>The code below is one way of achieving this.</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Take the ny_trips data frame.</span></span>
<span><span class="va">od_pairs</span> <span class="op">&lt;-</span> <span class="va">ny_trips</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Select trip origin and destination (OD) station columns</span></span>
<span>  <span class="co"># and extract unique OD pairs.</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">start_station_id</span>, <span class="va">end_station_id</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Select lon, lat columns from ny_stations and join on origin column.</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span></span>
<span>    <span class="va">ny_stations</span> <span class="op">|&gt;</span> <span class="fu">select</span><span class="op">(</span><span class="va">stn_id</span>, <span class="va">longitude</span>, <span class="va">latitude</span><span class="op">)</span>,</span>
<span>    by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"start_station_id"</span><span class="op">=</span><span class="st">"stn_id"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Rename new lon, lat columns and associate with origin station.</span></span>
<span>  <span class="fu">rename</span><span class="op">(</span>o_lon<span class="op">=</span><span class="va">longitude</span>, o_lat<span class="op">=</span><span class="va">latitude</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Select lon, lat columns from ny_stations and join on destination column.</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span></span>
<span>    <span class="va">ny_stations</span> <span class="op">|&gt;</span> <span class="fu">select</span><span class="op">(</span><span class="va">stn_id</span>, <span class="va">longitude</span>, <span class="va">latitude</span><span class="op">)</span>,</span>
<span>    by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"end_station_id"</span><span class="op">=</span><span class="st">"stn_id"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Rename new lon, lat columns and associate with destination station.</span></span>
<span>  <span class="fu">rename</span><span class="op">(</span>d_lon<span class="op">=</span><span class="va">longitude</span>, d_lat<span class="op">=</span><span class="va">latitude</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Compute distance calculation on each row (od_pair).</span></span>
<span>  <span class="fu">rowwise</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Calculate distance and express in kms.</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    dist<span class="op">=</span><span class="fu">geosphere</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/geosphere/man/distHaversine.html">distHaversine</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">o_lat</span>, <span class="va">o_lon</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">d_lat</span>, <span class="va">d_lon</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The code block above introduces some new functions: <code>select()</code> to pick or drop variables, <code>rename()</code> to rename variables and a convenience function for calculating straight line distances from polar coordinates, <code>distHaversine()</code>. The key function to emphasise is the <code>left_join()</code>. If you’ve worked with relational databases, <code>dplyr</code>’s join functions will be familiar to you. In a <code>left_join</code>, all the values from the first (left-most) table are retained, <code>ny_trips</code> in this case, and variables from the table on the right , <code>ny_stations</code>, are added. We specify the variable on which tables should be joined with the <code>by=</code> parameter, <code>station_id</code> in this case. If there is a <code>station_id</code> in <code>ny_trips</code> that doesn’t exist in <code>ny_stations</code> then corresponding cells are filled out with <code>NA</code>.</p>
<div class="cell">
<div class="cell-output-display">
<div id="tbl-table-joins" class="anchored">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<caption>Table&nbsp;2.4: A breakdown of <code>dplyr</code> join functions.</caption>
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead><tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: center; border-bottom: hidden; padding-bottom: 0; padding-left: 3px; padding-right: 3px; font-family: Monospace; border-bottom: 1px solid;"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
*_join(x, y) ...
</div></th>
<th data-quarto-table-cell-role="th" style="text-align: left; empty-cells: hide; border-bottom: hidden; font-family: Monospace; border-bottom: 1px solid;"></th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left; width: 10em; font-family: Monospace;">left_join()</td>
<td style="text-align: left;">all rows from table x</td>
</tr>
<tr class="even">
<td style="text-align: left; width: 10em; font-family: Monospace;">right_join()</td>
<td style="text-align: left;">all rows from table y</td>
</tr>
<tr class="odd">
<td style="text-align: left; width: 10em; font-family: Monospace;">full_join()</td>
<td style="text-align: left;">all rows from both table x and y</td>
</tr>
<tr class="even">
<td style="text-align: left; width: 10em; font-family: Monospace;">`semi_join()`</td>
<td style="text-align: left;">all rows from table x where there are matching values in table y, keeping just columns from table x</td>
</tr>
<tr class="odd">
<td style="text-align: left; width: 10em; font-family: Monospace;">inner_join()</td>
<td style="text-align: left;">all rows from table x where there are matching values in table y, returning all combinations where there are multiple matches</td>
</tr>
<tr class="even">
<td style="text-align: left; width: 10em; font-family: Monospace;">anti_join</td>
<td style="text-align: left;">all rows from table x where there are not matching values in table y, never duplicating rows of table x</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
<!-- ![Histograms generated with ggplot2. Plot data computed using `dplyr` and `lubridate`](figs/02/dist.svg){#fig-plot-dist width=100% fig-align="center"} -->
<p>From the newly created distance variable, we can calculate the average (mean) trip distance for the 500,000 sampled trips – 1.6km. This might seem very short, but remember that these are straight-line distances between pairs of docking stations. Ideally we would calculate distances derived from cycle trajectories. A separate reason, discovered when generating a histogram on the <code>dist</code> variable, is that there are a large number of trips that start and end at the same docking station. Initially these might seem to be unsuccessful hires – people failing to undock a bike for example. We could investigate this further by paying attention to the docking stations at which same origin-destination trips occur, as in the code block below.</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ny_trips</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">start_station_id</span><span class="op">==</span><span class="va">end_station_id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">start_station_id</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="fu">summarise</span><span class="op">(</span>count<span class="op">=</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span></span>
<span>    <span class="va">ny_stations</span> <span class="op">|&gt;</span>   <span class="fu">select</span><span class="op">(</span><span class="va">stn_id</span>, <span class="va">name</span><span class="op">)</span>,</span>
<span>    by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"start_station_id"</span><span class="op">=</span><span class="st">"stn_id"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 958 x 3</span></span>
<span><span class="co">##    start_station_id count name</span></span>
<span><span class="co">##    &lt;chr&gt;            &lt;int&gt; &lt;chr&gt;</span></span>
<span><span class="co">##  1 ny3423            2017 West Drive &amp; Prospect Park West</span></span>
<span><span class="co">##  2 ny3881            1263 12 Ave &amp; W 125 St</span></span>
<span><span class="co">##  3 ny514             1024 12 Ave &amp; W 40 St</span></span>
<span><span class="co">##  4 ny3349             978 Grand Army Plaza &amp; Plaza St West</span></span>
<span><span class="co">##  5 ny3992             964 W 169 St &amp; Fort Washington Ave</span></span>
<span><span class="co">##  6 ny3374             860 Central Park North &amp; Adam Clayton Powell Blvd</span></span>
<span><span class="co">##  7 ny3782             837 Brooklyn Bridge Park - Pier 2</span></span>
<span><span class="co">##  8 ny3599             829 Franklin Ave &amp; Empire Blvd</span></span>
<span><span class="co">##  9 ny3521             793 Lenox Ave &amp; W 111 St</span></span>
<span><span class="co">## 10 ny2006             782 Central Park S &amp; 6 Ave</span></span>
<span><span class="co">## # … with 948 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The top 10 docking stations are either in parks, near parks or located along the river. This, coupled with the fact that same origin-destination trips occur in much greater relative number for casual users, associated with discretionary leisure-oriented cycling, than regular users (customers vs subscribers) is further evidence that these are valid trips. Note also the different shapes in the distribution of distances for trips cycled by subscribers and customers (<a href="#fig-plot-dist">Figure&nbsp;<span>2.2</span></a>), again suggesting these groups may use Citibike in different ways.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-plot-dist" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/02/dist.png" class="img-fluid figure-img" style="width:95.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;2.2: Citibike trip distances (straight-line km) for Subscriber and Customer cyclists.</figcaption></figure>
</div>
</div>
</div>
</section><section id="write-functions-of-your-own" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="write-functions-of-your-own">Write functions of your own</h4>
<p>There may be times where you need to create functions of your own. Most often this is when you find yourself copy-pasting the same chunks of code with minimal adaptation.</p>
<p>Functions have three key characteristics:</p>
<ol type="1">
<li>They are (usually) named – the name should be expressive and communicate what the function does.</li>
<li>They have brackets <code>&lt;function-name()&gt;</code> usually containing arguments – inputs, which determine what the function does and returns.</li>
<li>Immediately followed by <code>&lt;function-name()&gt;</code> are curly bracket (<code><a href="https://rdrr.io/r/base/Paren.html">{}</a></code>) used to contain the body – code that performs a distinct task, described by the function’s name.</li>
</ol>
<p>Effective functions are short, perform single, discrete operations and are intuitive.</p>
<p>You will recall that in the <code>ny_trips</code> table there is a variable called <code>birth_year</code>. From this we can derive cyclists’ approximate age in years. Below is a function called <code>get_age()</code>. The function expects two arguments: <code>yob</code> – a year of birth as type <code>chr</code>; and <code>yref</code> – a reference year. In the body, <code>lubridate</code>’s <code><a href="https://lubridate.tidyverse.org/reference/as.period.html">as.period()</a></code> function is used to calculate the time in years that elapsed between these dates.</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># get_age() depends on lubridate.</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org">lubridate</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate time elapsed between two dates in years (age).</span></span>
<span><span class="co"># yob : datetime object recording birth year.</span></span>
<span><span class="co"># yref : datetime object recording reference year.</span></span>
<span><span class="va">get_age</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">yob</span>, <span class="va">yref</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">period</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/as.period.html">as.period</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html">interval</a></span><span class="op">(</span><span class="va">yob</span>, <span class="va">yref</span><span class="op">)</span>,unit <span class="op">=</span> <span class="st">"year"</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">period</span><span class="op">$</span><span class="va">year</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">ny_trips</span> <span class="op">&lt;-</span> <span class="va">ny_trips</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Calculate age from birth_date.</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    age<span class="op">=</span><span class="fu">get_age</span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="va">birth_year</span>, format<span class="op">=</span><span class="st">"%Y"</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"2020"</span>, format<span class="op">=</span><span class="st">"%Y"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can use the two new derived variables – distance travelled and age – in our analysis. In <a href="#fig-plot-speeds">Figure&nbsp;<span>2.3</span></a>, we explore how approximate travel speeds vary by age, trip distance and customer type. The code to generate the summary data and plot is in the template file. Again the average speed calculation should be treated cautiously as it is based on straight line distances and it is likely that this will vary depending on whether the trip is made for ‘utilitarian’ or ‘leisure’ purposes. Additionally, due to the heavy subsetting data become a little volatile for certain age groups and so the age variable is aggregated into 5-year bands.</p>
<p>There are some notable patterns in <a href="#fig-plot-speeds">Figure&nbsp;<span>2.3</span></a>. Subscribers make faster trips than do customers, although this gap narrows as trip distance increases. Trips with a straight-line distance of 4.5km are non-trivial and so may be classed as utilitarian even for non-regular customers. There is a very slight effect of decreasing trip speed by age cycled for the longer trips. The volatility in the older age groups for trips &gt;4.5km suggests more data and a more involved analysis is required to confidently establish this. For example, it may be that the comparatively rare occurrence of trips in the 65-70 age group is made by only a small subset of cyclists; with a larger dataset we may expect a regression to the mean effect that negates noise caused by outlier individuals.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-plot-speeds" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/02/speeds.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;2.3: Citibike average trip speeds (approximate) by age, customer type and straight-line trip distance.</figcaption></figure>
</div>
</div>
</div>
</section></section><section id="tidy" class="level3" data-number="2.2.5"><h3 data-number="2.2.5" class="anchored" data-anchor-id="tidy">
<span class="header-section-number">2.2.5</span> Tidy</h3>

<!-- The `ny_trips` and `ny_stations` data already comply with the rules for *tidy* data [@wickham_tidy_2014]. Each row in `ny_trips` is a distinct trip and each row in `ny_stations` a distinct station. However, it is common to encounter datasets that need to be reshaped. There are two key functions to learn here: [`pivot_longer()`](https://tidyr.tidyverse.org/reference/pivot_longer.html) and [`pivot_wider()`](https://tidyr.tidyverse.org/reference/pivot_wider.html). `pivot_longer()` is used to tidy data in which observations are spread across columns, as in @tbl-gapminder (b) (the `gapminder` dataset). `pivot_wider()` is used to tidy data in which variables are spread across rows, as in @tbl-gapminder (c). You will find yourself using these functions not only for fixing messy data, but for flexibly reshaping data for use in `ggplot2` specifications (more on this in Chapter [-@sec-visual] and [-@sec-exploratory]) or joining tables. -->
<p>The <code>ny_trips</code> and <code>ny_stations</code> data already comply with the rules for tidy data <span class="citation" data-cites="wickham_tidy_2014">(<a href="references.html#ref-wickham_tidy_2014" role="doc-biblioref">Wickham 2014</a>)</span>. Each row in <code>ny_trips</code> is a distinct trip and each row in <code>ny_stations</code> a distinct station. However, it is common to encounter datasets that are untidy and must be reshaped. In the book’s data repository are two examples: <code>ny_spread_rows</code> and <code>ny_spread_columns</code>. <code>ny_spread_rows</code> is so-called because the variable <code>summary_type</code> is spread across the rows (observations); <code>ny_spread_columns</code> because multiple variables are stored in single columns – the <code>dist_weekday</code>, <code>duration_weekday</code> columns.</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ny_spread_rows</span></span>
<span><span class="co">## # A tibble: 411,032 × 6</span></span>
<span><span class="co">##    o_station d_station wkday   count summary_type  value</span></span>
<span><span class="co">##        &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;chr&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">##  1        72       116 weekend     1 dist           1.15</span></span>
<span><span class="co">##  2        72       116 weekend     1 duration      18.2</span></span>
<span><span class="co">##  3        72       127 weekend     4 dist           7.18</span></span>
<span><span class="co">##  4        72       127 weekend     4 duration     122.</span></span>
<span><span class="co">##  5        72       146 weekend     4 dist           9.21</span></span>
<span><span class="co">##  6        72       146 weekend     4 duration     122.</span></span>
<span><span class="co">##  7        72       164 weekend     1 dist           2.66</span></span>
<span><span class="co">##  8        72       164 weekend     1 duration      12.5</span></span>
<span><span class="co">##  9        72       173 weekend     2 dist           2.13</span></span>
<span><span class="co">## 10        72       173 weekend     2 duration      43.6</span></span>
<span><span class="co">## # … with 411,022 more rows</span></span>
<span></span>
<span><span class="va">ny_spread_columns</span></span>
<span><span class="co">## # A tibble: 156,449 × 8</span></span>
<span><span class="co">##    o_station d_station count_weekend count_weekday dist_w…¹ dist_…² durat…³ durat…⁴</span></span>
<span><span class="co">##        &lt;dbl&gt;     &lt;dbl&gt;         &lt;dbl&gt;         &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">##  1        72       116             1             3     1.15    3.45    18.2    49.9</span></span>
<span><span class="co">##  2        72       127             4             4     7.18    7.18   122.    101.</span></span>
<span><span class="co">##  3        72       146             4             2     9.21    4.61   122.     64.1</span></span>
<span><span class="co">##  4        72       164             1             1     2.66    2.66    12.5    43.2</span></span>
<span><span class="co">##  5        72       173             2            13     2.13   13.9     43.6   189.</span></span>
<span><span class="co">##  6        72       195             1             4     2.56   10.2     24.7    98.3</span></span>
<span><span class="co">##  7        72       212             3             3     4.83    4.83    40.3    54.0</span></span>
<span><span class="co">##  8        72       223             1            NA     1.13   NA       21.1    NA</span></span>
<span><span class="co">##  9        72       228             2             1     4.97    2.49    30.2    13.6</span></span>
<span><span class="co">## 10        72       229             1            NA     1.22   NA       39.2    NA</span></span>
<span><span class="co">## # … with 156,439 more rows, and abbreviated variable names ¹​dist_weekend,</span></span>
<span><span class="co">## #   ²​dist_weekday, ³​duration_weekend, ⁴​duration_weekday</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To re-organise the table in tidy form, we should identify what constitutes a distinct observation – an origin-destination pair summarising counts, distances and durations of trips that occur during the weekday or weekend. From here, the table’s variables are:</p>
<ul>
<li>
<code>o_station</code>: station id of the origin station</li>
<li>
<code>d_station</code>: station id of the destination station</li>
<li>
<code>wkday</code>: trip occurs on weekday or weekend</li>
<li>
<code>count</code>: count of trips for observation type</li>
<li>
<code>dist</code>: total straight-line distance in km (cumulative) of trips for observation type</li>
<li>
<code>duration</code>: total duration in minutes (cumulative) of trips for observation type</li>
</ul>
<p>There are two functions for reshaping untidy data, from the <a href="https://tidyr.tidyverse.org/"><code>tidyr</code></a> package: <a href="https://tidyr.tidyverse.org/reference/pivot_longer.html"><code>pivot_longer()</code></a> and <a href="https://tidyr.tidyverse.org/reference/pivot_wider.html"><code>pivot_wider()</code></a>. <code>pivot_longer()</code> is used to tidy data in which observations are spread across columns; <code>pivot_wider()</code> to tidy data in which variables are spread across rows. The functions are especially useful in visual data analysis to fix messy data, but also to flexibly reshape data supplied to ggplot2 specifications (more on this in Chapters <a href="03-visual.html"><span>3</span></a> and <a href="04-explore.html"><span>4</span></a>).</p>
<p>To fix <code>ny_spread_rows</code>, we use <code>pivot_wider()</code> and pass to the function’s arguments the name of the problematic column and the column containing values used to populate the newly created columns.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ny_spread_rows</span> <span class="op">|&gt;</span></span>
<span>   <span class="fu">pivot_wider</span><span class="op">(</span>names_from<span class="op">=</span><span class="va">summary_type</span>, values_from<span class="op">=</span><span class="va">value</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## # A tibble: 205,516 × 6</span></span>
<span><span class="co">##    o_station d_station wkday   count  dist duration</span></span>
<span><span class="co">##        &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">##  1        72       116 weekend     1  1.15     18.2</span></span>
<span><span class="co">##  2        72       127 weekend     4  7.18    122.</span></span>
<span><span class="co">##  3        72       146 weekend     4  9.21    122.</span></span>
<span><span class="co">##  4        72       164 weekend     1  2.66     12.5</span></span>
<span><span class="co">##  5        72       173 weekend     2  2.13     43.6</span></span>
<span><span class="co">##  6        72       195 weekend     1  2.56     24.7</span></span>
<span><span class="co">##  7        72       212 weekend     3  4.83     40.3</span></span>
<span><span class="co">##  8        72       223 weekend     1  1.13     21.1</span></span>
<span><span class="co">##  9        72       228 weekend     2  4.97     30.2</span></span>
<span><span class="co">## 10        72       229 weekend     1  1.22     39.2</span></span>
<span><span class="co">## # … with 205,506 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To fix <code>ny_spread_columns</code> requires a little more thought. First we <code>pivot_longer()</code> on columns that are muddled with multiple variables. This results in a long and thin dataset similar to <code>ny_spread_rows</code> – each row is the origin-destination pair with either a count, distance or duration recorded for trips occurring at weekdays or weekdays. The muddled variables, for example <code>dist_weekend</code> <code>duration_weekday</code>, now appear in the rows of a new column with the default title <code>name</code>. This column is separated on the <code>_</code> mark to create two new columns, <code>summary_type</code> and <code>wkday</code>, used in <code>pivot_wider()</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ny_spread_columns</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span>cols <span class="op">=</span> <span class="va">count_weekend</span><span class="op">:</span><span class="va">duration_weekday</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">separate</span><span class="op">(</span>col <span class="op">=</span> <span class="va">name</span>, into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"summary_type"</span>, <span class="st">"wkday"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">summary_type</span>, values_from <span class="op">=</span> <span class="va">value</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## # A tibble: 312,898 × 6</span></span>
<span><span class="co">##    o_station d_station wkday   count  dist duration</span></span>
<span><span class="co">##        &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">##  1        72       116 weekend     1  1.15     18.2</span></span>
<span><span class="co">##  2        72       116 weekday     3  3.45     49.9</span></span>
<span><span class="co">##  3        72       127 weekend     4  7.18    122.</span></span>
<span><span class="co">##  4        72       127 weekday     4  7.18    101.</span></span>
<span><span class="co">##  5        72       146 weekend     4  9.21    122.</span></span>
<span><span class="co">##  6        72       146 weekday     2  4.61     64.1</span></span>
<span><span class="co">##  7        72       164 weekend     1  2.66     12.5</span></span>
<span><span class="co">##  8        72       164 weekday     1  2.66     43.2</span></span>
<span><span class="co">##  9        72       173 weekend     2  2.13     43.6</span></span>
<span><span class="co">## 10        72       173 weekday    13 13.9     189.</span></span>
<span><span class="co">## # … with 312,888 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<!-- In the *task* you will be tidying some messy derived tables based on the bikeshare data using both of these functions, but we can demonstrate their purpose in *tidying* the messy `gapminder` data in @tbl-gapminder. Remember that these data were messy as the observations by gender were spread across the columns:

::: {.cell}

```{.r .cell-code}
untidy_wide
##   country     year  f_cases m_cases f_population m_population
##   <chr>       <chr> <chr>   <chr>   <chr>        <chr>
## 1 Afghanistan 1999  447     298     9993400      9993671
## 2 Afghanistan 2000  1599    1067    10296280     10299080
## 3 Brazil      1999  16982   20755   86001181     86005181
## 4 Brazil      2000  39440   41048   87251329     87253569
## 5 China       1999  104007  108252  636451250    636464022
## 6 China       2000  104746  109759  640212600    640215983
```
:::

First we need to gather the problematic columns with `pivot_longer()`.

::: {.cell}

```{.r .cell-code}
untidy_wide |>
  pivot_longer(
    cols=c(f_cases: m_population),
    names_to=c("gender_count_type"),
    values_to=c("counts")
  )

##   country     year  gender_count_type       counts
##   <chr>       <chr> <chr>                   <chr>
##  1 Afghanistan 1999  f_cases                447
##  2 Afghanistan 1999  m_cases                298
##  3 Afghanistan 1999  f_population           9993400
##  4 Afghanistan 1999  m_population           9993671
##  5 Afghanistan 2000  f_cases                1599
##  6 Afghanistan 2000  m_cases                1067
##  7 Afghanistan 2000  f_population           10296280
##  8 Afghanistan 2000  m_population           10299080
##  9 Brazil      1999  f_cases                16982
## 10 Brazil      1999  m_cases                20755
## # … with 14 more rows
```
:::
So this has usefully collapsed the dataset by gender, we now have a problem similar to that in @tbl-gapminder (b) where observations are spread across the rows -- in this instance `cases` and `population` are better treated as separate variables. This can be fixed by `separating` the `gender_count_type` variables and then spreading the values of the new `count_type` (`cases`, `population`) across the columns. Hopefully you can see how this gets us to the *tidy* `gapminder` data structure in @tbl-gapminder (a).

::: {.cell}

```{.r .cell-code}
untidy_wide |>
  pivot_longer(
    cols=c(f_cases: m_population),
    names_to=c("gender_count_type"),
    values_to=c("counts")
  ) |>
  separate(
    col=gender_count_type,
    into=c("gender", "count_type"),
    sep="_"
  )

##    country     year  gender count_type counts
##    <chr>       <chr> <chr>  <chr>      <chr>
##  1 Afghanistan 1999  f      cases      447
##  2 Afghanistan 1999  m      cases      298
##  3 Afghanistan 1999  f      population 9993400
##  4 Afghanistan 1999  m      population 9993671
##  5 Afghanistan 2000  f      cases      1599
##  6 Afghanistan 2000  m      cases      1067
##  7 Afghanistan 2000  f      population 10296280
##  8 Afghanistan 2000  m      population 10299080
##  9 Brazil      1999  f      cases      16982
## 10 Brazil      1999  m      cases      20755
## # … with 14 more rows

untidy_wide |>
  pivot_longer(
    cols=c(f_cases: m_population),
    names_to=c("gender_count_type"),
    values_to=c("counts")
  ) |>
  separate(
    col=gender_count_type,
    into=c("gender", "count_type"),
    sep="_"
  ) |>
  pivot_wider(names_from=count_type, values_from=counts)

##    country     year  gender cases  population
##    <chr>       <chr> <chr>  <chr>  <chr>
##  1 Afghanistan 1999  f      447    9993400
##  2 Afghanistan 1999  m      298    9993671
##  3 Afghanistan 2000  f      1599   10296280
##  4 Afghanistan 2000  m      1067   10299080
##  5 Brazil      1999  f      16982  86001181
##  6 Brazil      1999  m      20755  86005181
##  7 Brazil      2000  f      39440  87251329
##  8 Brazil      2000  m      41048  87253569
##  9 China       1999  f      104007 636451250
## 10 China       1999  m      108252 636464022
## 11 China       2000  f      104746 640212600
## 12 China       2000  m      109759 640215983
```
:::
-->
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p><a href="#fig-plot-temporal">Figure&nbsp;<span>2.1</span></a> uses a derived dataset that summarises trip counts by <code>user_type</code> and <code>day_of_week</code>. This dataset is created in the template file for the chapter and is named <code>ny_temporal</code>. Each observation is a trip count on a day of week, hour of day and for a given user type (<code>Customer</code> or <code>Subscriber</code>).</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ny_temporal</span> <span class="op">&lt;-</span> <span class="va">ny_trips</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    day<span class="op">=</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html">wday</a></span><span class="op">(</span><span class="va">start_time</span>, label<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    hour<span class="op">=</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/hour.html">hour</a></span><span class="op">(</span><span class="va">start_time</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">user_type</span>, <span class="va">day</span>, <span class="va">hour</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span>count<span class="op">=</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To explore whether customers and subscribers have different usage behaviours, it is instructive to calculate the proportion of trips made by day of week for these two user groups. An example derived dataset is below. Customers, as expected, contribute a greater relative number of trips on weekends than do subscribers.</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># # A tibble: 7 × 3</span></span>
<span><span class="co">#   day   Customer Subscriber</span></span>
<span><span class="co">#   &lt;ord&gt;    &lt;dbl&gt;      &lt;dbl&gt;</span></span>
<span><span class="co"># 1 Sun     0.198       0.144</span></span>
<span><span class="co"># 2 Mon     0.137       0.163</span></span>
<span><span class="co"># 3 Tue     0.144       0.172</span></span>
<span><span class="co"># 4 Wed     0.104       0.125</span></span>
<span><span class="co"># 5 Thu     0.0973      0.122</span></span>
<span><span class="co"># 6 Fri     0.135       0.138</span></span>
<span><span class="co"># 7 Sat     0.185       0.136</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Can you create write some <code>dplyr</code> code to generate such a summary? There are several possible approaches, but you will need to think about which variables to <code>group_by()</code> and <code>summarise()</code> over, and you may need to <code>pivot_wider()</code> your dataset in order to compare the user types side-by-side.</p>
</div>
</div>
</section><section id="conclusions" class="level2" data-number="2.3"><h2 data-number="2.3" class="anchored" data-anchor-id="conclusions">
<span class="header-section-number">2.3</span> Conclusions</h2>
<p>Developing the vocabulary and technical skills to systematically describe and organise data is crucial to modern data analysis. This chapter has covered the fundamentals: that data consist of <em>observations</em> and <em>variables</em> of different types <span class="citation" data-cites="stevens_on_1946">(<a href="references.html#ref-stevens_on_1946" role="doc-biblioref">Stevens 1946</a>)</span> and that in order to work effectively with datasets, these data should be organised such that they are <em>tidy</em> <span class="citation" data-cites="wickham_tidy_2014">(<a href="references.html#ref-wickham_tidy_2014" role="doc-biblioref">Wickham 2014</a>)</span>. Most of the content was dedicated to the techniques that enable these concepts to be operationalised. We covered how to download, transform and reshape a reasonably large dataset from New York’s Citibike scheme. In doing so, we generated insights that might inform further data collection and analysis activity. In the next chapter we will extend this conceptual and technical knowledge as we introduce the fundamentals of visual data analysis and ggplot2’s <em>grammar of graphics</em>.</p>
</section><section id="further-reading" class="level2" data-number="2.4"><h2 data-number="2.4" class="anchored" data-anchor-id="further-reading">
<span class="header-section-number">2.4</span> Further Reading</h2>
<p>There are many accessible introductions to the <code>tidyverse</code> for modern data analysis. Two excellent resources:</p>
<ul>
<li>Wickham, H., Çetinkaya-Rundel, M., Grolemund, G. 2023, “R for Data Science, 2nd Edition”, <em>O’rielly</em>.
<ul>
<li>Chapter 4.</li>
</ul>
</li>
<li>Ismay, C. and Kim, A. 2020. “Statistical Inference via Data Science: A ModernDive into r and the Tidyverse” <em>CRC Press</em>. doi: <a href="https://doi.org/10.1201/9780367409913">10.1201/9780367409913</a>.
<ul>
<li>Chapters 3, 4.</li>
</ul>
</li>
</ul>
<p>Hadley Wickham’s original paper on Tidy Data:</p>
<ul>
<li>Wickham, H. 2010. “Tidy Data” <em>Journal of Statistical Software</em>, 59(10): 1–23. doi: <a href="https://doi.org/10.18637/jss.v059.i10">10.18637/jss.v059.i10</a>.</li>
</ul>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./01-intro.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./03-visual.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Visualization Fundamentals</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>