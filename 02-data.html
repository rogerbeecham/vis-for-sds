<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.56">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Visualization for Social Data Science - 2&nbsp; Data Fundamentals</title>
<style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
<script src="site_libs/quarto-nav/quarto-nav.js"></script><script src="site_libs/quarto-nav/headroom.min.js"></script><script src="site_libs/clipboard/clipboard.min.js"></script><meta name="quarto:offset" content="./">
<script src="site_libs/quarto-search/autocomplete.umd.js"></script><script src="site_libs/quarto-search/fuse.min.js"></script><script src="site_libs/quarto-search/quarto-search.js"></script><link href="./03-visual.html" rel="next">
<link href="./01-intro.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script><script src="site_libs/quarto-html/popper.min.js"></script><script src="site_libs/quarto-html/tippy.umd.min.js"></script><script src="site_libs/quarto-html/anchor.min.js"></script><link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet">
<script src="site_libs/bootstrap/bootstrap.min.js"></script><link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
    "location": "sidebar",
    "copy-button": false,
    "collapse-after": 2,
    "panel-placement": "start",
    "type": "textbox",
    "limit": 20,
    "language": {
      "search-no-results-text": "No results",
      "search-matching-documents-text": "matching documents",
      "search-copy-link-title": "Copy link to search",
      "search-hide-matches-text": "Hide additional matches",
      "search-more-match-text": "more match in this document",
      "search-more-matches-text": "more matches in this document",
      "search-clear-button-title": "Clear",
      "search-detached-cancel-button-title": "Cancel",
      "search-submit-button-title": "Submit"
    }
  }</script><script src="site_libs/kePrint-0.0.1/kePrint.js"></script><link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body class="floating">
<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }"><div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Fundamentals</span></h1>
      <button type="button" class="quarto-btn-toggle btn">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Visualization for Social Data Science</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/rogerbeecham/vis4gds/" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="https://twitter.com/intent/tweet?url=%7Curl%7C" title="Twitter" class="sidebar-tool px-1"><i class="bi bi-twitter"></i></a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Welcome</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preface.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-intro.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-data.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Fundamentals</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-visual.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Visualization Fundamentals</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-explore.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Exploratory Data Analysis</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-network.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Networks</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-model.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-uncertainty.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Uncertainty</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-storytelling.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Data Storytelling</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-appendices" aria-expanded="true">Appendices</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-appendices" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-appendices" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./a1-data.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Data Fundamentals</span></a>
  </div>
</li>
    </ul>
</li>
    </ul>
</div>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc"><h2 id="toc-title">Table of contents</h2>
<ul>
<li><a href="#introduction" class="nav-link active" data-scroll-target="#introduction"> <span class="header-section-number">2.1</span> Introduction</a></li>
<li>
<a href="#concepts" class="nav-link" data-scroll-target="#concepts"> <span class="header-section-number">2.2</span> Concepts</a>
<ul class="collapse">
<li><a href="#data-structure" class="nav-link" data-scroll-target="#data-structure"> <span class="header-section-number">2.2.1</span> Data structure</a></li>
<li><a href="#types-of-variable" class="nav-link" data-scroll-target="#types-of-variable"> <span class="header-section-number">2.2.2</span> Types of variable</a></li>
<li><a href="#types-of-observation" class="nav-link" data-scroll-target="#types-of-observation"> <span class="header-section-number">2.2.3</span> Types of observation</a></li>
<li><a href="#tidy-data" class="nav-link" data-scroll-target="#tidy-data"> <span class="header-section-number">2.2.4</span> Tidy data</a></li>
</ul>
</li>
<li>
<a href="#techniques" class="nav-link" data-scroll-target="#techniques"> <span class="header-section-number">2.3</span> Techniques</a>
<ul class="collapse">
<li><a href="#import" class="nav-link" data-scroll-target="#import"> <span class="header-section-number">2.3.1</span> Import</a></li>
<li><a href="#describe" class="nav-link" data-scroll-target="#describe"> <span class="header-section-number">2.3.2</span> Describe</a></li>
<li><a href="#transform" class="nav-link" data-scroll-target="#transform"> <span class="header-section-number">2.3.3</span> Transform</a></li>
<li><a href="#tidy" class="nav-link" data-scroll-target="#tidy"> <span class="header-section-number">2.3.4</span> Tidy</a></li>
</ul>
</li>
<li><a href="#conclusions" class="nav-link" data-scroll-target="#conclusions"> <span class="header-section-number">2.4</span> Conclusions</a></li>
</ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/rogerbeecham/vis4gds/edit/master/02-data.qmd" class="toc-action">Edit this page</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header"><h1 class="title display-7"><span id="sec-data" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Fundamentals</span></span></h1>
</header><div class="cell">

</div>
<p>By the end of this chapter you should gain the following knowledge and practical skills.</p>
<div class="callout-note callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Knowledge outcomes
</div>
</div>
<div class="callout-body-container callout-body">
<ul class="task-list">
<li>
<input type="checkbox" disabled="" checked="">
Learn the vocabulary and concepts used to describe data.</li>
<li>
<input type="checkbox" disabled="" checked="">
Appreciate the characteristics and importance of tidy data <span class="citation" data-cites="wickham_tidy_2014">(<a href="references.html#ref-wickham_tidy_2014" role="doc-biblioref">Wickham 2014</a>)</span>.</li>
</ul>
</div>
</div>
<div class="callout-note callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Skills outcomes
</div>
</div>
<div class="callout-body-container callout-body">
<ul class="task-list">
<li>
<input type="checkbox" disabled="" checked="">
Load flat file datasets in RStudio.</li>
<li>
<input type="checkbox" disabled="" checked="">
Calculate descriptive summaries over datasets.</li>
<li>
<input type="checkbox" disabled="" checked="">
Apply high-level functions in <code>dplyr</code> and <code>tidyr</code> for working with data.</li>
<li>
<input type="checkbox" disabled="" checked="">
Create statistical graphics that expose high-level structure in data for cleaning purposes.</li>
</ul>
</div>
</div>
<section id="introduction" class="level2" data-number="2.1"><h2 data-number="2.1" class="anchored" data-anchor-id="introduction">
<span class="header-section-number">2.1</span> Introduction</h2>
<p>This chapter covers some of the basics of how to describe and organise data. Whilst this might sound prosaic, there are several reasons why being able to consistently describe a dataset is important. First, it is the initial step in any analysis and helps delimit the research themes and technical procedures that can be deployed. This is especially relevant to modern Data Science-type workflows, where it is common to apply the same analysis templates for working over data. Describing your dataset with a consistent vocabulary enables you to identify which analysis templates to reuse. Second relates to the point in Chapter <a href="01-intro.html"><span>1</span></a> that Social Data Science (SDS) projects usually involve repurposing datasets for the first time. It is often not obvious whether the data contain sufficient detail and structure to characterise the behaviours to be researched and the target populations they are assumed to represent. This leads to additional levels of uncertainty and places greater importance on the initial steps of data processing, description and exploration.</p>
<p>Through the chapter we will learn both language for describing and thinking about data, but also how to deploy some of the most important data processing and organisation techniques in <code>R</code> to wrangle real datasets. We will do so using data from New York’s <a href="https://www.citibikenyc.com/">Citibike</a> scheme, accessed through the <code>bikedata</code> package, an API to Citibike’s <a href="https://www.citibikenyc.com/system-data">publicly available origin-destination trip data</a>.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Data vocabulary
</div>
</div>
<div class="callout-body-container callout-body">
<p>The idea of applying a consistent vocabulary to describing your data applies especially to working with modern visualization toolkits (<a href="https://ggplot2.tidyverse.org/">ggplot2</a>, <a href="https://www.tableau.com/en-gb">Tableau</a>, <a href="https://vega.github.io/vega-lite/">vega-lite</a>), and will be covered in some detail during the next session as we introduce Visualization Fundamentals and the <a href="https://www.springer.com/gp/book/9780387245447">Grammar of Graphics</a> <span class="citation" data-cites="wilkinson_grammar_1999">(<a href="references.html#ref-wilkinson_grammar_1999" role="doc-biblioref">Wilkinson 1999</a>)</span>.</p>
</div>
</div>
</section><section id="concepts" class="level2" data-number="2.2"><h2 data-number="2.2" class="anchored" data-anchor-id="concepts">
<span class="header-section-number">2.2</span> Concepts</h2>
<section id="data-structure" class="level3" data-number="2.2.1"><h3 data-number="2.2.1" class="anchored" data-anchor-id="data-structure">
<span class="header-section-number">2.2.1</span> Data structure</h3>
<p>Throughout this book we will work with <a href="http://adv-r.had.co.nz/Data-structures.html#data-frames">data frames</a>. These are spreadsheet-like representations where rows are <em>observations</em> (cases/records) and columns are <em>variables</em>. In a data frame, each variable is a <a href="http://adv-r.had.co.nz/Data-structures.html#vectors">vector</a> that must be of equal length. Where observations have missing values for certain variables – that is, where they may violate this equal-length requirement – the missing values must be substituted with something, usually with <code>NA</code> or similar. This constraint can cause difficulties. For example, when working with variables that contain values of different length for an observation. In these cases we create a special class of column, a <a href="https://jennybc.github.io/purrr-tutorial/ls13_list-columns.html"><code>list-column</code></a>, a feature of data frames that we’ll return to later. Organising data according this simple structure – rows as observations, columns as variables – makes working with data more straightforward. A dedicted set of tools, made available via the <code>tidyverse</code>, can be deployed for performing most data <em>tidy</em>ing operations <span class="citation" data-cites="wickham_tidy_2014">(<a href="references.html#ref-wickham_tidy_2014" role="doc-biblioref">Wickham 2014</a>)</span>.</p>
</section><section id="types-of-variable" class="level3" data-number="2.2.2"><h3 data-number="2.2.2" class="anchored" data-anchor-id="types-of-variable">
<span class="header-section-number">2.2.2</span> Types of variable</h3>
<p>A widely-used classification for describing variables is that developed by <span class="citation" data-cites="stevens_on_1946">Stevens (<a href="references.html#ref-stevens_on_1946" role="doc-biblioref">1946</a>)</span>, when cosidering the <em>level of measurement</em> of a variable. <span class="citation" data-cites="stevens_on_1946">Stevens (<a href="references.html#ref-stevens_on_1946" role="doc-biblioref">1946</a>)</span> organised variables into two classes: variables that describe <em>categories</em> of things and variables that describe <em>measurements</em> of things. Categories include attributes like gender, titlesand ranked orders (1st, 2nd, 3rd largest etc.). Measurements include quantities like distance, age, travel time.</p>
<p>Categories can be further subdivided into those that are unordered (<em>nominal</em>) from those that are ordered (<em>ordinal</em>). Measurements can also be subdivided. <em>Interval</em> measurements are quantities that can be ordered and where the difference between two values is meaningful. <em>Ratio</em> measurements have both these properties, but also have a meaningful <code>0</code> – where <code>0</code> means the absence of something – and where the ratio of two values can be computed. The most common cited example of an interval measurement is temperature (in degrees C). Temperatures can be ordered and compared additively, but <code>0</code> degrees C does not mean the absence of temperature and 20 degrees C is not twice as “hot” as 10 degrees C.</p>
<div class="cell">
<div class="cell-output-display">
<div id="tbl-variable-types" class="anchored">
<table>
<caption>Table 2.1:  Breakdown of variable types </caption>
 <thead><tr>
<th style="text-align:left;"> Measurement </th>
   <th style="text-align:left;"> Description </th>
   <th style="text-align:left;"> Example </th>
   <th style="text-align:left;"> Operators </th>
   <th style="text-align:left;"> Midpoint </th>
   <th style="text-align:left;"> Spread </th>
  </tr></thead>
<tbody>
<tr grouplength="2"><td colspan="6" style="border-bottom: 0px solid;">Categories</td></tr>
<tr>
<td style="text-align:left;padding-left: 2em;width: 8em; " indentlevel="1"> `Nominal` </td>
   <td style="text-align:left;"> Non-orderable </td>
   <td style="text-align:left;"> Political parties; street names </td>
   <td style="text-align:left;"> =  ≠ </td>
   <td style="text-align:left;"> mode </td>
   <td style="text-align:left;"> entropy </td>
  </tr>
<tr>
<td style="text-align:left;padding-left: 2em;width: 8em; " indentlevel="1"> `Ordinal` </td>
   <td style="text-align:left;"> Orderable </td>
   <td style="text-align:left;"> Terrorism threat levels </td>
   <td style="text-align:left;"> =  ≠ &lt;&gt; </td>
   <td style="text-align:left;"> median </td>
   <td style="text-align:left;"> percentile </td>
  </tr>
<tr grouplength="2"><td colspan="6" style="border-bottom: 0px solid;">Measures</td></tr>
<tr>
<td style="text-align:left;padding-left: 2em;width: 8em; " indentlevel="1"> `Interval` </td>
   <td style="text-align:left;"> Measurements </td>
   <td style="text-align:left;"> Temperatures; years </td>
   <td style="text-align:left;"> =  ≠ &lt;&gt; +  - </td>
   <td style="text-align:left;"> mean </td>
   <td style="text-align:left;"> variance </td>
  </tr>
<tr>
<td style="text-align:left;padding-left: 2em;width: 8em; " indentlevel="1"> `Ratio` </td>
   <td style="text-align:left;"> ... | Counts </td>
   <td style="text-align:left;"> Distances; prices </td>
   <td style="text-align:left;"> =  ≠ &lt;&gt; +  - | × ÷ </td>
   <td style="text-align:left;"> mean </td>
   <td style="text-align:left;"> variance </td>
  </tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Why is this important? The measurement level of a variable determines the types of data analysis operations that can be performed and therefore allows us to efficiently make decisions when working with a dataset for the first time (<a href="#tbl-variable-types">Table&nbsp;<span>2.1</span></a>).</p>
</section><section id="types-of-observation" class="level3" data-number="2.2.3"><h3 data-number="2.2.3" class="anchored" data-anchor-id="types-of-observation">
<span class="header-section-number">2.2.3</span> Types of observation</h3>
<p>Observations either together form an entire <em>population</em> or a subset, or <em>sample</em> that we expect represents a <em>target population</em>.</p>
<p>You no doubt will be familiar with these concepts, but we have to think a little more about this in Social Data Science applications as we may often be working with datasets that are so-called population-level. The <a href="(https://www.citibikenyc.com/system-data)">Citibike dataset</a> is a complete, population-level dataset in that every journey made through the scheme is recorded. Whether or not this is truly a population-level dataset, however, depends on the analysis purpose. When analysing the bikeshare dataset are we interested <em>only</em> in describing use within the Citibike scheme? Or are we taking the patterns observed through our analysis to make claims and inferences about cycling more generally?</p>
<p>If the latter, then there are problems as the level of detail we have on our sample is pretty trivial compared to traditional datasets, where we deliberately design data collection activities with a specified target population in mind. It may therefore be difficult to gauge how representative Citibike users and Citibike cycling is of New York’s general cycling population. The flipside is that passively collected data do not suffer from the same problems such as non-response bias and social-desirability bias as traditionally collected datasets.</p>
</section><section id="tidy-data" class="level3" data-number="2.2.4"><h3 data-number="2.2.4" class="anchored" data-anchor-id="tidy-data">
<span class="header-section-number">2.2.4</span> Tidy data</h3>
<p>We will be working with data frames organised such that columns always and only refer to variables and rows always and only refer to observations. This arrangement, called <em>tidy</em> <span class="citation" data-cites="wickham_tidy_2014">(<a href="references.html#ref-wickham_tidy_2014" role="doc-biblioref">Wickham 2014</a>)</span>, has two key advantages. First, if data are arranged in a consistent way, then it is easier to apply and re-use tools for wrangling them due to data having the same underlying structure. Second, placing variables into columns, with each column containing a vector of values, means that we can take advantage of <code>R</code>’s vectorised functions for transforming data – we will demonstrate this in the technical element of this session.</p>
<p>The three rules for tidy data:</p>
<ol type="1">
<li>Each variable forms a column.</li>
<li>Each observation forms a row.</li>
<li>Each type of observational unit forms a table.</li>
</ol>
<section id="drug-treatment-dataset" class="level4" data-number="2.2.4.1"><h4 data-number="2.2.4.1" class="anchored" data-anchor-id="drug-treatment-dataset">
<span class="header-section-number">2.2.4.1</span> Drug treatment dataset</h4>
<p>To elaborate further, we can use the example given in <span class="citation" data-cites="wickham_tidy_2014">Wickham (<a href="references.html#ref-wickham_tidy_2014" role="doc-biblioref">2014</a>)</span>, a drug treatment dataset in which two different treatments were administered to participants.</p>
<div class="cell tbl-parent quarto-layout-panel">
<div class="panel-caption table-caption">
<p>Table 2.2: Table 1 of Wickham 2014</p>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div id="tbl-drugs-1" class="quarto-layout-cell quarto-layout-cell-subref anchored" data-ref-parent="tbl-drugs" style="flex-basis: 50.0%;justify-content: center;">
<table>
<caption>(a) One untidy organisation </caption>
 <thead><tr>
<th style="text-align:left;"> person </th>
   <th style="text-align:left;"> treatment_a </th>
   <th style="text-align:left;"> treatment_b </th>
  </tr></thead>
<tbody>
<tr>
<td style="text-align:left;"> John Smith </td>
   <td style="text-align:left;"> -- </td>
   <td style="text-align:left;"> 2 </td>
  </tr>
<tr>
<td style="text-align:left;"> Jane Doe </td>
   <td style="text-align:left;"> 16 </td>
   <td style="text-align:left;"> 11 </td>
  </tr>
<tr>
<td style="text-align:left;"> Mary Johnson </td>
   <td style="text-align:left;"> 3 </td>
   <td style="text-align:left;"> 1 </td>
  </tr>
</tbody>
</table>
</div>
<div id="tbl-drugs-2" class="quarto-layout-cell quarto-layout-cell-subref anchored" data-ref-parent="tbl-drugs" style="flex-basis: 50.0%;justify-content: center;">
<table>
<caption>(b) Alternative untidy organisation </caption>
 <thead><tr>
<th style="text-align:left;"> treatment </th>
   <th style="text-align:left;"> John Smith </th>
   <th style="text-align:left;"> Jane Doe </th>
   <th style="text-align:left;"> Mary Johnson </th>
  </tr></thead>
<tbody>
<tr>
<td style="text-align:left;"> treatment_a </td>
   <td style="text-align:left;"> -- </td>
   <td style="text-align:left;"> 16 </td>
   <td style="text-align:left;"> 3 </td>
  </tr>
<tr>
<td style="text-align:left;"> treatment_b </td>
   <td style="text-align:left;"> 2 </td>
   <td style="text-align:left;"> 11 </td>
   <td style="text-align:left;"> 1 </td>
  </tr>
</tbody>
</table>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div id="tbl-drugs-3" class="quarto-layout-cell quarto-layout-cell-subref anchored" data-ref-parent="tbl-drugs" style="flex-basis: 50.0%;justify-content: center;">
<table>
<caption>(c) Tidy organisation </caption>
 <thead><tr>
<th style="text-align:left;"> person </th>
   <th style="text-align:left;"> treatment </th>
   <th style="text-align:left;"> result </th>
  </tr></thead>
<tbody>
<tr>
<td style="text-align:left;"> John Smith </td>
   <td style="text-align:left;"> a </td>
   <td style="text-align:left;"> -- </td>
  </tr>
<tr>
<td style="text-align:left;"> John Smith </td>
   <td style="text-align:left;"> b </td>
   <td style="text-align:left;"> 2 </td>
  </tr>
<tr>
<td style="text-align:left;"> Jane Doe </td>
   <td style="text-align:left;"> a </td>
   <td style="text-align:left;"> 16 </td>
  </tr>
<tr>
<td style="text-align:left;"> Jane Doe </td>
   <td style="text-align:left;"> b </td>
   <td style="text-align:left;"> 11 </td>
  </tr>
<tr>
<td style="text-align:left;"> Mary Johnson </td>
   <td style="text-align:left;"> a </td>
   <td style="text-align:left;"> 3 </td>
  </tr>
<tr>
<td style="text-align:left;"> Mary Johnson </td>
   <td style="text-align:left;"> b </td>
   <td style="text-align:left;"> 1 </td>
  </tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Both untidy tables present the same information unambiguously – <a href="#tbl-drugs">Table&nbsp;<span>2.2</span></a> (b) is simply <a href="#tbl-drugs">Table&nbsp;<span>2.2</span></a> (a) transposed. However, neither is <em>tidy</em> as the observations are spread across both the rows and columns. This means that we need to apply different procedures to extract, perform computations on, and visually represent, these data.</p>
<p>In the <em>tidy</em> form, each <em>observation</em> is a test result returned for each combination of <code>person</code> and <code>treatment</code>. To get to this formulation, it is necessary to identify the discrete variables:</p>
<ol type="1">
<li>
<code>person</code>: a categorical nominal variable which takes three values: John Smith, Jane Doe, Mary Johnson.</li>
<li>
<code>treatment</code>: a categorical nominal variable which takes values: a and b.</li>
<li>
<code>result</code>: a measurement ratio (I think) variable which six recorded values (including the missing value): –, 16, 3, 2, 11,</li>
</ol></section><section id="gapminder-population-dataset" class="level4" data-number="2.2.4.2"><h4 data-number="2.2.4.2" class="anchored" data-anchor-id="gapminder-population-dataset">
<span class="header-section-number">2.2.4.2</span> Gapminder population dataset</h4>
<p>In <span class="citation" data-cites="wickham_r_2017">Wickham and Grolemund (<a href="references.html#ref-wickham_r_2017" role="doc-biblioref">2017</a>)</span>, the benefits of tidy layouts are demonstrated with the <a href="https://www.gapminder.org/data/"><code>gapminder</code></a> dataset and with refernce to key data processing functions in <code>R</code>. To consolidate our understanding of <em>tidy</em> data let’s quickly look at the <code>gapminder</code> data, as it is an example that we’re probably more likely to encounter in SDS research.</p>
<div class="cell tbl-parent quarto-layout-panel">
<div class="panel-caption table-caption">
<p>Table 2.3: Excerpts of <a href="https://www.gapminder.org/data/"><code>gapminder</code></a> dataset.</p>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div id="tbl-gapminder-1" class="quarto-layout-cell quarto-layout-cell-subref anchored" data-ref-parent="tbl-gapminder" style="flex-basis: 50.0%;justify-content: center;">
<table>
<caption>(a) Tidy organisation </caption>
 <thead><tr>
<th style="text-align:left;"> country </th>
   <th style="text-align:left;"> year </th>
   <th style="text-align:left;"> cases </th>
   <th style="text-align:left;"> population </th>
  </tr></thead>
<tbody>
<tr>
<td style="text-align:left;"> Afghanistan </td>
   <td style="text-align:left;"> 1999 </td>
   <td style="text-align:left;"> 745 </td>
   <td style="text-align:left;"> 19987071 </td>
  </tr>
<tr>
<td style="text-align:left;"> Afghanistan </td>
   <td style="text-align:left;"> 2000 </td>
   <td style="text-align:left;"> 2666 </td>
   <td style="text-align:left;"> 20595360 </td>
  </tr>
<tr>
<td style="text-align:left;"> Brazil </td>
   <td style="text-align:left;"> 1999 </td>
   <td style="text-align:left;"> 37737 </td>
   <td style="text-align:left;"> 172006362 </td>
  </tr>
<tr>
<td style="text-align:left;"> Brazil </td>
   <td style="text-align:left;"> 2000 </td>
   <td style="text-align:left;"> 80488 </td>
   <td style="text-align:left;"> 174504898 </td>
  </tr>
<tr>
<td style="text-align:left;"> China </td>
   <td style="text-align:left;"> 1999 </td>
   <td style="text-align:left;"> 212258 </td>
   <td style="text-align:left;"> 1272915272 </td>
  </tr>
<tr>
<td style="text-align:left;"> China </td>
   <td style="text-align:left;"> 2000 </td>
   <td style="text-align:left;"> 213766 </td>
   <td style="text-align:left;"> 1280428583 </td>
  </tr>
</tbody>
</table>
</div>
<div id="tbl-gapminder-2" class="quarto-layout-cell quarto-layout-cell-subref anchored" data-ref-parent="tbl-gapminder" style="flex-basis: 50.0%;justify-content: center;">
<table>
<caption>(b) Untidy organisation </caption>
 <thead><tr>
<th style="text-align:left;"> country </th>
   <th style="text-align:left;"> year </th>
   <th style="text-align:left;"> type </th>
   <th style="text-align:left;"> count </th>
  </tr></thead>
<tbody>
<tr>
<td style="text-align:left;"> Afghanistan </td>
   <td style="text-align:left;"> 1999 </td>
   <td style="text-align:left;"> cases </td>
   <td style="text-align:left;"> 745 </td>
  </tr>
<tr>
<td style="text-align:left;"> Afghanistan </td>
   <td style="text-align:left;"> 1999 </td>
   <td style="text-align:left;"> population </td>
   <td style="text-align:left;"> 19987071 </td>
  </tr>
<tr>
<td style="text-align:left;"> Afghanistan </td>
   <td style="text-align:left;"> 2000 </td>
   <td style="text-align:left;"> cases </td>
   <td style="text-align:left;"> 2666 </td>
  </tr>
<tr>
<td style="text-align:left;"> Afghanistan </td>
   <td style="text-align:left;"> 2000 </td>
   <td style="text-align:left;"> population </td>
   <td style="text-align:left;"> 20595360 </td>
  </tr>
<tr>
<td style="text-align:left;"> Brazil </td>
   <td style="text-align:left;"> 1999 </td>
   <td style="text-align:left;"> cases </td>
   <td style="text-align:left;"> 37737 </td>
  </tr>
<tr>
<td style="text-align:left;"> Brazil </td>
   <td style="text-align:left;"> 1999 </td>
   <td style="text-align:left;"> population </td>
   <td style="text-align:left;"> 174504898 </td>
  </tr>
<tr>
<td style="text-align:left;"> ... </td>
   <td style="text-align:left;"> ... </td>
   <td style="text-align:left;"> ... </td>
   <td style="text-align:left;"> ... </td>
  </tr>
</tbody>
</table>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div id="tbl-gapminder-3" class="quarto-layout-cell quarto-layout-cell-subref anchored" data-ref-parent="tbl-gapminder" style="flex-basis: 50.0%;justify-content: center;">
<table>
<caption>(c) Another untidy organisation </caption>
 <thead><tr>
<th style="text-align:left;"> country </th>
   <th style="text-align:left;"> year </th>
   <th style="text-align:left;"> f_cases </th>
   <th style="text-align:left;"> m_cases </th>
   <th style="text-align:left;"> f_population </th>
   <th style="text-align:left;"> m_population </th>
  </tr></thead>
<tbody>
<tr>
<td style="text-align:left;"> Afghanistan </td>
   <td style="text-align:left;"> 1999 </td>
   <td style="text-align:left;"> 447 </td>
   <td style="text-align:left;"> 298 </td>
   <td style="text-align:left;"> 9993400 </td>
   <td style="text-align:left;"> 9993671 </td>
  </tr>
<tr>
<td style="text-align:left;"> Afghanistan </td>
   <td style="text-align:left;"> 2000 </td>
   <td style="text-align:left;"> 1599 </td>
   <td style="text-align:left;"> 1067 </td>
   <td style="text-align:left;"> 10296280 </td>
   <td style="text-align:left;"> 10299080 </td>
  </tr>
<tr>
<td style="text-align:left;"> Brazil </td>
   <td style="text-align:left;"> 1999 </td>
   <td style="text-align:left;"> 16982 </td>
   <td style="text-align:left;"> 20755 </td>
   <td style="text-align:left;"> 86001181 </td>
   <td style="text-align:left;"> 86005181 </td>
  </tr>
<tr>
<td style="text-align:left;"> Brazil </td>
   <td style="text-align:left;"> 2000 </td>
   <td style="text-align:left;"> 39440 </td>
   <td style="text-align:left;"> 41048 </td>
   <td style="text-align:left;"> 87251329 </td>
   <td style="text-align:left;"> 87253569 </td>
  </tr>
<tr>
<td style="text-align:left;"> China </td>
   <td style="text-align:left;"> 1999 </td>
   <td style="text-align:left;"> 104007 </td>
   <td style="text-align:left;"> 108252 </td>
   <td style="text-align:left;"> 636451250 </td>
   <td style="text-align:left;"> 636464022 </td>
  </tr>
<tr>
<td style="text-align:left;"> China </td>
   <td style="text-align:left;"> 2000 </td>
   <td style="text-align:left;"> 104746 </td>
   <td style="text-align:left;"> 109759 </td>
   <td style="text-align:left;"> 640212600 </td>
   <td style="text-align:left;"> 640215983 </td>
  </tr>
</tbody>
</table>
</div>
</div>
</div>
<p>From the a<em>tidy</em> version of the data, we can identify the <em>variables</em> and note that each <em>observation</em> is a recorded count of cases and population for a country in a year.</p>
<ol type="1">
<li>
<code>country</code>: a categorical nominal variable.</li>
<li>
<code>year</code>: a date (cyclic ratio) variable.</li>
<li>
<code>cases</code>: a ratio (count) variable.</li>
<li>
<code>population</code>: a ratio (count) variable.</li>
</ol>
<p>An alternative organisation of this dataset that appears in <span class="citation" data-cites="wickham_r_2017">Wickham and Grolemund (<a href="references.html#ref-wickham_r_2017" role="doc-biblioref">2017</a>)</span> is in <a href="#tbl-gapminder">Table&nbsp;<span>2.3</span></a> (b). This is <em>untidy</em> as the observations are spread across two rows. This makes operations that we might want to perform on the <code>cases</code> and <code>population</code> variables – for example computing exposure rates – somewhat tedious.</p>
<p>Imagine that the <code>gapminder</code> dataset reported values of <code>cases</code> separately by gender – <a href="#tbl-gapminder">Table&nbsp;<span>2.3</span></a> (c). A type of representation often seen in social science domains, probably as it is helpful for data entry, is where observations are spread across the columns. This too creates problems for performing aggregate functions, but also for specifying visualization designs (in <a href="https://ggplot2.tidyverse.org/"><code>ggplot2</code></a>) as we will discover in the next session.</p>
</section></section></section><section id="techniques" class="level2" data-number="2.3"><h2 data-number="2.3" class="anchored" data-anchor-id="techniques">
<span class="header-section-number">2.3</span> Techniques</h2>
<p>The technical element to this chapter involves importing, describing, transforming and tidying data from a large bikeshare scheme – New York’s <a href="https://www.citibikenyc.com/">Citibike</a> scheme.</p>
<ul>
<li>Download the <a href="">02-template.Rmd</a> file and save it to the <code>reports</code> folder of your <code>vis4sds</code> project that you created in chapter 1.</li>
<li>Open your <code>vis4sds</code> project in RStudio and load the template file by clicking <code>File</code> &gt; <code>Open File ...</code> &gt; <code>reports/02-template.Rmd</code>.</li>
</ul>
<section id="import" class="level3" data-number="2.3.1"><h3 data-number="2.3.1" class="anchored" data-anchor-id="import">
<span class="header-section-number">2.3.1</span> Import</h3>
<p>In the template file there is a discussion of how to setup your R session with key packages – <code>tidyverse</code> , <code>fst</code>, <code>lubridate</code>, <code>sf</code> – and also the <a href="https://github.com/ropensci/bikedata"><code>bikedata</code></a> package for accessing bikeshare data.</p>
<p>Available via the <code>bikedata</code> package are trip and occupancy data for a number of bikeshare schemes (as below). We will work with data from New York’s <a href="https://www.citibikenyc.com/">Citibike</a> scheme for June 2020. A list of all cities covered by the <code>bikedata</code> package is below:</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu">bike_cities</span><span class="op">(</span><span class="op">)</span>
<span class="co">##    city     city_name      bike_system</span>
<span class="co">## 1    bo        Boston           Hubway</span>
<span class="co">## 2    ch       Chicago            Divvy</span>
<span class="co">## 3    dc Washington DC CapitalBikeShare</span>
<span class="co">## 4    gu   Guadalajara           mibici</span>
<span class="co">## 5    la   Los Angeles            Metro</span>
<span class="co">## 6    lo        London        Santander</span>
<span class="co">## 7    mo      Montreal             Bixi</span>
<span class="co">## 8    mn   Minneapolis         NiceRide</span>
<span class="co">## 9    ny      New York         Citibike</span>
<span class="co">## 10   ph  Philadelphia           Indego</span>
<span class="co">## 11   sf      Bay Area       FordGoBike</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the template there are code chunks demonstrating how to download and process these data using <a href="https://github.com/ropensci/bikedata">bikedata</a>’s API. This is mainly for illustrative purposes and the code chunks take some time to execute. We ultimately use the <a href="https://www.fstpackage.org/"><code>fst</code></a> package for serializing and reading in the these data. So I suggest you ignore the import code and calls to the <code>bikedata</code> API and instead follow the instructions for downloading and reading in the <code>.fst</code> file with the trips data and also the <code>.csv</code> file containing stations data, with:</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="co"># Create subdirectory in data folder for storing bike data.</span>
<span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.exists</a></span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"bikedata"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"bikedata"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Read in .csv file of stations data from url.</span>
<span class="va">tmp_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">url</span> <span class="op">&lt;-</span> <span class="st">"https://www.roger-beecham.com/datasets/ny_stations.csv"</span>
<span class="fu">curl</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/curl/man/curl_download.html">curl_download</a></span><span class="op">(</span><span class="va">url</span>, <span class="va">tmp_file</span>, mode<span class="op">=</span><span class="st">"wb"</span><span class="op">)</span>
<span class="va">ny_stations</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="va">tmp_file</span><span class="op">)</span>

<span class="co"># Read in .fst file of trips data from url.</span>
<span class="va">tmp_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">cs_url</span> <span class="op">&lt;-</span> <span class="st">"https://www.roger-beecham.com/datasets/ny_trips.fst"</span>
<span class="fu">curl</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/curl/man/curl_download.html">curl_download</a></span><span class="op">(</span><span class="va">url</span>, <span class="va">tmp_file</span>, mode<span class="op">=</span><span class="st">"wb"</span><span class="op">)</span>
<span class="va">ny_trips</span> <span class="op">&lt;-</span> <span class="fu">read_fst</span><span class="op">(</span><span class="va">tmp_file</span><span class="op">)</span>

<span class="co"># Write out to subdirectory for future use.</span>
<span class="fu">write_fst</span><span class="op">(</span><span class="va">trips</span>, <span class="fu">here</span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"ny_trips.fst"</span><span class="op">)</span><span class="op">)</span>
<span class="fu">write_csv</span><span class="op">(</span><span class="va">stations</span>, <span class="fu">here</span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"ny_stations.csv"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Clean workspace.</span>
<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">url</span>, <span class="va">tmp_file</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>fst</code> implements in the background various operations such as multi-threading to reduce load on disk space. It therefore makes it possible to work with large datasets in-memory in <code>R</code> rather than connecting to a database and serving up summaries/subsets to be loaded into R. We will be working with just 2 million records, but with <code>fst</code> it is possible to work in-memory with much larger datasets – in <span class="citation" data-cites="lovelace_is_2020">Lovelace et al. (<a href="references.html#ref-lovelace_is_2020" role="doc-biblioref">2020</a>)</span> we ended up working with 80 million + trip records.</p>
</div>
</div>
<p>Some of the above may be familiar to you. The key arguments to look at are <code>read_csv()</code> and <code>read_fst()</code>, into which we pass the path to the file. In this case we created a <code>tmpfile()</code> within the R session. We then write these data out and save locally to the project’s <code>data</code> folder. This is useful as we only want to download the data once. In the <code>write_*&lt;&gt;</code> functions we reference this location using the <a href="https://here.r-lib.org/"><code>here</code></a> package’s <code>here()</code> function. <a href="https://here.r-lib.org/"><code>here</code></a> is really useful for reliably creating paths relative to your project’s root. To read in these data for future sessions:</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="co"># Read in these local copies of the trips and stations data.</span>
<span class="va">ny_trips</span> <span class="op">&lt;-</span> <span class="fu">read_fst</span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"ny_trips.fst"</span><span class="op">)</span><span class="op">)</span>
<span class="va">ny_stations</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"ny_stations.csv"</span><span class="op">)</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice that we use <em>assignment</em> here (<code>&lt;-</code>) so that these data are loaded as objects and appear in the Environment pane of your RStudio window.</p>
<p><code>ny_stations</code> and <code>ny_trips</code> are data frames, spreadsheet type representations containing observations in rows and variables in columns. Inspecting the layout of the stations data with <code>View(ny_stations)</code> you will notice that the top line is the header and contains column (variable) names.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-view-annotate" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="../../../figs/view.png" class="img-fluid figure-img"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">Figure 2.1: <code>ny_trips</code> and <code>ny_stations</code> as they appear when calling <code><a href="https://rdrr.io/r/utils/View.html">View()</a></code>.</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section><section id="describe" class="level3" data-number="2.3.2"><h3 data-number="2.3.2" class="anchored" data-anchor-id="describe">
<span class="header-section-number">2.3.2</span> Describe</h3>
<p>There are several functions for generating a quick overview of a data frame’s contents. <code>glimpse&lt;dataset-name&gt;</code> is particularly useful. It provides a summary of the data frame dimensions – we have c.&nbsp;1.9 million trip observations in <code>ny_trips</code> and 11 variables<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. The function also prints out the object type for each of these variables, with the variables either of type <code>int</code> or <code>chr</code> in this case.</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu">glimpse</span><span class="op">(</span><span class="va">ny_trips</span><span class="op">)</span>
<span class="co">## Rows: 1,882,273</span>
<span class="co">## Columns: 11</span>
<span class="co">## $ id               &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21…</span>
<span class="co">## $ city             &lt;chr&gt; "ny", "ny", "ny", "ny", "ny", "ny", "ny", "ny", "ny", "ny", "ny", "ny", "…</span>
<span class="co">## $ trip_duration    &lt;dbl&gt; 1062, 3810, 1017, 226, 1437, 355, 99, 1810, 87, 2714, 2096, 1611, 529, 69…</span>
<span class="co">## $ start_time       &lt;chr&gt; "2020-06-01 00:00:03", "2020-06-01 00:00:03", "2020-06-01 00:00:09", "202…</span>
<span class="co">## $ stop_time        &lt;chr&gt; "2020-06-01 00:17:46", "2020-06-01 01:03:33", "2020-06-01 00:17:06", "202…</span>
<span class="co">## $ start_station_id &lt;chr&gt; "ny3419", "ny366", "ny389", "ny3255", "ny367", "ny248", "ny3232", "ny3263…</span>
<span class="co">## $ end_station_id   &lt;chr&gt; "ny3419", "ny336", "ny3562", "ny505", "ny497", "ny247", "ny390", "ny496",…</span>
<span class="co">## $ bike_id          &lt;chr&gt; "39852", "37558", "37512", "39674", "21093", "39594", "43315", "16571", "…</span>
<span class="co">## $ user_type        &lt;chr&gt; "Customer", "Subscriber", "Customer", "Customer", "Customer", "Subscriber…</span>
<span class="co">## $ birth_year       &lt;chr&gt; "1997", "1969", "1988", "1969", "1997", "1990", "1938", "1995", "1971", "…</span>
<span class="co">## $ gender           &lt;dbl&gt; 2, 0, 2, 0, 2, 1, 2, 2, 2, 1, 1, 0, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu">glimpse</span><span class="op">(</span><span class="va">ny_stations</span><span class="op">)</span>
<span class="co">## Rows: 1,010</span>
<span class="co">## Columns: 6</span>
<span class="co">## $ id        &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 2…</span>
<span class="co">## $ city      &lt;chr&gt; "ny", "ny", "ny", "ny", "ny", "ny", "ny", "ny", "ny", "ny", "ny", "ny", "ny", "n…</span>
<span class="co">## $ stn_id    &lt;chr&gt; "ny116", "ny119", "ny120", "ny127", "ny128", "ny143", "ny144", "ny146", "ny150",…</span>
<span class="co">## $ name      &lt;chr&gt; "W 17 St &amp; 8 Ave", "Park Ave &amp; St Edwards St", "Lexington Ave &amp; Classon Ave", "B…</span>
<span class="co">## $ longitude &lt;chr&gt; "-74.00149746", "-73.97803415", "-73.95928168", "-74.00674436", "-74.00297088", …</span>
<span class="co">## $ latitude  &lt;chr&gt; "40.74177603", "40.69608941", "40.68676793", "40.73172428", "40.72710258", "40.6…</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell tbl-parent quarto-layout-panel">

</div>
<p>The object type of a variable in a data frame relates to that variable’s <em>measurement level</em>. It is often useful to convert to types with greater specificity. For example, we may which to convert the <code>start_time</code> and <code>stop_time</code> variables to a date-time format so that various time-related functions could be used. For efficient storage, we may wish to convert the <em>station identifier</em> variables as <code>int</code> types by removing the redundant “ny” text which prefaces <code>end_station_id</code>, <code>end_station_id</code>, <code>stn_id</code>. The geographic coordinates are currently stored as type <code>chr</code>. These could be regarded as quantitative variables, floating points with decimals. So converting to type <code>dbl</code> or as a <a href="https://r-spatial.github.io/sf/articles/sf1.html#simple-feature-geometry-types"><code>POINT</code></a> geometry type (more on this later in the course) may be sensible.</p>
<p>In the <a href="">02-template.Rmd</a> file there are code chunks for doing these conversions. There are some slightly more involved data transform procedures in this code. Don’t fixate too much on these, but the upshot can be seen when running <code>glimpse()</code> on the converted data frames:</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu">glimpse</span><span class="op">(</span><span class="va">ny_trips</span><span class="op">)</span>
<span class="co">## Rows: 1,882,273</span>
<span class="co">## Columns: 10</span>
<span class="co">## $ id               &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 2…</span>
<span class="co">## $ trip_duration    &lt;dbl&gt; 1062, 3810, 1017, 226, 1437, 355, 99, 1810, 87, 2714, 2096, 1611, 529, 695, 206,…</span>
<span class="co">## $ start_time       &lt;dttm&gt; 2020-06-01 00:00:03, 2020-06-01 00:00:03, 2020-06-01 00:00:09, 2020-06-01 00:00…</span>
<span class="co">## $ stop_time        &lt;dttm&gt; 2020-06-01 00:00:03, 2020-06-01 00:00:03, 2020-06-01 00:00:09, 2020-06-01 00:00…</span>
<span class="co">## $ start_station_id &lt;int&gt; 3419, 366, 389, 3255, 367, 248, 3232, 3263, 390, 319, 237, 3630, 3610, 3708, 465…</span>
<span class="co">## $ end_station_id   &lt;int&gt; 3419, 336, 3562, 505, 497, 247, 390, 496, 3232, 455, 3263, 3630, 3523, 3740, 379…</span>
<span class="co">## $ bike_id          &lt;int&gt; 39852, 37558, 37512, 39674, 21093, 39594, 43315, 16571, 28205, 41760, 30745, 380…</span>
<span class="co">## $ user_type        &lt;chr&gt; "Customer", "Subscriber", "Customer", "Customer", "Customer", "Subscriber", "Sub…</span>
<span class="co">## $ birth_year       &lt;int&gt; 1997, 1969, 1988, 1969, 1997, 1990, 1938, 1995, 1971, 1989, 1990, 1969, 1984, 19…</span>
<span class="co">## $ gender           &lt;chr&gt; "female", "unknown", "female", "unknown", "female", "male", "female", "female", …</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu">glimpse</span><span class="op">(</span><span class="va">ny_stations</span><span class="op">)</span>
<span class="co">## Rows: 1,010</span>
<span class="co">## Columns: 5</span>
<span class="co">## $ id        &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, …</span>
<span class="co">## $ stn_id    &lt;int&gt; 116, 119, 120, 127, 128, 143, 144, 146, 150, 151, 157, 161, 164, 167, 168, 173, 174, 19…</span>
<span class="co">## $ name      &lt;chr&gt; "W 17 St &amp; 8 Ave", "Park Ave &amp; St Edwards St", "Lexington Ave &amp; Classon Ave", "Barrow S…</span>
<span class="co">## $ longitude &lt;dbl&gt; -74.00150, -73.97803, -73.95928, -74.00674, -74.00297, -73.99338, -73.98069, -74.00911,…</span>
<span class="co">## $ latitude  &lt;dbl&gt; 40.74178, 40.69609, 40.68677, 40.73172, 40.72710, 40.69240, 40.69840, 40.71625, 40.7208…</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="transform" class="level3" data-number="2.3.3"><h3 data-number="2.3.3" class="anchored" data-anchor-id="transform">
<span class="header-section-number">2.3.3</span> Transform</h3>
<section id="transform-with-dplyr" class="level4" data-number="2.3.3.1"><h4 data-number="2.3.3.1" class="anchored" data-anchor-id="transform-with-dplyr">
<span class="header-section-number">2.3.3.1</span> Transform with <code>dplyr</code>
</h4>
<div class="cell">
<div class="cell-output-display">
<div id="tbl-dplyr-verbs" class="anchored">
<table>
<caption>Table 2.4:  dplyr funcitions (verbs) for manipulating data frames. </caption>
 <thead><tr>
<th style="text-align:left;"> function() </th>
   <th style="text-align:left;"> Description </th>
  </tr></thead>
<tbody>
<tr>
<td style="text-align:left;"> `filter()` </td>
   <td style="text-align:left;"> Picks rows (observations) if their values match a specified criteria </td>
  </tr>
<tr>
<td style="text-align:left;"> `arrange()` </td>
   <td style="text-align:left;"> Reorders rows (observations) based on their values </td>
  </tr>
<tr>
<td style="text-align:left;"> `select()` </td>
   <td style="text-align:left;"> Picks a subset of columns (variables) by name (or name characteristics) </td>
  </tr>
<tr>
<td style="text-align:left;"> `rename()` </td>
   <td style="text-align:left;"> Changes the name of columns in the data frame </td>
  </tr>
<tr>
<td style="text-align:left;"> `mutate()` </td>
   <td style="text-align:left;"> Adds new columns (or variables) </td>
  </tr>
<tr>
<td style="text-align:left;"> `group_by()` </td>
   <td style="text-align:left;"> Chunks the dataset into groups for grouped operations </td>
  </tr>
<tr>
<td style="text-align:left;"> `summarise()` </td>
   <td style="text-align:left;"> Calculate single-row (non-grouped) or multiple-row (if grouped) summary values </td>
  </tr>
<tr>
<td style="text-align:left;"> `..and more` </td>
   <td style="text-align:left;">  </td>
  </tr>
</tbody>
</table>
</div>
</div>
</div>
<p><a href="https://dplyr.tidyverse.org/"><code>dplyr</code></a> is one of the most important packages for supporting modern data analysis workflows. The package provides a <em>grammar of data manipulation</em>, with access to functions that can be variously combined to support most data processing and transformation activity. Once you become familiar with <code>dplyr</code> functions (or <em>verbs</em>) you will find yourself generating analysis templates to re-use whenever you work on a new dataset.</p>
<p>All <code>dplyr</code> functions work in the same way:</p>
<ol type="1">
<li>Start with a data frame.</li>
<li>Pass some arguments to the function which control what you do to the data frame.</li>
<li>Return the updated data frame.</li>
</ol>
<p>So every <code>dplyr</code> function expects a data frame and will always return a data frame.</p>
</section><section id="use-pipes-with-dplyr" class="level4" data-number="2.3.3.2"><h4 data-number="2.3.3.2" class="anchored" data-anchor-id="use-pipes-with-dplyr">
<span class="header-section-number">2.3.3.2</span> Use pipes <code>%&gt;%</code> with <code>dplyr</code>
</h4>
<p><code>dplyr</code> is most effective when its functions are chained together – you will see this shortly as we explore the New York bikeshare data. This chaining of functions can be achieved using the <em>pipe</em> operator (<code>%&gt;%</code>). Pipes are used for passing information in a program. They take the output of a set of code (a <code>dplyr</code> specification) and make it the input of the next set (another <code>dplyr</code> specification).</p>
<p>Pipes can be easily applied to <code>dplyr</code> functions, and the functions of all packages that form the <code>tidyverse</code>. We mentioned in Chapter <a href="01-intro.html"><span>1</span></a> that <code>ggplot2</code> provides a framework for specifying a <em>layered grammar of graphics</em> (more on this in Chapter <a href="03-visual.html"><span>3</span></a>). Together with the pipe operator (<code>%&gt;%</code>), <code>dplyr</code> supports a <em>layered grammar of data manipulation</em>.</p>
</section><section id="count-rows" class="level4" data-number="2.3.3.3"><h4 data-number="2.3.3.3" class="anchored" data-anchor-id="count-rows">
<span class="header-section-number">2.3.3.3</span> <code>count()</code> rows</h4>
<p>This might sound a little abstract so let’s use and combine some <code>dplyr</code> functions to generate some statistical summaries on the New York bikeshare data.</p>
<p>First we’ll count the number of trips made in Jun 2020 by gender. <code>dplyr</code> has a convenience function for counting, so we could run the code below, also in the <a href="">02-template.Rmd</a> for this session. I’ve commented the code block to convey what each line achieves.</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">ny_trips</span> <span class="op">%&gt;%</span>  <span class="co"># Take the ny_trips data frame.</span>
  <span class="fu">count</span><span class="op">(</span><span class="va">gender</span>, sort<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="co"># Run the count function over the data frame and set the sort parameter to TRUE.</span>
<span class="co">##    gender       n</span>
<span class="co">## 1    male 1044621</span>
<span class="co">## 2  female  586361</span>
<span class="co">## 3 unknown  251291</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are a few things happening in the <code>count()</code> function. It takes the <code>gender</code> variable from <code>ny_trips</code>, organises or <em>groups</em> the rows in the data frame according to its values (<code>female</code> | <code>male</code> | <code>unknown</code>), counts the rows and then orders the <em>summarised</em> output descending on the counts.</p>
</section><section id="summarise-over-rows" class="level4" data-number="2.3.3.4"><h4 data-number="2.3.3.4" class="anchored" data-anchor-id="summarise-over-rows">
<span class="header-section-number">2.3.3.4</span> <code>summarise()</code> over rows</h4>
<div class="cell">
<div class="cell-output-display">
<div id="tbl-aggregate-functions" class="anchored">
<table>
<caption>Table 2.5:  A breakdown of aggregate functions commonly used with summarise(). </caption>
 <thead><tr>
<th style="text-align:left;"> Function </th>
   <th style="text-align:left;"> Description </th>
  </tr></thead>
<tbody>
<tr>
<td style="text-align:left;"> `n()` </td>
   <td style="text-align:left;"> Counts the number of observations </td>
  </tr>
<tr>
<td style="text-align:left;"> `n_distinct(var)` </td>
   <td style="text-align:left;"> Counts the number of unique observations </td>
  </tr>
<tr>
<td style="text-align:left;"> `sum(var)` </td>
   <td style="text-align:left;"> Sums the values of observations </td>
  </tr>
<tr>
<td style="text-align:left;"> `max(var)`|`min(var)` </td>
   <td style="text-align:left;"> Finds the min|max values of observations </td>
  </tr>
<tr>
<td style="text-align:left;"> `mean(var)`|`median(var)`|`sd(var)`| `...` </td>
   <td style="text-align:left;"> Calculates central tendency of observations </td>
  </tr>
<tr>
<td style="text-align:left;"> `...` </td>
   <td style="text-align:left;"> Many more </td>
  </tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Often you will want to do more than simply counting and you may also want to be more explicit in the way the data frame is <em>grouped</em> for computation. We’ll demonstrate this here with a more involved analysis of the usage data and using some key aggregate functions (Table <a href="#tbl-aggregate-functions">Table&nbsp;<span>2.5</span></a>.</p>
<p>A common workflow is to combine <code>group_by()</code> and <code>summarise()</code>, and in this case <code>arrange()</code> to replicate the <code>count()</code> example.</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">ny_trips</span> <span class="op">%&gt;%</span> <span class="co"># Take the ny_trips data frame.</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">gender</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># Group by gender.</span>
  <span class="fu">summarise</span><span class="op">(</span>count<span class="op">=</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># Count the number of observations per group.</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span> <span class="co"># Arrange the grouped and summarised (collapsed) rows according to count.</span>
<span class="co">## # A tibble: 3 x 2</span>
<span class="co">##  gender    count</span>
<span class="co">##  &lt;chr&gt;     &lt;int&gt;</span>
<span class="co">## 1 male    1044621</span>
<span class="co">## 2 female   586361</span>
<span class="co">## 3 unknown  251291</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In <code>ny_trips</code> there is a variable measuring trip duration in seconds (<code>trip_duration</code>) and distinguishing casual users from those formally registered to use the scheme (<code>user_type</code> - <code>Customer</code> vs.&nbsp;<code>Subscriber</code>). It may be instructive to calculate some summary statistics to see how trip duration varies between these groups.</p>
<p>The code below uses <code>group_by()</code>, <code>summarise()</code> and <code>arrange()</code> in exactly the same way, but with the addition of other aggregate functions profiles the <code>trip_duration</code> variable according to central tendency and by <code>user_type</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">ny_trips</span> <span class="op">%&gt;%</span> <span class="co"># Take the ny_trips data frame.</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">user_type</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># Group by user type.</span>
  <span class="fu">summarise</span><span class="op">(</span> <span class="co"># Summarise over the grouped rows, generate a new variable for each type of summary.</span>
    count<span class="op">=</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span>,
    avg_duration<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">trip_duration</span><span class="op">/</span><span class="fl">60</span><span class="op">)</span>,
    median_duration<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">trip_duration</span><span class="op">/</span><span class="fl">60</span><span class="op">)</span>,
    sd_duration<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">trip_duration</span><span class="op">/</span><span class="fl">60</span><span class="op">)</span>,
    min_duration<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">trip_duration</span><span class="op">/</span><span class="fl">60</span><span class="op">)</span>,
    max_duration<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">trip_duration</span><span class="op">/</span><span class="fl">60</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span> <span class="co"># Arrange on the count variable.</span>

<span class="co">## # A tibble: 2 x 6</span>
<span class="co">##  user_type    count avg_duration median_duration sd_duration min_duration max_duration</span>
<span class="co">##  &lt;chr&gt;        &lt;int&gt;        &lt;dbl&gt;           &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;</span>
<span class="co">## 1 Subscriber 1306688         20.2            14.4        110.         1.02         33090</span>
<span class="co">## 2 Customer    575585         43.6            23.2        393.         1.02         46982</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Clearly there are some outlier trips that may need to be examined. Bikeshare schemes are built to incentivise short journeys of &lt;30 minutes, but the maximum trip duration recorded above is clearly erroneous – 32 days. Ignoring these sorts of outliers by calculating the trip durations at the 95th percentiles is instructive. The max trip duration at the 95th percentile for <code>Subscribers</code> was almost 27 minutes and for <code>Customers</code> was 1 hours 26 mins. It makes sense that more casual users may have longer trip durations, as they are more likely to be tourists or occasional cyclists using the scheme for non-utility trips. However, they do skew the mean travel time.</p>
<p>Returning to the breakdown of usage by gender, an interesting question is whether or not the male-female split in bikehare is similar to that of the cycling population of New York City as a whole. This might tell us something about whether the bikeshare scheme could be <em>representative</em> of wider cycling. This could be achieved with the code below. A couple of new additions: we use <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code>, to remove observations where the gender of the cyclist is <code>unknown</code>. We also use <code>mutate()</code> for the first time, which allows us to modify or create new variables.</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">ny_trips</span> <span class="op">%&gt;%</span> <span class="co"># Take the ny_trips data frame.</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">gender</span> <span class="op">!=</span> <span class="st">"unknown"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># Filter out rows with the value "unknown" on gender.</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">gender</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># Group by gender.</span>
  <span class="fu">summarise</span><span class="op">(</span>count<span class="op">=</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># Count the number of observations per group.</span>
  <span class="fu">mutate</span><span class="op">(</span>prop<span class="op">=</span><span class="va">count</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># Add a new column called `prop`, divide the value in the row for the variable count by the sum of the count variable across all rows.</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span> <span class="co"># Arrange on the count variable.</span>

<span class="co">## # A tibble: 2 x 3</span>
<span class="co">##  gender   count  prop</span>
<span class="co">##  &lt;chr&gt;    &lt;int&gt; &lt;dbl&gt;</span>
<span class="co">## 1 male   1044621 0.640</span>
<span class="co">## 2 female  586361 0.360</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As I’ve commented each line you hopefully get a sense of what is happening in the code above. I mentioned that <code>dplyr</code> functions read like <em>verbs</em>. This is a very deliberate design decision. With the code laid out as above – each <code>dplyr</code> verb occupying a single line, separated by a pipe (<code>%&gt;%</code>) – you can generally understand the code with a cursory glance. There are obvious benefits to this. Once you become familiar with <code>dplyr</code> it becomes very easy to read, write and share code.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Remembering that <em>pipes</em> (<code>%&gt;%</code>) take the output of a set of code and make it the input of the next set, what do you think would happen if you were to comment out the call to <code>arrange()</code> in the code block above? Try it for yourself. You will notice that I use separate lines for each call to the <em>pipe</em> operator. This is good practice for supporting readability of your code.</p>
</div>
</div>
</section><section id="manipulate-dates-with-lubridate" class="level4" data-number="2.3.3.5"><h4 data-number="2.3.3.5" class="anchored" data-anchor-id="manipulate-dates-with-lubridate">
<span class="header-section-number">2.3.3.5</span> Manipulate dates with <a href="https://lubridate.tidyverse.org/"><code>lubridate</code></a>
</h4>
<p>Let’s continue this investigation of usage by gender, and whether bikeshare might be representative of regular cycling, by profiling how usage varies over time. To do this we will need to work with <code>date-time</code> variables. The <a href="https://lubridate.tidyverse.org/"><code>lubridate</code></a> package provides various convenience functions for this.</p>
<p>In the code block below we extract the <em>day of week</em> and <em>hour of day</em> from the <code>start_time</code> variable using <code>lubridate</code>’s <a href="https://lubridate.tidyverse.org/reference/day.html">day accessor</a> functions. Documentation on these can be accessed in the usual way (<code>?&lt;function-name&gt;</code>), but reading down the code it should be clear to you how this works. Next we count the number of trips made by hour of day, day of week and gender. The summarised data frame will be re-used several times in our analysis, so we store it as an object with a suitable name (<code>ny_temporal</code>) using the assignment operator.</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="co"># Create a hod dow summary by gender and assign it the name "ny_temporal".</span>
<span class="va">ny_temporal</span> <span class="op">&lt;-</span> <span class="va">ny_trips</span> <span class="op">%&gt;%</span>  <span class="co"># Take the ny_trips data frame.</span>
  <span class="fu">mutate</span><span class="op">(</span>
    day<span class="op">=</span><span class="fu">wday</span><span class="op">(</span><span class="va">start_time</span>, label<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, <span class="co"># Create a new column identify dow.</span>
    hour<span class="op">=</span><span class="fu">hour</span><span class="op">(</span><span class="va">start_time</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># Create a new column identify hod.</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">gender</span>, <span class="va">day</span>, <span class="va">hour</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># Group by day, hour, gender.</span>
  <span class="fu">summarise</span><span class="op">(</span>count<span class="op">=</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># Count the grouped rows.</span>
  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Whether or not to store derived data tables, like the newly assigned <code>ny_temporal</code>, in a session is not an easy decision. You want to try to avoid cluttering your Environment pane with many data objects. Often when generating charts it is necessary to create these sorts of derived tables as input data (to <code>ggplot2</code>) – and so when doing visual data analysis you may end up with an unhelpfully large number of these derived tables. A general: if the derived table is to be used &gt;3 times in a data analysis or is computationally intensive, assign it (<code>&lt;-</code>) to an object.</p>
</div>
</div>
<p>In <a href="#fig-plot-temporal">Figure&nbsp;<span>2.2</span></a> below these derived data are plotted. The template contains <code>ggplot2</code> code for creating the graphic. Don’t obsess too much on it – more on this next session. The plot demonstrates a familiar weekday-weekend pattern of usage. Trip frequencies peak in the morning and evening rush hours during weekdays and mid/late-morning and afternoon during weekends. This is consistent with typical travel behaviour. Notice though that the weekday afternoon peak is much larger than the morning peak. There are several speculative explanations for this and re-running the plot on <code>Subscriber</code> users only may be instructive. A secondary observation is that whilst men and women share this overall pattern of usage, the relative number of trips taken by each day of week varies. Men make many more trips at peak times during the start of the week than they do later in the week. The same pattern does not appear for women. This is certainly something to follow up on, for example by collecting data over a longer period of time.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-plot-temporal" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="../../../figs/hod_dow.png" class="img-fluid figure-img"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">Figure 2.2: Line charts generated with <code>ggplot2</code>. Plot data computed using <code>dplyr</code> and <code>lubridate</code>.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Our analysis is based on data from June 2020, a time when New York residents were emerging from lockdown. It would be instructive to compare with data from a non-Covid year. If there is a very clear contrast in usage between this data and a control (non-Covid) year, this suggests bikeshare data may be used for monitoring <em>behavioural change</em>. The fact that bikeshare is collected continuously makes this possible. Check out <a href="https://github.com/jwoLondon/mobv">Jo Wood’s current work</a> analysing Covid-related change in movement behaviours across a range of cities.</p>
</div>
</div>
</section><section id="relate-tables-with-join" class="level4" data-number="2.3.3.6"><h4 data-number="2.3.3.6" class="anchored" data-anchor-id="relate-tables-with-join">
<span class="header-section-number">2.3.3.6</span> Relate tables with <code>join()</code>
</h4>
<p>Trip distance is not recorded directly in the <code>ny_trips</code> table, but may be important for profiling usage behaviour. Calculating trip distance is eminently achievable as the <code>ny_trips</code> table contains the origin and destination station of every trip and the <code>ny_stations</code> table contains coordinates corresponding to those stations. To relate the two tables, we need to specify a <strong>join</strong> between them.</p>
<p>A sensible approach is to:</p>
<ol type="1">
<li>Select all uniquely cycled trip pairs (origin-destination pairs) that appear in the <code>ny_trips</code> table.</li>
<li>Bring in the corresponding coordinate pairs representing the origin and destination stations by joining on the <code>ny_stations</code> table.</li>
<li>Calculate the distance between the coordinate pairs representing the origin and destination.</li>
</ol>
<p>The code below is one way of achieving this.</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">od_pairs</span> <span class="op">&lt;-</span> <span class="va">ny_trips</span> <span class="op">%&gt;%</span> <span class="co"># Take the ny_trips data frame.</span>
<span class="fu">select</span><span class="op">(</span><span class="va">start_station_id</span>, <span class="va">end_station_id</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># Select trip origin and destination (OD) station columns and extract unique OD pairs.</span>
  <span class="fu">left_join</span><span class="op">(</span><span class="va">ny_stations</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="va">stn_id</span>, <span class="va">longitude</span>, <span class="va">latitude</span><span class="op">)</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"start_station_id"</span><span class="op">=</span><span class="st">"stn_id"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># Select lat, lon columns from ny_stations and join on the origin column.</span>
  <span class="fu">rename</span><span class="op">(</span>o_lon<span class="op">=</span><span class="va">longitude</span>, o_lat<span class="op">=</span><span class="va">latitude</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># Rename new lat, lon columns -- associate with origin station.</span>
  <span class="fu">left_join</span><span class="op">(</span><span class="va">ny_stations</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="va">stn_id</span>, <span class="va">longitude</span>, <span class="va">latitude</span><span class="op">)</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"end_station_id"</span><span class="op">=</span><span class="st">"stn_id"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># Select lat, lon columns from ny_stations and join on the destination column.</span>
  <span class="fu">rename</span><span class="op">(</span>d_lon<span class="op">=</span><span class="va">longitude</span>, d_lat<span class="op">=</span><span class="va">latitude</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># Rename new lat, lon columns -- associate with destination station.</span>
  <span class="fu">rowwise</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># For computing distance calculation one row-at-a-time.</span>
  <span class="fu">mutate</span><span class="op">(</span>dist<span class="op">=</span><span class="fu">geosphere</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/geosphere/man/distHaversine.html">distHaversine</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">o_lat</span>, <span class="va">o_lon</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">d_lat</span>, <span class="va">d_lon</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># Calculate distance and express in kms.</span>
  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The code block above introduces some new functions: <code>select()</code> to pick or drop variables, <code>rename()</code> to rename variables and a convenience function for calculating straight line distance from polar coordinates (<code>distHaversine()</code>). The key function to emphasise is the <code>left_join()</code>. If you’ve worked with relational databases and <code>SQL</code>, <code>dplyr</code>’s join functions will be familiar to you. In a <code>left_join</code>, all the values from the main table are retained, the one on the left – <code>ny_trips</code>, and variables from the table on the right (<code>ny_stations</code>) are added. We specify explicitly the variable on which the tables should be joined with the <code>by=</code> parameter, <code>station_id</code> in this case. If there is a <code>station_id</code> in <code>ny_trips</code> that doesn’t exist in <code>ny_stations</code> then <code>NA</code> is returned.</p>
<p>Other <em>join</em> functions provided by <code>dplyr</code> are in the table below. Rather than discussing each, I recommend consulting <a href="https://r4ds.had.co.nz/relational-data.html">Chapter 13</a> of <span class="citation" data-cites="wickham_r_2017">Wickham and Grolemund (<a href="references.html#ref-wickham_r_2017" role="doc-biblioref">2017</a>)</span>.</p>
<div class="cell">
<div class="cell-output-display">
<div id="tbl-table-joins" class="anchored">
<table>
<caption>Table 2.6:  A breakdown of dplyr join functions. </caption>
<thead><tr>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="1"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">`*_join(x, y) ...`</div></th>
<th style="empty-cells: hide;border-bottom:hidden;" colspan="1"></th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;width: 10em; "> `left_join()` </td>
   <td style="text-align:left;"> all rows from x </td>
  </tr>
<tr>
<td style="text-align:left;width: 10em; "> `right_join()` </td>
   <td style="text-align:left;"> all rows from y </td>
  </tr>
<tr>
<td style="text-align:left;width: 10em; "> `full_join()` </td>
   <td style="text-align:left;"> all rows from both x and y </td>
  </tr>
<tr>
<td style="text-align:left;width: 10em; "> `semi_join()` </td>
   <td style="text-align:left;"> all rows from x where there are matching values in y, keeping just columns from x </td>
  </tr>
<tr>
<td style="text-align:left;width: 10em; "> `inner_join()` </td>
   <td style="text-align:left;"> all rows from x where there are matching values in y, return all combination of multiple matches in the case of multiple matches </td>
  </tr>
<tr>
<td style="text-align:left;width: 10em; "> `anti_join` </td>
   <td style="text-align:left;"> return all rows from x where there are not matching values in y, never duplicate rows of x </td>
  </tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-plot-dist" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="../../../figs/dist.png" class="img-fluid figure-img"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">Figure 2.3: Histograms generated with <code>ggplot2</code>. Plot data computed using <code>dplyr</code> and <code>lubridate</code></figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>From the newly created distance variable, we can calculate the average (mean) trip distance for the 1.9m trips – 1.6km. This might seem very short, but remember that the distance calculation is problematic in that these are straight-line distances between pairs of docking stations. Really we should be calculating network distances derived from the cycle network in New York. A separate reason – discovered when generating a histogram on the <code>dist</code> variable – is that there are a large number of trips (124,403) that start and end at the same docking station. Initially these might seem to be unsuccessful hires – people failing to undock a bike for example. We could investigate this further by paying attention to the docking stations at which same origin-destination trips occur, as in the code block below.</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">ny_trips</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">start_station_id</span><span class="op">==</span><span class="va">end_station_id</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">start_station_id</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">summarise</span><span class="op">(</span>count<span class="op">=</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">left_join</span><span class="op">(</span><span class="va">ny_stations</span> <span class="op">%&gt;%</span>  <span class="fu">select</span><span class="op">(</span><span class="va">stn_id</span>, <span class="va">name</span><span class="op">)</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"start_station_id"</span><span class="op">=</span><span class="st">"stn_id"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span>

<span class="co">## # A tibble: 958 x 3</span>
<span class="co">##    start_station_id count name</span>
<span class="co">##    &lt;chr&gt;            &lt;int&gt; &lt;chr&gt;</span>
<span class="co">##  1 ny3423            2017 West Drive &amp; Prospect Park West</span>
<span class="co">##  2 ny3881            1263 12 Ave &amp; W 125 St</span>
<span class="co">##  3 ny514             1024 12 Ave &amp; W 40 St</span>
<span class="co">##  4 ny3349             978 Grand Army Plaza &amp; Plaza St West</span>
<span class="co">##  5 ny3992             964 W 169 St &amp; Fort Washington Ave</span>
<span class="co">##  6 ny3374             860 Central Park North &amp; Adam Clayton Powell Blvd</span>
<span class="co">##  7 ny3782             837 Brooklyn Bridge Park - Pier 2</span>
<span class="co">##  8 ny3599             829 Franklin Ave &amp; Empire Blvd</span>
<span class="co">##  9 ny3521             793 Lenox Ave &amp; W 111 St</span>
<span class="co">## 10 ny2006             782 Central Park S &amp; 6 Ave</span>
<span class="co">## # … with 948 more rows</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>All of the top 10 docking stations are either in parks, near parks or located along river promenades. This coupled with the fact that these trips occur in much greater relative number for casual than regular users (<code>Customer</code> vs <code>Subscriber</code>) is further evidence that these are valid trips.</p>
</section><section id="write-functions-of-your-own" class="level4" data-number="2.3.3.7"><h4 data-number="2.3.3.7" class="anchored" data-anchor-id="write-functions-of-your-own">
<span class="header-section-number">2.3.3.7</span> Write functions of your own</h4>
<p>Through most of the course we will be making use of functions written by others – mainly those developed for packages that form the <code>tidyverse</code> and therefore that follow a consistent syntax. However, there may be times where you need to abstract over some of your code to make functions of your own. <a href="https://r4ds.had.co.nz/functions.html">Chapter 19</a> of <span class="citation" data-cites="wickham_r_2017">Wickham and Grolemund (<a href="references.html#ref-wickham_r_2017" role="doc-biblioref">2017</a>)</span> presents some helpful guidelines around the circumstances under which the data scientist typically tends to write functions. Most often this is when you find yourself copy and pasting the same chunks of code with minimal adaptation.</p>
<p>Functions have three key characteristics:</p>
<ol type="1">
<li>They are (usually) <em>named</em> – the name should be expressive and communicate what the function does (we talk about <code>dplyr</code> <em>verbs</em>).</li>
<li>They have brackets <code>&lt;function()&gt;</code> usually containing <em>arguments</em> – inputs which determine what the function does and returns.</li>
<li>Immediately followed by <code>&lt;function()&gt;</code> are <code><a href="https://rdrr.io/r/base/Paren.html">{}</a></code> used to contain the <strong>body</strong> – in this is code that performs a distinct task, described by the function’s <em>name</em>.</li>
</ol>
<p>Effective functions are <em>short</em>, perform <em>single</em> discrete operations and are <em>intuitive</em>.</p>
<p>You will recall that in the <code>ny_trips</code> table there is a variable called <code>birth_year</code>. From this we can derive cyclists’ approximate age. Below I have written a function <code>get_age()</code> for doing this. The function expects two <em>arguments</em>: <code>yob</code> – a year of birth as type <code>chr</code>; <code>yref</code> – a reference year. In the <em>body</em>, <code>lubridate</code>’s <code>as.period</code> function is used to calculate the time in years that elapsed, the value that the function <em>returns</em>. Once defined, and loaded into the session by being executed, it can be used (as below).</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="co"># Function for calculating time elapsed between two dates in years (age).</span>
<span class="va">get_age</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">yob</span>, <span class="va">yref</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">period</span> <span class="op">&lt;-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/as.period.html">as.period</a></span><span class="op">(</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html">interval</a></span><span class="op">(</span><span class="va">yob</span>, <span class="va">yref</span><span class="op">)</span>,unit <span class="op">=</span> <span class="st">"year"</span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">period</span><span class="op">$</span><span class="va">year</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">ny_trips</span> <span class="op">&lt;-</span> <span class="va">ny_trips</span> <span class="op">%&gt;%</span> <span class="co"># Take the ny_trips data frame.</span>
  <span class="fu">mutate</span><span class="op">(</span>
    age<span class="op">=</span><span class="fu">get_age</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="va">birth_year</span>, format<span class="op">=</span><span class="st">"%Y"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"2020"</span>, format<span class="op">=</span><span class="st">"%Y"</span><span class="op">)</span><span class="op">)</span> <span class="co"># Calculate age from birth_date.</span>
    <span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can use the two new derived variables – distance travelled and age – in our analysis. In Figure @ref(fig:plot-speeds), we explore how <strong>approximate</strong> travel speeds vary by age, gender and trip distance. The code used to generate the summary data and plot is in the template file. Again the average “speed” calculation should be treated very cautiously as it is based on straight line distances and it is very difficult to select out “utility” from “leisure” trips. I have tried to do the latter by selecting trips that occur only on weekdays and that are made by <code>Subscriber</code> cyclists. Additionally, due to the heavy subsetting data become a little volatile for certain age groups and so I’ve aggregated the age variable into 5-year bands. Collecting more data is probably a good idea.</p>
<p>There are nevertheless some interesting patterns. Men tend to cycle at faster speeds than do women, although this gap narrows with the older age groups. The effect of age on speed cycled is more apparent for the longer trips. This trend is reasonably strong, although the volatility in the older age groups for trips &gt;4.5km suggests we probably need more data and a more involved analysis to establish this. For example, it may be that the comparatively rare occurrence of trips in the 65-70 age group is made by only a small subset of cyclists. A larger dataset would result in a regression to the mean effect and negate any noise caused by outlier individuals. Certainly Figure @ref(tab:variable-types) is an interesting data graphic – and the type of exploratory analysis demonstrated here, using <code>dplyr</code> functions, is most definitely consistent with that identified in the previous session when introducing <em>Social Data Science</em>.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-plot-speeds" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="../../../figs/speeds.png" class="img-fluid figure-img"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">Figure 2.4: Line charts generated with <code>ggplot2</code>. Plot data computed using <code>dplyr</code> and <code>lubridate</code>.</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section></section><section id="tidy" class="level3" data-number="2.3.4"><h3 data-number="2.3.4" class="anchored" data-anchor-id="tidy">
<span class="header-section-number">2.3.4</span> Tidy</h3>
<p>The <code>ny_trips</code> and <code>ny_stations</code> data already comply with the rules for <strong>tidy</strong> data <span class="citation" data-cites="wickham_tidy_2014">(<a href="references.html#ref-wickham_tidy_2014" role="doc-biblioref">Wickham 2014</a>)</span>. Each row in <code>ny_trips</code> is a distinct trip and each row in <code>ny_stations</code> a distinct station. However throughout the course we will undoubtedly encounter datasets that need to be reshaped. There are two key functions to learn here, made available via the <a href="https://tidyr.tidyverse.org/articles/pivot.html"><code>tidyr</code></a> package: <a href="https://tidyr.tidyverse.org/reference/pivot_longer.html"><code>pivot_longer()</code></a> and <a href="https://tidyr.tidyverse.org/reference/pivot_wider.html"><code>pivot_wider()</code></a>. <code>pivot_longer()</code> is used to tidy data in which observations are spread across columns, as in Table @ref(tab:gapminder-untidy1) (the <code>gapminder</code> dataset). <code>pivot_wider()</code> is used to tidy data in which observations are spread across rows, as in Table <span class="quarto-unresolved-ref">?tbl-gapminder-untidy2</span> (the <code>gapminder</code> dataset). You will find yourself using these functions, particularly <code>pivot_longer()</code>, not only for fixing messy data, but for flexibly reshaping data for use in <code>ggplot2</code> specifications (more on this in Chapter <a href="03-visual.html"><span>3</span></a> and <a href="04-explore.html"><span>4</span></a>) or joining tables.</p>
<p>A quick breakdown of <code>pivot_longer</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu">pivot_longer</span><span class="op">(</span>
  <span class="va">data</span>,
  <span class="va">cols</span>, <span class="co"># Columns to pivot longer (across rows).</span>
  names_to<span class="op">=</span><span class="st">"name"</span>, <span class="co"># Name of the column to create from values held in spread *column names*.</span>
  values_to<span class="op">=</span><span class="st">"name"</span> <span class="co"># Name of column to create form values stored in spread *cells*</span>
  <span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A quick breakdown of <code>pivot_wider</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu">pivot_wider</span><span class="op">(</span>
  <span class="va">data</span>,
  <span class="va">names_from</span>, <span class="co"># Column in the long format which contains what will be column names in the wide format.</span>
  <span class="va">values_from</span> <span class="co"># Column in the long format which contains what will be values in the new wide format.</span>
  <span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the homework you will be tidying some messy derived tables based on the bikeshare data using both of these functions, but we can demonstrate their purpose in <em>tidying</em> the messy <code>gapminder</code> data in Table <span class="quarto-unresolved-ref">?tbl-gapminder-untidy2</span>. Remember that these data were messy as the observations by gender were spread across the columns:</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">untidy_wide</span>
<span class="co">##   country     year  f_cases m_cases f_population m_population</span>
<span class="co">##   &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;        &lt;chr&gt;</span>
<span class="co">## 1 Afghanistan 1999  447     298     9993400      9993671</span>
<span class="co">## 2 Afghanistan 2000  1599    1067    10296280     10299080</span>
<span class="co">## 3 Brazil      1999  16982   20755   86001181     86005181</span>
<span class="co">## 4 Brazil      2000  39440   41048   87251329     87253569</span>
<span class="co">## 5 China       1999  104007  108252  636451250    636464022</span>
<span class="co">## 6 China       2000  104746  109759  640212600    640215983</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First we need to gather the problematic columns with <code>pivot_longer()</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">untidy_wide</span> <span class="op">%&gt;%</span>
  <span class="fu">pivot_longer</span><span class="op">(</span>cols<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">f_cases</span><span class="op">:</span> <span class="va">m_population</span><span class="op">)</span>, names_to<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gender_count_type"</span><span class="op">)</span>, values_to<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"counts"</span><span class="op">)</span><span class="op">)</span>

<span class="co">##   country     year  gender_count_type       counts</span>
<span class="co">##   &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt;                   &lt;chr&gt;</span>
<span class="co">##  1 Afghanistan 1999  f_cases                447</span>
<span class="co">##  2 Afghanistan 1999  m_cases                298</span>
<span class="co">##  3 Afghanistan 1999  f_population           9993400</span>
<span class="co">##  4 Afghanistan 1999  m_population           9993671</span>
<span class="co">##  5 Afghanistan 2000  f_cases                1599</span>
<span class="co">##  6 Afghanistan 2000  m_cases                1067</span>
<span class="co">##  7 Afghanistan 2000  f_population           10296280</span>
<span class="co">##  8 Afghanistan 2000  m_population           10299080</span>
<span class="co">##  9 Brazil      1999  f_cases                16982</span>
<span class="co">## 10 Brazil      1999  m_cases                20755</span>
<span class="co">## # … with 14 more rows</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So this has usefully collapsed the dataset by gender, we now have a problem similar to that in Table <span class="quarto-unresolved-ref">?tbl-gapminder-untidy1</span> where observations are spread across the rows – in this instance <code>cases</code> and <code>population</code> are better treated as separate variables. This can be fixed by <code>separating</code> the <code>gender_count_type</code> variables and then spreading the values of the new <code>count_type</code> (<code>cases</code>, <code>population</code>) across the columns. Hopefully you can see how this gets us to the <em>tidy</em> <code>gapminder</code> data structure in Table <span class="quarto-unresolved-ref">?tbl-gapminder-tidy</span>.</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">untidy_wide</span> <span class="op">%&gt;%</span>
  <span class="fu">pivot_longer</span><span class="op">(</span>cols<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">f_cases</span><span class="op">:</span> <span class="va">m_population</span><span class="op">)</span>, names_to<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gender_count_type"</span><span class="op">)</span>, values_to<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"counts"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">separate</span><span class="op">(</span>col<span class="op">=</span><span class="va">gender_count_type</span>, into<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gender"</span>, <span class="st">"count_type"</span><span class="op">)</span>, sep<span class="op">=</span><span class="st">"_"</span><span class="op">)</span>

<span class="co">##    country     year  gender count_type counts</span>
<span class="co">##    &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;      &lt;chr&gt;</span>
<span class="co">##  1 Afghanistan 1999  f      cases      447</span>
<span class="co">##  2 Afghanistan 1999  m      cases      298</span>
<span class="co">##  3 Afghanistan 1999  f      population 9993400</span>
<span class="co">##  4 Afghanistan 1999  m      population 9993671</span>
<span class="co">##  5 Afghanistan 2000  f      cases      1599</span>
<span class="co">##  6 Afghanistan 2000  m      cases      1067</span>
<span class="co">##  7 Afghanistan 2000  f      population 10296280</span>
<span class="co">##  8 Afghanistan 2000  m      population 10299080</span>
<span class="co">##  9 Brazil      1999  f      cases      16982</span>
<span class="co">## 10 Brazil      1999  m      cases      20755</span>
<span class="co">## # … with 14 more rows</span>

<span class="va">untidy_wide</span> <span class="op">%&gt;%</span>
  <span class="fu">pivot_longer</span><span class="op">(</span>cols<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">f_cases</span><span class="op">:</span> <span class="va">m_population</span><span class="op">)</span>, names_to<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gender_count_type"</span><span class="op">)</span>, values_to<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"counts"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">separate</span><span class="op">(</span>col<span class="op">=</span><span class="va">gender_count_type</span>, into<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gender"</span>, <span class="st">"count_type"</span><span class="op">)</span>, sep<span class="op">=</span><span class="st">"_"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">pivot_wider</span><span class="op">(</span>names_from<span class="op">=</span><span class="va">count_type</span>, values_from<span class="op">=</span><span class="va">counts</span><span class="op">)</span>

<span class="co">##    country     year  gender cases  population</span>
<span class="co">##    &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;</span>
<span class="co">##  1 Afghanistan 1999  f      447    9993400</span>
<span class="co">##  2 Afghanistan 1999  m      298    9993671</span>
<span class="co">##  3 Afghanistan 2000  f      1599   10296280</span>
<span class="co">##  4 Afghanistan 2000  m      1067   10299080</span>
<span class="co">##  5 Brazil      1999  f      16982  86001181</span>
<span class="co">##  6 Brazil      1999  m      20755  86005181</span>
<span class="co">##  7 Brazil      2000  f      39440  87251329</span>
<span class="co">##  8 Brazil      2000  m      41048  87253569</span>
<span class="co">##  9 China       1999  f      104007 636451250</span>
<span class="co">## 10 China       1999  m      108252 636464022</span>
<span class="co">## 11 China       2000  f      104746 640212600</span>
<span class="co">## 12 China       2000  m      109759 640215983</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="conclusions" class="level2" data-number="2.4"><h2 data-number="2.4" class="anchored" data-anchor-id="conclusions">
<span class="header-section-number">2.4</span> Conclusions</h2>
<p>Developing the vocabulary and technical skills to systematically describe and organise data is crucial to modern data analysis. This chapter has covered the fundamentals here: that data consist of <em>observations</em> and <em>variables</em> of different types <span class="citation" data-cites="stevens_on_1946">(<a href="references.html#ref-stevens_on_1946" role="doc-biblioref">Stevens 1946</a>)</span> and that in order to work effectively with datasets, especially in a functional way in <code>R</code>, these data must be organised according to the rules of <em>tidy</em> data <span class="citation" data-cites="wickham_tidy_2014">(<a href="references.html#ref-wickham_tidy_2014" role="doc-biblioref">Wickham 2014</a>)</span>. Most of the content was dedicated to the techniques that enable these concepts to be operationalised. We covered how to download, transform and reshape a reasonably large set of data from New York’s <a href="">Citibike</a> scheme. In doing so, we generated insights that might inform further data collection and analysis activity. In the next chapter we will apply and extend this conceptual and technical knowledge as we introduce the fundamentals of visual data analysis and <code>ggplot2</code>’s grammar of graphics.</p>


</section><div id="quarto-appendix" class="default page-columns page-full"><section class="footnotes footnotes-end-of-document page-columns page-full" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading column-leftmargin">Footnotes</h2>
<ol>
<li id="fn1" role="doc-endnote"><p>Note that the version of the trips data downloaded from my external repo contains a sample of just 500k records – this is not ideal, but was due to data storage limits on my external repo.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></div></main><!-- /main --><script type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    setTimeout(function() {
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./01-intro.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./03-visual.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Visualization Fundamentals</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->


</body></html>