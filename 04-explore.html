<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Visualization for Social Data Science - 4&nbsp; Exploratory Data Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./05-network.html" rel="next">
<link href="./03-visual.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="site_libs/kePrint-0.0.1/kePrint.js"></script><link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script><script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script><script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">
<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./04-explore.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Exploratory Data Analysis</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Visualization for Social Data Science</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/vis4sds/vis4sds/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Fundamentals</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-visual.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Visualization Fundamentals</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-explore.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Exploratory Data Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-network.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Geographic Networks</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-model.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-uncertainty.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Uncertainty</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-storytelling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Visual Storytelling</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./a1-tasks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Task answers</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">4.1</span> Introduction</a></li>
  <li>
<a href="#concepts" id="toc-concepts" class="nav-link" data-scroll-target="#concepts"><span class="header-section-number">4.2</span> Concepts</a>
  <ul class="collapse">
<li><a href="#exploratory-data-analysis-and-statistical-graphics" id="toc-exploratory-data-analysis-and-statistical-graphics" class="nav-link" data-scroll-target="#exploratory-data-analysis-and-statistical-graphics"><span class="header-section-number">4.2.1</span> Exploratory data analysis and statistical graphics</a></li>
  <li><a href="#plots-for-continuous-variables" id="toc-plots-for-continuous-variables" class="nav-link" data-scroll-target="#plots-for-continuous-variables"><span class="header-section-number">4.2.2</span> Plots for continuous variables</a></li>
  <li><a href="#plots-for-categorical-variables" id="toc-plots-for-categorical-variables" class="nav-link" data-scroll-target="#plots-for-categorical-variables"><span class="header-section-number">4.2.3</span> Plots for categorical variables</a></li>
  <li><a href="#strategies-for-supporting-comparison" id="toc-strategies-for-supporting-comparison" class="nav-link" data-scroll-target="#strategies-for-supporting-comparison"><span class="header-section-number">4.2.4</span> Strategies for supporting comparison</a></li>
  </ul>
</li>
  <li>
<a href="#techniques" id="toc-techniques" class="nav-link" data-scroll-target="#techniques"><span class="header-section-number">4.3</span> Techniques</a>
  <ul class="collapse">
<li><a href="#import" id="toc-import" class="nav-link" data-scroll-target="#import"><span class="header-section-number">4.3.1</span> Import</a></li>
  <li><a href="#sample" id="toc-sample" class="nav-link" data-scroll-target="#sample"><span class="header-section-number">4.3.2</span> Sample</a></li>
  <li><a href="#abstract-and-relate" id="toc-abstract-and-relate" class="nav-link" data-scroll-target="#abstract-and-relate"><span class="header-section-number">4.3.3</span> Abstract and relate</a></li>
  <li><a href="#model-and-residual-pass-1" id="toc-model-and-residual-pass-1" class="nav-link" data-scroll-target="#model-and-residual-pass-1"><span class="header-section-number">4.3.4</span> Model and residual: Pass 1</a></li>
  <li><a href="#model-and-residual-pass-2" id="toc-model-and-residual-pass-2" class="nav-link" data-scroll-target="#model-and-residual-pass-2"><span class="header-section-number">4.3.5</span> Model and residual: Pass 2</a></li>
  </ul>
</li>
  <li><a href="#conclusions" id="toc-conclusions" class="nav-link" data-scroll-target="#conclusions"><span class="header-section-number">4.4</span> Conclusions</a></li>
  <li><a href="#further-reading" id="toc-further-reading" class="nav-link" data-scroll-target="#further-reading"><span class="header-section-number">4.5</span> Further Reading</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="sec-explore" class="quarto-section-identifier"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Exploratory Data Analysis</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p>By the end of this chapter you should gain the following knowledge and practical skills.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Knowledge outcomes
</div>
</div>
<div class="callout-body-container callout-body">
<ul class="task-list">
<li><label><input type="checkbox">Understand how data graphics can support exploratory data analysis (EDA).</label></li>
<li><label><input type="checkbox">The main chart types, their benefits and drawbacks, for analysing variation within- and between- variables.</label></li>
<li><label><input type="checkbox">Three strategies for effecting comparison in EDA – juxtaposition, superposition and explicit encoding <span class="citation" data-cites="gleicher_visual_2011">(<a href="references.html#ref-gleicher_visual_2011" role="doc-biblioref">Gleicher and Roberts 2011</a>)</span> – and the role of models in elevating comparisons by codifying expectation.</label></li>
<li><label><input type="checkbox">Appreciate that EDA <em>is</em> scientific practice: knowledge is developed in light of data and models.</label></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Skills outcomes
</div>
</div>
<div class="callout-body-container callout-body">
<ul class="task-list">
<li><label><input type="checkbox">ggplot2 code that applies encodings and layouts to support comparison.</label></li>
<li><label><input type="checkbox"><code>tidyverse</code>-style code for calculating model-expected values and residuals.</label></li>
</ul>
</div>
</div>
<section id="introduction" class="level2" data-number="4.1"><h2 data-number="4.1" class="anchored" data-anchor-id="introduction">
<span class="header-section-number">4.1</span> Introduction</h2>
<p> Exploratory Data Analysis (EDA) is an approach that aims to expose the properties and structure of a dataset, and from here suggest analysis directions. In an EDA relationships are quickly inferred, anomalies labelled, models suggested and evaluated. EDA relies heavily on visual approaches to analysis; it is common to generate many dozens of often throwaway data graphics when exploring a dataset for the first time.</p>
<p>This chapter demonstrates how the concepts and principles introduced previously, of data types and their visual encoding, can be applied to support EDA. It does so by analysing STATS19, a dataset containing detailed information on every reported road traffic crash in Great Britain that resulted in personal injury. STATS19 is highly detailed, with many categorical variables. The chapter starts by revisiting commonly used chart types for analysing within-variable variation and between-variable co-variation in a dataset. It then focuses more directly on the STATS19 case, and how detailed comparison across many categorical variables can be effected using colour, layout and statistical computation.</p>
</section><section id="concepts" class="level2" data-number="4.2"><h2 data-number="4.2" class="anchored" data-anchor-id="concepts">
<span class="header-section-number">4.2</span> Concepts</h2>
<section id="exploratory-data-analysis-and-statistical-graphics" class="level3" data-number="4.2.1"><h3 data-number="4.2.1" class="anchored" data-anchor-id="exploratory-data-analysis-and-statistical-graphics">
<span class="header-section-number">4.2.1</span> Exploratory data analysis and statistical graphics</h3>
<!-- > The simple graph has brought more information to the data analyst's mind than any other device.
>
> John Tukey -->
<p>In Exploratory Data Analysis (EDA), graphical and statistical summaries are used to build knowledge and understanding of a dataset. The goal of EDA is to infer relationships, identify anomalies and test new ideas and hypotheses. Rather than a formal set of techniques, EDA should be considered a sort of outlook to analysis. It aims to reveal properties, patterns and relationships in a dataset, and from there expectations, codified via models, to be further investigated in context via more targeted data graphics and statistics.</p>
<p>The early stages of an EDA may be very data-driven. Datasets are described abstractly according to their measurement level and corresponding data graphics and summary statistics generated from these descriptions (e.g.&nbsp;<span><a href="#tbl-variable-types-explore" class="quarto-xref">Table&nbsp;<span>4.1</span></a></span> ). As knowledge and understanding of the dataset increases, researchers might apply more targeted theory and prior knowledge when developing and evaluating models.</p>
<p>Visual approaches play an important role in both these stages of analysis. For example, when first examining variables according to their shape and location, data graphics help identify patterns that statistical summaries miss, such as whether variables are multi-modal, the extent and direction of outliers. When more specialised models are proposed graphical summaries can add important detail around where, and by how much, the observed data depart from the model. It is for this reason that data visualization is seen as intrinsic to EDA <span class="citation" data-cites="tukey_exploratory_1977">(<a href="references.html#ref-tukey_exploratory_1977" role="doc-biblioref">Tukey 1977</a>)</span>.</p>
<!-- @wickham_r_2017 identify two initial questions that an EDA should address:

1. What type of *variation* occurs *within* variables of a dataset?
2. What type of *covariation* occurs *between* variables of a dataset?

When summarising within-variable variation, we are interested in a variable's spread or dispersion and its location within this distribution (central tendency). Different statistics can be applied, and an important choice is between measures of central tendency that are or are not robust to outliers -- e.g. mode and median versus mean. Decisions around which statistic to use also depend on a variable's measurement-level (e.g. @tbl-variable-types). For example, linear correlation statistics are applied when studying between-variable covariation in variables measured on interval and ratio scales, but other statistics, such as odds ratios and chi-square tests are commonly used when studying covariation in categorical data. It is also important to consider the limits to statistical summaries. None of the measures of central tendency in @tbl-variable-types would expose whether a variable for instance is multi-modal and only when studying all measures of central tendency and  dispersion together might it be possible to guess at the presence of outliers that could undermine statistical assumptions. It is for this reason that data visualization is seen as intrinsic to EDA [@tukey_exploratory_1977]. -->
<!-- 

::: {#tbl-variable-types-explore-tex .cell tbl-cap='A breakdown of statistical and graphical summaries performed in EDA based on variable measurement types.'}

:::

-->
<div class="cell">
<div id="tbl-variable-types-explore" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-variable-types-explore-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;4.1: A breakdown of statistical and graphical summaries performed in EDA based on variable measurement types.
</figcaption><div aria-describedby="tbl-variable-types-explore-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div>
<table class="do-not-create-environment cell table table-sm table-striped small" data-quarto-postprocess="true">
<thead><tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">Measurement type</th>
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">Statistic</th>
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">Chart type</th>
</tr></thead>
<tbody>
<tr class="odd" data-grouplength="3">
<td colspan="3" style="border-bottom: 0px solid">Within-variable variation</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em; width: 8em; width: 30%; font-family: Monospace;" data-indentlevel="1">Nominal</td>
<td style="text-align: left; width: 30%;">mode | entropy</td>
<td style="text-align: left;">bar charts, dot plots ...</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em; width: 8em; width: 30%; font-family: Monospace;" data-indentlevel="1">Ordinal</td>
<td style="text-align: left; width: 30%;">median | percentile</td>
<td style="text-align: left;">bar charts, dot plots ...</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em; width: 8em; width: 30%; font-family: Monospace;" data-indentlevel="1">Continuous</td>
<td style="text-align: left; width: 30%;">mean | variance</td>
<td style="text-align: left;">histograms, box plots, density plots ...</td>
</tr>
<tr class="odd" data-grouplength="3">
<td colspan="3" style="border-bottom: 0px solid">Between-variable variation</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em; width: 8em; width: 30%; font-family: Monospace;" data-indentlevel="1">Nominal</td>
<td style="text-align: left; width: 30%;">contingency tables</td>
<td style="text-align: left;">mosaic/spine plots ...</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em; width: 8em; width: 30%; font-family: Monospace;" data-indentlevel="1">Ordinal</td>
<td style="text-align: left; width: 30%;">rank correlation</td>
<td style="text-align: left;">slope/bump charts ...</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em; width: 8em; width: 30%; font-family: Monospace;" data-indentlevel="1">Continuous</td>
<td style="text-align: left; width: 30%;">correlation</td>
<td style="text-align: left;">scatterplots, parallel coordinate plots ...</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</figure>
</div>
</div>
<p></p>
</section><section id="plots-for-continuous-variables" class="level3" data-number="4.2.2"><h3 data-number="4.2.2" class="anchored" data-anchor-id="plots-for-continuous-variables">
<span class="header-section-number">4.2.2</span> Plots for continuous variables</h3>
<section id="within-variable-variation" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="within-variable-variation">Within-variable variation</h4>
<p><a href="#fig-univariate-continuous" class="quarto-xref">Figure&nbsp;<span>4.1</span></a> presents statistical graphics that are commonly used to show variation in continuous variables measured on a ratio and interval scale. In this instance, the graphics summarise the age of pedestrians injured (<code>casualty_age</code>) for a random sample of recorded road crashes. </p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-univariate-continuous" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-univariate-continuous-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/04/univariate-plots.png" class="img-fluid figure-img" style="width:85.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-univariate-continuous-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.1: Univariate plots of dispersion in casualty ages from a sample of pedestrian-vehicle road crashes.
</figcaption></figure>
</div>
</div>
</div>
<!-- ![Univariate plots of dispersion.](figs/04/univariate-plots.svg){#fig-univariate-continuous width=100% fig-align="center"} -->
<p> In the left-most column is a <em>strip-plot</em>. Every observation is displayed as a dot and mapped to <code>y-position</code>, with dots horizontally perturbed and made a little transparent. Although strip-plots scale poorly, the advantage is that all observations are displayed without needing to impose some aggregation. It is possible to visually identify the ‘location’ of the distribution – denser dots towards the youngest ages (c.20 years) – but also that there is spread across the age values.</p>
<p> <em>Histograms</em> partition observations into equal-range bins and observations in each bin are counted. These counts are encoded on an aligned scale using bar length. Increasing the number of the bins increases the resolution of the graphical summary. If reasonable decisions are made around choice of bin, histograms give distributions a shape that is expressive. It is easy to identify the location of a distribution, to see that it is uni - bi- or multi-modal. Different from the strip-plot, the histogram shows that despite the heavy spread, the distribution of <code>casualty_age</code> is right-skewed, and we’d expect this given the location of the mean (36 years) relative to the median (30 years).</p>
<p> A problem with histograms is the potential for discontinuities and artificial edge-effects around the bins. <em>Density plots</em> overcome this and can be thought of as smoothed histograms. They show the probability density function of a variable – the relative amount of probability attached to each value of <code>casualty_age</code>. From glancing at the density plots an overall shape to the distribution can be immediately derived. It is also possible to infer statistical properties – the mode of the distribution, the peak density, the mean and median – by a sort of visual averaging and approximating the midpoint of the area under the curve.</p>
<p><!-- Density plots are better suited to datasets that contain a reasonably large number of observations. --> Finally, <em>boxplots</em> <span class="citation" data-cites="mcgill_variations_1978">(<a href="references.html#ref-mcgill_variations_1978" role="doc-biblioref">McGill and Larsen 1978</a>)</span> encode these statistical properties directly. The box is the interquartile range (IQR) of the <code>casualty_age</code> variable, the vertical line splitting the box is the median, and the whiskers are placed at observations <span class="math inline">\leq 1.5*</span>IQR. While we lose important information around the shape of a distribution, boxplots are space-efficient and useful for comparing many distributions at once.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Inequalities in who-hit-whom (by age)
</div>
</div>
<div class="callout-body-container callout-body">
<p></p>
<p>Since the average age of pedestrian road casualties is surprisingly low, it may be instructive to explore the distribution of <code>casualty_age</code> conditioning on another variable differentiated using colour. <a href="#fig-boxplots-class" class="quarto-xref">Figure&nbsp;<span>4.2</span></a> displays boxplots and density plots of the location and spread in <code>casualty_age</code> by vehicle and individual for all crashes involving pedestrians. A noteworthy pattern is that riders of bicycles and motorcycles tend to be younger than the pedestrians they collide with, whereas for buses, taxis, HGVs and cars the reverse is true.</p>
<!-- Although less space efficient, the density plots display richer information around the nature of the driver-pedestrian age distributions. -->
<div class="cell">
<div class="cell-output-display">
<div id="fig-boxplots-class" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-boxplots-class-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/04/boxplot-by-class.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-boxplots-class-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.2: Boxplots of casualty age by vehicle and individual type (driver or pedestrian).
</figcaption></figure>
</div>
</div>
</div>
<!-- ![Boxplots of casualty age by vehicle type and class.](figs/04/boxplot-by-class.svg){#fig-boxplots-class width=100% fig-align="center"} -->
<p></p>
</div>
</div>
</section><section id="between-variable-variation" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="between-variable-variation">Between-variable variation</h4>
<p> The previous chapter included several scatterplots for exploring associations in electoral voting behaviour. Scatterplots are used to check whether the association between variables is linear, but also to make inferences about the direction and intensity of linear correlation between variables – the extent to which values in one variable depend on the values of another – and the nature of variation between variables – the extent to which variation in one variable depends on another. In an EDA it is common to quickly compare associations between many quantitive variables in a dataset using scatterplot matrices or, less often, parallel coordinate plots. There are few variables in the STATS19 dataset measured on a continuous scale, but in Chapter <a href="06-model.html" class="quarto-xref"><span>6</span></a> we will use both scatterplot matrices and parallel coordinate plots when building models that attempt to structure and explain between-variable covariation, again on an electoral voting dataset.</p>
<!-- There are few variables in the STATS19 dataset measured on a continuous scale, and so no .  -->
<!-- There are few variables in the STATS19 dataset measured on a continuous scale, but based on the analysis above, we may wish to explore more directly whether an association exists between the age of pedestrians and drivers for pedestrian-vehicle crashes. The scatterplots in @fig-scatters-type show that no obvious linear association exists. -->
<!-- ![Scatterplots of pedestrian age by driver age and grouped by vehicle type.](figs/04/scatter-by-type.svg){#fig-scatters-age-class width=100% fig-align="center"} -->
<!-- ::: {.callout-note}
It is common in an EDA to quickly compare associations between many quantitive variables in a dataset using [scatterplot matrices](https://en.wikipedia.org/wiki/Scatter_plot#Scatter_plot_matrices) or alternatively [parallel coordinate plots](https://en.wikipedia.org/wiki/Parallel_coordinates). We will use both in chapters 6 and 7 when building  models that attempt to formally structure and explain between-variable covariation.
::: -->
</section></section><section id="plots-for-categorical-variables" class="level3" data-number="4.2.3"><h3 data-number="4.2.3" class="anchored" data-anchor-id="plots-for-categorical-variables">
<span class="header-section-number">4.2.3</span> Plots for categorical variables</h3>
<section id="within-variable-variation-1" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="within-variable-variation-1">Within-variable variation</h4>
<p> For categorical variables, within-variable variation is judged on how relative frequencies distribute across the variable’s categories. Bar charts are commonly used, as bar length is effective at encoding frequency. When analysing variation across several categories it is useful to flip bar charts on their side so that category labels can be easily scanned and, unless there is a natural ordering, arrange the bars in descending order based on their frequency. This is demonstrated in <a href="#fig-bars" class="quarto-xref">Figure&nbsp;<span>4.3</span></a>, which shows the frequencies with which different vehicles types are involved in pedestrian casualties.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-bars" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-bars-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/04/bars.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-bars-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.3: Bars displaying crash frequencies by vehicle type.
</figcaption></figure>
</div>
</div>
</div>
<!-- ![Bars displaying crash frequencies by vehicle type.](figs/04/bars.svg){#fig-bars width=100% fig-align="center"} -->
<!-- Bar charts are effective at conveying frequencies  where the number of categories is reasonably small. -->
<p> For summarising frequencies across many categories alternative chart types that minimise non-data-ink, such as dot plots, may be appropriate. The left plot in <a href="#fig-dots-heatmap" class="quarto-xref">Figure&nbsp;<span>4.4</span></a> displays pedestrian crash counts for boroughs in London, ordered by crash frequency, grouped by whether boroughs are in inner- or outer- London and coloured on whether crashes took place on weekdays or weekends. Lines connecting dots emphasise the differences in absolute numbers between time periods. Although a consistent pattern is of greater crash counts during weekdays, the gap is less obvious for outer London boroughs; there may be relatively more pedestrian crashes occurring in central London boroughs during weekdays. The second graphic is a heatmap with the same ordering and grouping of boroughs, but with columns coloured according to crash frequencies by vehicle type, further grouped by weekday and weekend times. Remembering <span class="citation" data-cites="munzner_visualization_2014">Munzner (<a href="references.html#ref-munzner_visualization_2014" role="doc-biblioref">2014</a>)</span>’s ordering of visual channels, we trade-off some precision in estimation when encoding frequencies in heatmaps. A greater difficulty, irrespective of encoding channel, comes from the dominance of cars and weekdays; variation between vehicle types and time periods outside of this is almost imperceptible.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-dots-heatmap" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-dots-heatmap-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/04/borough-freqs.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dots-heatmap-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.4: Cleveland dot plots and heatmaps summarising crash frequencies by London borough, period of day and vehicle type.
</figcaption></figure>
</div>
</div>
</div>
<!-- ::: {.callout-note}
Remembering @munzner_visualization_2014's ordering of visual channels, Cleveland dot plots, which use position on an aligned scale, are far better at encoding quantities than heatmaps, which use colour value. Stevens's power estimates for the perception of changes in lightness were $n~0.5$. Despite this, I think the heatmap in @fig-dots-heatmap) is a successful data graphic. It displays 924 values in a reasonably compact space with cells arranged to emphasise comparison. This illustrates the point raised in the previous session around the trade-offs that must be negotiated when designing graphics for analysis. In this case we trade encoding effectiveness for data density.
::: -->
</section><section id="between-variable-covariation-standardised-bars-and-mosaic-plots" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="between-variable-covariation-standardised-bars-and-mosaic-plots">Between-variable covariation: standardised bars and mosaic plots</h4>
<!-- To study the association *between* two categorical variables, [contingency tables](https://en.wikipedia.org/wiki/Contingency_table) are routinely used. Each cell in a contingency table is the joint frequency of two category outcomes occurring together. The contingency table below (@tbl-vehicle-severity) looks at how crashes by vehicle type co-vary with injury severity. The question being posed is:

* Are crashes involving certain vehicles associated with more/less severe injury than others?

The table presents counts by injury severity for pedestrians only; so these are pedestrians being hit by cars, vans, bicycles etc. Injury severity is either *slight* or serious/fatal (*KSI*). -->
<p>In <a href="#fig-dots-heatmap" class="quarto-xref">Figure&nbsp;<span>4.4</span></a> we began to make between-category comparison; we asked whether there are relatively more or fewer crashes by time period or vehicle type in certain boroughs than others. There are chart types that explicitly support these sorts of analysis tasks. <a href="#fig-bars-vehicle-injury" class="quarto-xref">Figure&nbsp;<span>4.5</span></a> compares pedestrian crash frequencies in London by vehicle type involved and whether the crash occurred on weekdays or weekends.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-bars-vehicle-injury" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-bars-vehicle-injury-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/04/bars-assoc.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-bars-vehicle-injury-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.5: Bars and mosaic plot displaying association between vehicle type and injury severity.
</figcaption></figure>
</div>
</div>
</div>
<p> First, stacked bars are ordered by frequency, distinguishing time period using colour lightness. Cars are by far the dominant travel mode, contributing the largest number of crashes resulting in injury to pedestrians. Whether or not pedestrian injuries involving cars occur more on weekends than other modes is not clear from the left-most chart. Length encodes absolute crash counts effectively but relative comparison on time periods between vehicle types is challenging. In standardised bars the absolute length of bars is fixed and bars are split according to proportional weekday / weekend crashes (middle). The plot is also annotated according to the <em>expected proportion</em> of weekday crashes if crashes occurred by time period independently of vehicle type (22%). This encoding shows pedestrian crashes involving taxis occur more than would be expected at weekends, while the reverse is true of crashes involving vans, bikes and HGVs. However, we lose a sense of the absolute numbers involved.</p>
<p>Failing to encode absolute number – the amount of information in support of some observed pattern – is a problem in EDA. Since proportional summaries are agnostic to sample size, they can induce false discoveries, overemphasising patterns that may be unlikely to replicate in out-of-sample tests. It is sometimes desirable, then, to update standardised bar charts so that they are weighted by frequency: to make more visually salient those categories that occur more often and visually downweight those that occur less often. This is possible using mosaic plots <span class="citation" data-cites="friendly_mosaic_1992 jeppson_generalized_2023">(<a href="references.html#ref-friendly_mosaic_1992" role="doc-biblioref">Friendly 1992</a>; <a href="references.html#ref-jeppson_generalized_2023" role="doc-biblioref">Jeppson and Hofmann 2023</a>)</span>. Bar widths and heights are allowed to vary, so bar area is proportional to absolute number of observations and bars are further subdivided for relative comparison across category values. Mosaic plots are useful tools for exploratory analysis. That they are space-efficient and regularly sized also means they can be flexibly laid out for comparison.</p>
<!-- For combinations that are rare, for example bicycle-pedestrian casualties, it take only a small number observations in a particular direction to change the KSI rate.  -->
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<code>ggmosaic</code>
</div>
</div>
<div class="callout-body-container callout-body">
<p>The mosaic plot in <a href="#fig-bars-vehicle-injury" class="quarto-xref">Figure&nbsp;<span>4.5</span></a> was generated using the <code>ggmosaic</code> package, an extension to ggplot2 <span class="citation" data-cites="jeppson_generalized_2023">(<a href="references.html#ref-jeppson_generalized_2023" role="doc-biblioref">Jeppson and Hofmann 2023</a>)</span>.</p>
</div>
</div>
<!-- #### Computing relative and absolute differences {-}

When studying the plots in @fig-bars-vehicle-injury, there are some implied questions: Does casualty severity vary depending on the type of vehicle involved in the crash?  For which vehicle types is injury severity the highest or lowest? An imbalance is clearly to be expected, but we may start by assuming that injury severity rates, the proportion of pedestrian injuries that are KSI, varies independently of vehicle type and look to quantify and locate any imbalance in these  proportions. This happens automatically when comparing the relative widths of the dark red bars in @fig-bars-vehicle-injury. Annotating with an expectation, for example, the injury severity rate for all pedestrian casualties  (middle plot), helps to further locate differences from expectation for specific vehicles.

Effect size estimates could also be computed directly using risk ratios (RR) -- comparing the observed severity rates by vehicle type against an expectation of independence of severity rates by vehicle type. From this, we could find that the RR for HGVs is 1.64: a crash involving an HGV is 1.64 times more likely to result in a fatality or serious injury to the pedestrian than one not involving an HGV. Alternatively, we could calculate signed chi-score residuals [@visalingam_signed_1981], a measure of effect size that is sensitive both to absolute and relative differences from expectation.  Expected values are *counts* calculated for each observation (category combination of vehicle type and injury severity). Observations ($O_i ... O_n$) are then compared to expected values ($E_i ... E_n$) as below:

$\chi=\frac{O_i - E_i}{\sqrt{E_i}}$

The way in which the differences (residuals) between observed and expected values are standardised in the denominator is important. If the denominator was simply the raw expected value, the residuals would express the proportional difference between each observation and its expected value. The denominator is instead transformed using the square root ($\sqrt{E_i}$), which has the effect of inflating smaller expected values and squashing larger expected values, thereby giving greater saliency to differences that are large in both relative and absolute number. The mosaic plot in effect does this visually.

Expected values are calculated in the same way as the standard [chi-square statistic](https://en.wikipedia.org/wiki/Chi-squared_test) that tests for independence  -- in this case, that counts of crashes by vehicle type distribute independently of injury severity (*Slight* or *KSI*) -- and can be derived from a frequency table of category combinations:

 $E_i = \frac{C_i \times R_i}{GT}$

So for an observed value ($O_i$), $C_i$ is its column total; $R_i$ is its row total; and $GT$ is the grand total. Below is this table updated with expected values and signed-chi-scores. A score $>0$ means that casualty counts for that injury type and vehicle is greater than expected; a score $<0$ means casualty counts for that injury type and vehicle is less than expected. The signed chi-square residuals have mathematical properties and can be interpreted as any standard score. They are assumed to have a mean $\sim1$ and standard deviation of $\sim0$. Residuals are therefore analogous to standard deviation units from the expected mean.


The benefit for EDA is that the signed-scores are very quick and easy to compute and can be derived from frequency tables without applying heavy prior knowledge. They help to identify and locate anomalies in individual data values in a way that is sensitive to both absolute and relative numbers. They are often used in cartographic design to emphasise spatial units that deviate from expectation [refs]. -->
<!-- A common workflow in EDA is:

1. Expose pattern
2. Model an expectation derived from pattern
3. Show deviation from expectation -->
</section><section id="encoding-variation-from-expectation" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="encoding-variation-from-expectation">Encoding variation from expectation</h4>
<p></p>
<p>The heatmap in <a href="#fig-dots-heatmap" class="quarto-xref">Figure&nbsp;<span>4.4</span></a> is hampered by the dominating effect of cars and weekdays. Any additional structure by time period and vehicle type in boroughs outside of this is visually unintelligible. An alternative approach could be to colour cells according to some relevant effect size statistic: for example, differences in the proportion of weekend crashes occurring in any vehicle-type and borough combination against the global average proportion, or expectation, of 22% of crashes occurring on weekends. A problem with this approach is that at this more disaggregated level, sample sizes become quite small. Large proportional differences could be encoded that are nevertheless based on negligible differences in absolute crash frequencies.</p>
<p>There are measures of effect size sensitive both to absolute and relative differences from expectation. Signed chi-score residuals <span class="citation" data-cites="visalingam_signed_1981">(<a href="references.html#ref-visalingam_signed_1981" role="doc-biblioref">Visalingam 1981</a>)</span>, for example, represent expected values as <em>counts</em> separately for each category combination in a dataset – in this case, pedestrian crashes recorded in a borough in a stated time period involving a stated vehicle type. Observed counts (<span class="math inline">O_i ... O_n</span>) are then compared to expected counts (<span class="math inline">E_i ... E_n</span>) as below:</p>
<p><span class="math inline">\chi=\frac{O_i - E_i}{\sqrt{E_i}}</span></p>
<p>The way in which differences between observed and expected values (residuals) are standardised in the denominator is important. If the denominator was simply the raw expected value, the residuals would express the proportional difference between each observation and its expected count value. The denominator is instead transformed using the square root (<span class="math inline">\sqrt{E_i}</span>), which has the effect of inflating smaller expected values and squashing larger expected values, thereby adding saliency to differences from expectation that are also large in absolute number.</p>
<p><a href="#fig-borough-freqs-resids" class="quarto-xref">Figure&nbsp;<span>4.6</span></a> updates the heatmaps with signed residuals encoded using a diverging colour scheme <span class="citation" data-cites="brewer_beyond_1998">(<a href="references.html#ref-brewer_beyond_1998" role="doc-biblioref">Brewer and Campbell 1998</a>)</span> – red for cells with greater crash counts than expected, blue for cells with fewer crash counts than expected. The assumption in the first heatmap is that crash counts by borough distribute independently of vehicle type. Laying out the heatmap such that inner and outer London boroughs are grouped for comparison is instructive: fewer than expected crashes in inner London are recorded for cars; greater than expected for all other vehicle types but especially taxis and bicycles. This pattern is strongest (largest residuals) for very central boroughs, where pedestrian crash frequencies are also likely to be highest and where cars are comparatively less dominant as a travel mode. For almost all boroughs, again especially central London boroughs, there is a clear pattern of modes other than cars, taxis and buses overrepresented amongst crashes occurring on weekdays, again reflecting the transport dynamics of the city.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-borough-freqs-resids" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-borough-freqs-resids-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/04/borough-freqs-resids.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-borough-freqs-resids-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.6: Heatmaps of crashes by vehicle type and period of week for London Boroughs.
</figcaption></figure>
</div>
</div>
</div>
<!-- ::: {.callout-note}
The discussion of Risk Ratios (RRs) was reasonably abbreviated. RRs are interpretable measures of effect size, especially when considered alongside absolute risk (observed KSI rates in this case). As they are a ratio of ratios, and therefore agnostic to sample size, RRs can nevertheless be unreliable. Two ratios might be compared that have very different sample sizes and no compensation is made for the one that contains more data. Although this was our justification for selecting signed chi-scores, this can be addressed by estimating confidence intervals or using robust Bayesian estimates for RRs (representing RRs as distributions).
::: -->
<p> </p>
</section></section><section id="strategies-for-supporting-comparison" class="level3" data-number="4.2.4"><h3 data-number="4.2.4" class="anchored" data-anchor-id="strategies-for-supporting-comparison">
<span class="header-section-number">4.2.4</span> Strategies for supporting comparison</h3>
<p></p>
<p>A key role for data graphics in EDA is in supporting comparison. Three strategies typically deployed are <em>juxtaposition</em>, <em>superposition</em> and <em>explicit encoding</em> <span class="citation" data-cites="gleicher_visual_2011">(see <a href="references.html#ref-gleicher_visual_2011" role="doc-biblioref">Gleicher and Roberts 2011</a>)</span>. <span><a href="#tbl-comparison-strategies" class="quarto-xref">Table&nbsp;<span>4.2</span></a></span> defines each and identifies how they can be implemented in ggplot2. You will see these implementations being deployed in different ways as the book progresses.</p>
<!-- * *Juxtaposition*: Laying the data items to be compared side-by-side.
* *Superposition*: Laying the data items to be compared on top of each other on the same coordinate space.
* *Direct encoding*: Computing some comparison values and encoding those values explicitly. -->
<!-- 

::: {#tbl-comparison-strategies-tex .cell tbl-cap='Implementing Gleicher et al.\'s (2011) three comparison strategies in ggplot2.'}

:::


 -->
<div class="cell">
<div id="tbl-comparison-strategies" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-comparison-strategies-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;4.2: Implementing Gleicher et al.’s (2011) three comparison strategies in ggplot2.
</figcaption><div aria-describedby="tbl-comparison-strategies-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div>
<table class="do-not-create-environment cell table table-sm table-striped small" data-quarto-postprocess="true">
<thead><tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">Strategy</th>
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">Function</th>
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">Use</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left; font-size: 90%;">Juxtaposition</td>
<td style="text-align: left; font-family: Monospace; font-size: 90%;">faceting</td>
<td style="text-align: left; font-size: 90%;">Create separate plots in rows and/or columns by conditioning on a categorical variable. Each plot has same encoding and coordinate space.</td>
</tr>
<tr class="even">
<td style="text-align: left; font-size: 90%;">Juxtaposition</td>
<td style="text-align: left; font-family: Monospace; font-size: 90%;">patchwork cowplot pkg</td>
<td style="text-align: left; font-size: 90%;">Flexibly arrange plots of different data type, encoding and coordinate space.</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-size: 90%;">Superposition</td>
<td style="text-align: left; font-family: Monospace; font-size: 90%;">geoms</td>
<td style="text-align: left; font-size: 90%;">Layering marks on top of each other. Marks may be of different data types but must share the same coordinate space.</td>
</tr>
<tr class="even">
<td style="text-align: left; font-size: 90%;">Explicit encoding</td>
<td style="text-align: left; font-family: Monospace; font-size: 90%;">NA</td>
<td style="text-align: left; font-size: 90%;">No strategy specialised to explicit encoding. Often variables cross 0, so diverging schemes, or graphics with clearly annotated and symbolised thresholds are used.</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</figure>
</div>
</div>
<p>As with most visualization design, each involves trade-offs and so careful decision-making. In <a href="#fig-dots-heatmap" class="quarto-xref">Figure&nbsp;<span>4.4</span></a> dotplots representing counts of weekend and weekday crashes are <em>superposed</em> on the same coordinate space, with connecting lines added to emphasise difference. This strategy is fine where two categories of similar orders of magnitude are compared, but if instead all eight vehicle types were to be encoded with categories differentiated using colour hue, the plot would be substantially more challenging to process. In <a href="#fig-borough-freqs-resids" class="quarto-xref">Figure&nbsp;<span>4.6</span></a>, comparison by vehicle type is instead effected using explicit encoding – residuals coloured above or below an expectation. Notice also the use of <em>containment</em>, <em>juxtaposition</em> and <em>layout</em> in both plots. By containing frequencies for inner- and outer- London boroughs in separate juxtaposed plots, and within each laying out cells top-to-bottom on frequency, the systematic differences in the composition of vehicle types involved in crashes between inner- and outer- London can be inferred.</p>
<section id="comparison-and-layout" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="comparison-and-layout">Comparison and layout</h4>
<!-- The heatmaps in @fig-borough-freqs-resids would be much less effective were some default alphabetical ordering of boroughs used.  -->
<p> Layout is an extremely important mechanism for enabling comparison. The heatmaps in <a href="#fig-borough-freqs-resids" class="quarto-xref">Figure&nbsp;<span>4.6</span></a>, for example, would be much less effective were some default alphabetical ordering of boroughs used. This applies especially when exploring geography. Spatial relations are highly complex and notoriously difficult to model. It would be hard to imagine how the sorts of comparisons in the Washington Post graphics in the previous chapter (<a href="03-visual.html#fig-wp-map" class="quarto-xref">Figure&nbsp;<span>3.1</span></a> and <a href="03-visual.html#fig-wp-swing" class="quarto-xref">Figure&nbsp;<span>3.5</span></a>) could be made without using graphical methods, laying out the peak and line marks with a geographic arrangement in this case.</p>
<p> <a href="#fig-spatial-layout" class="quarto-xref">Figure&nbsp;<span>4.7</span></a> borrows the earlier mosaic plot design to study crash frequencies (bar height) and relative number of weekday/weekend crashes (dark bar width), with frequencies compared between London boroughs. Rather than laying out boroughs top-to-bottom on frequency, boroughs are given an approximate spatial arrangement. This is generated using the <code>gridmappr</code> <span class="citation" data-cites="beecham_gridmappr_2023">(<a href="references.html#ref-beecham_gridmappr_2023" role="doc-biblioref">Beecham 2023</a>)</span> R package, which we describe and explore properly in <a href="05-network.html" class="quarto-xref"><span>Chapter 5</span></a>. This arrangement enables several patterns to be quickly inferred. We can observe that pedestrian crashes involving motorcycles generally occur more in central London boroughs; those involving cars occur in greater relative number during weekends, especially so for those in central London boroughs; and, different from other vehicle types, pedestrian crashes involving cars occur in similarly large numbers in outer London boroughs (Barnet, Croydon) as they do inner London boroughs such as Westminster.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-spatial-layout" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-spatial-layout-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/04/grids_vehicle.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-spatial-layout-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.7: Mosaic plots of vehicle type and period for London Boroughs with an approximate spatial arrangement.
</figcaption></figure>
</div>
</div>
</div>
<p> </p>
</section></section></section><section id="techniques" class="level2" data-number="4.3"><h2 data-number="4.3" class="anchored" data-anchor-id="techniques">
<span class="header-section-number">4.3</span> Techniques</h2>
<p>The technical element to this chapter continues with the STATS19 dataset. Rather than a how-to guide for generating exploratory analysis plots in R, the section aims to demonstrate a workflow for exploratory visual data analysis:</p>
<ol type="1">
<li>Expose pattern(s)</li>
<li>Model expectation(s) derived from pattern(s)</li>
<li>Show deviation from expectation(s)</li>
</ol>
<p>It does so by exploring the characteristics of individuals involved in pedestrian crashes, with a special focus on inequalities. Research suggests those living in more deprived neighbourhoods are at elevated risk of road crash injury than those living in less-deprived areas <span class="citation" data-cites="tortosa_cycling_2021">(<a href="references.html#ref-tortosa_cycling_2021" role="doc-biblioref">Vidal Tortosa et al. 2021</a>)</span>. A follow-up question is around the characteristics of those involved in crashes: To what extent do drivers share demographic characteristics with the pedestrians they crash into, and does this vary by the location in which crashes take place?</p>
<section id="import" class="level3" data-number="4.3.1"><h3 data-number="4.3.1" class="anchored" data-anchor-id="import">
<span class="header-section-number">4.3.1</span> Import</h3>
<ul>
<li>Download the <code>04-template.qmd</code><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> file for this chapter and save it to your <code>vis4sds</code> project.</li>
<li>Open your <code>vis4sds</code> project in RStudio and load the template file by clicking <code>File</code> &gt; <code>Open File ...</code> &gt; <code>04-template.qmd</code>.</li>
</ul>
<p> The presented analysis is based on that published in <span class="citation" data-cites="beecham_vis_2022">Beecham and Lovelace (<a href="references.html#ref-beecham_vis_2022" role="doc-biblioref">2023</a>)</span> and investigates vehicle–pedestrian crashes in STATS19 between 2010 and 2019, where the Index of Multiple Deprivation (IMD) class of the pedestrian, driver and crash location is recorded. Raw STATS19 data are released by the Department for Transport, but can be accessed via the <code>stats19</code> R package <span class="citation" data-cites="lovelace_stats19_2019">(<a href="references.html#ref-lovelace_stats19_2019" role="doc-biblioref">Lovelace et al. 2019</a>)</span>. The data are organised into three tables:</p>
<ul>
<li>
<em>Accidents</em> (or <em>Crashes</em>): Each observation is a recorded road crash with a unique identifier (<code>accident_index</code>), date (<code>date</code>), time (<code>time</code>) and location (<code>longitude</code>, <code>latitude</code>). Many other characteristics associated with the crashes are also stored in this table.</li>
<li>
<em>Casualties</em>: Each observation is a recorded casualty that resulted from a road crash. The <em>Crashes</em> and <em>Casualties</em> data can be linked via the <code>accident_index</code> variable. As well as <code>casualty_severity</code> (<code>Slight</code>, <code>Serious</code>, <code>Fatal</code>), information on casualty demographics and other characteristics is stored in this table.</li>
<li>
<em>Vehicles</em>: Each observation is a vehicle involved in a crash. Again <em>Vehicles</em> can be linked with <em>Crashes</em> and <em>Casualties</em> via the <code>accident_index</code> variable. As well as the vehicle type and manoeuvre being made, information on driver characteristics is recorded in this table.</li>
</ul>
<p> An <code>.fst</code> dataset that uses these three tables to record pedestrian crashes with associated casualty and driver characteristics has been stored in the book’s accompanying data repository<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</p>
<!-- There are some simplifications and assumptions made when generating this linked dataset, detailed in the template file. -->
<!-- Some pedestrian crashes involve many vehicles, but ideally for the analysis we need a single vehicle (and vehicle type) to be attributed to a single pedestrian casualty. For each pedestrian casualty, the *largest* vehicle involved is assigned to the crash. Sometimes several vehicles of the same type  may be involved in a crash, so we use the `vehicle_reference` variable, which takes values of `1` to `n`, and make the assumption that `vehicle_reference=1` is the main vehicle involved in the crash. So *single* vehicles are linked to *single* casualties based first on the largest vehicle involved and then on `vehicle_reference`. -->
<!-- Collected in the STATS19 dataset is the [Indices of Multiple Deprivation](https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019) decile of the small area neighbourhood in which casualties and drivers live. Often IMD is reported at the quintile level (5 rather than 10 quantiles), and we aggregate to this level in our EDA. Code for performing this aggregation is in the template. The crashes data do not automatically contain information on the IMD status of the neighbourhood in which the crash took place. A final bit of data processing code in the template is to download the full English IMD dataset and assign this to crashes dataset based on crash location. -->
</section><section id="sample" class="level3" data-number="4.3.2"><h3 data-number="4.3.2" class="anchored" data-anchor-id="sample">
<span class="header-section-number">4.3.2</span> Sample</h3>
<p> The focus of our analysis is inequalities in the characteristics of those involved in pedestrian crashes. There is only high-level information on these characteristics in the STATS19 dataset. However, the Index of Multiple Deprivation <span class="citation" data-cites="noble_english_2019">(<a href="references.html#ref-noble_english_2019" role="doc-biblioref">Noble et al. 2019</a>)</span> quintile of the small area neighbourhood in which casualties and drivers live is recorded, and we have separately derived the IMD quintile of the neighbourhood in which crashes took place.</p>
<p>Not all recorded crashes contain this information and we first create a new dataset – <code>ped_veh_complete</code> – identifying those linked crashes where the full IMD data are recorded:</p>
<!-- Often IMD is reported at the quintile level (5 rather than 10 quantiles), and we aggregate to this level in our EDA. Code for performing this aggregation is in the template. The crashes data do not automatically contain information on the IMD status of the neighbourhood in which the crash took place. A final bit of data processing code in the template is to download the full English IMD dataset and assign this to crashes dataset based on crash location. -->
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Complete demographics for pedestrians, drivers and crash locations.</span></span>
<span><span class="va">ped_veh_complete</span> <span class="op">&lt;-</span> <span class="va">ped_veh</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span></span>
<span>    <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">crash_quintile</span><span class="op">)</span>,</span>
<span>    <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">casualty_quintile</span><span class="op">)</span>,</span>
<span>    <span class="va">casualty_quintile</span> <span class="op">!=</span> <span class="st">"Data missing or out of range"</span>,</span>
<span>    <span class="va">driver_quintile</span> <span class="op">!=</span> <span class="st">"Data missing or out of range"</span></span>
<span>    <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p> The dataset contains c.&nbsp;52,600 observations, 23% of linked pedestrian crashes. Although this is a large number, there may be some systematic bias in the types of pedestrian crashes for which full demographic data are recorded. For brevity we will not extensively investigate this bias, but below ‘record completeness rates’ are calculated for selected crash types. As anticipated, lower completeness rates appear for crashes coded as <em>Slight</em> in injury severity, but there are also lower completeness rates for crashes occurring in the highest deprivation quintile.</p>
<div class="cell">
<div id="tbl-completeness-rates" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-completeness-rates-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;4.3: Proportion of records – or <em>completeness rates</em> – where IMD status of pedestrian, driver and crash location are recorded.
</figcaption><div aria-describedby="tbl-completeness-rates-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div>
<table class="do-not-create-environment cell table table-sm table-striped small" data-quarto-postprocess="true">
<thead><tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">Crash category</th>
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">Completeness rate</th>
</tr></thead>
<tbody>
<tr class="odd" data-grouplength="3">
<td colspan="2" style="border-bottom: 0px solid; font-size: 90%">Casualty severity</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em; width: 30%; font-size: 90%;" data-indentlevel="1">Fatal</td>
<td style="text-align: left; width: 20%; font-size: 90%;">30%</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em; width: 30%; font-size: 90%;" data-indentlevel="1">Serious</td>
<td style="text-align: left; width: 20%; font-size: 90%;">29%</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em; width: 30%; font-size: 90%;" data-indentlevel="1">Slight</td>
<td style="text-align: left; width: 20%; font-size: 90%;">22%</td>
</tr>
<tr class="odd" data-grouplength="5">
<td colspan="2" style="border-bottom: 0px solid; font-size: 90%">IMD class of crash location</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em; width: 30%; font-size: 90%;" data-indentlevel="1">5 Least deprived</td>
<td style="text-align: left; width: 20%; font-size: 90%;">25%</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em; width: 30%; font-size: 90%;" data-indentlevel="1">4 Less deprived</td>
<td style="text-align: left; width: 20%; font-size: 90%;">25%</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em; width: 30%; font-size: 90%;" data-indentlevel="1">3 Mid deprived</td>
<td style="text-align: left; width: 20%; font-size: 90%;">24%</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em; width: 30%; font-size: 90%;" data-indentlevel="1">2 More deprived</td>
<td style="text-align: left; width: 20%; font-size: 90%;">23%</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em; width: 30%; font-size: 90%;" data-indentlevel="1">1 Most deprived</td>
<td style="text-align: left; width: 20%; font-size: 90%;">22%</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</figure>
</div>
</div>
<p>This difference in record completeness may reflect genuine differences in recording behaviour for crashes occurring in high deprivation neighbourhoods, or it might be a function of some confounding context. For example, one might expect crashes more serious in nature to be reported in greater detail and so have higher completeness rates. If crashes resulting in slight injuries are overrepresented in high deprivation areas, this might explain the pattern of completeness rates by deprivation area. To explore this further, in <a href="#fig-completeness" class="quarto-xref">Figure&nbsp;<span>4.8</span></a> completeness rates are calculated separately by crash injury severity. This demonstrates, as expected, higher completeness rates for crashes resulting in more serious injury, but that record completeness is still lower for crashes taking place in the high deprivation neighbourhoods.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-completeness" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-completeness-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/04/completeness.png" class="img-fluid figure-img" style="width:80.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-completeness-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.8: Completeness rates by IMD class of crash location and crash injury severity.
</figcaption></figure>
</div>
</div>
</div>
<p>The code for <a href="#fig-completeness" class="quarto-xref">Figure&nbsp;<span>4.8</span></a>:</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ped_veh</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    is_complete<span class="op">=</span><span class="va">accident_index</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> </span>
<span>      <span class="op">(</span><span class="va">ped_veh_complete</span> <span class="op">|&gt;</span> <span class="fu">pull</span><span class="op">(</span><span class="va">accident_index</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    is_ksi<span class="op">=</span><span class="fu">if_else</span><span class="op">(</span><span class="va">accident_severity</span> <span class="op">!=</span> </span>
<span>      <span class="st">"Slight"</span>, <span class="st">"Fatal | Serious"</span>, <span class="st">"Slight"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">crash_quintile</span>, <span class="va">is_ksi</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span>prop_complete<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">is_complete</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span></span>
<span>    <span class="fu">aes</span><span class="op">(</span>y<span class="op">=</span><span class="va">crash_quintile</span>, x<span class="op">=</span><span class="va">prop_complete</span>, colour<span class="op">=</span><span class="va">is_ksi</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">2</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_colour_manual</span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#67000d"</span>, <span class="st">"#fb6a4a"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fl">.4</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A breakdown of the <code>ggplot2</code> code:</p>
<ol type="1">
<li>
<em>Data</em>: A boolean variable, <code>is_complete</code>, is defined by checking <code>accident_index</code> against those contained in the <code>ped_veh_complete</code> dataset. Note that the <code>pull()</code> function extracts <code>accident_index</code> from the complete dataset as a vector of values. A boolean variable (<code>is_ksi</code>) also to group and separate <em>Fatal</em> and <em>Serious</em> injury outcomes from those that are <em>Slight</em>. We then group on <code>crash_quintile</code> and <code>is_ksi</code> to calculate completeness rates by severity and crash location. Since <code>is_complete</code> is a boolean value (<code>false=0</code>, <code>true=1</code>), its mean is the proportion of <code>true</code> records, in this case those with a complete status.</li>
<li>
<em>Encoding</em>: Arrange dots vertically (<code>y</code> position) on <code>crash_quintile</code> and horizontally (<code>x</code> position) on <code>prop_complete</code> and <code>colour</code> on injury severity (<code>is_ksi</code>).</li>
<li>
<em>Marks</em>: <code>geom_point()</code> for drawing points.</li>
<li>
<em>Scale</em>: Passed to <code>scale_colour_manual()</code> are hex values for dark and light red, according to ordinal injury severity. </li>
</ol>
<p></p>
</section><section id="abstract-and-relate" class="level3" data-number="4.3.3"><h3 data-number="4.3.3" class="anchored" data-anchor-id="abstract-and-relate">
<span class="header-section-number">4.3.3</span> Abstract and relate</h3>
<!-- Motivating this analysis is the characteristics, as measured by neighbourhood-level IMD, of pedestrians involved in road crashes, the drivers crashing into them and the locations in which crashes occur. We wish to ask to what extent drivers share demographic characteristics with the pedestrians they crash into, and does this vary by the location in which crashes take place? -->
<p> Now we’ve identified the data for our analysis, we can begin to explore the dataset, bearing in mind the ultimate “who-hit-whom” question: Do drivers share demographic characteristics with the pedestrians they crash into, and does this vary by the location in which crashes take place?</p>
<p>To start, we abstract over the relevant variables: five IMD classes from high-to-low deprivation (IMD quintile 1–5) for pedestrians, drivers, and crash locations. <a href="#fig-imd-freqs" class="quarto-xref">Figure&nbsp;<span>4.9</span></a> summarises frequencies across these categories. Pedestrian crashes occur more frequently in higher deprivation neighbourhoods; those injured more often live in higher deprivation neighbourhoods; and the same applies to drivers involved in crashes. This high-level pattern is consistent with existing research <span class="citation" data-cites="tortosa_cycling_2021">(<a href="references.html#ref-tortosa_cycling_2021" role="doc-biblioref">Vidal Tortosa et al. 2021</a>)</span> and can be explained. High deprivation areas are located in greater number in urban areas and so we would expect greater numbers of pedestrian crashes to occur in such areas. The shapes of the bars nevertheless suggest that there are inequalities in the characteristics of pedestrians and drivers involved in crashes: frequencies are most skewed towards high deprivation bars for pedestrians and are slightly more uniform across deprivation classes for drivers. This may indicate an importing effect of drivers living in lower deprivation areas crashing into pedestrians living in higher deprivation areas – a speculative finding worth exploring.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-imd-freqs" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-imd-freqs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/04/freqs_imd.png" class="img-fluid figure-img" style="width:90.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-imd-freqs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.9: Frequencies of pedestrian crashes by IMD class of crash location, pedestrian injured and driver involved.
</figcaption></figure>
</div>
</div>
</div>
<p>The code for <a href="#fig-imd-freqs" class="quarto-xref">Figure&nbsp;<span>4.9</span></a>:</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ped_veh_complete</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">crash_quintile</span>, <span class="va">casualty_quintile</span>, <span class="va">driver_quintile</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span></span>
<span>    cols<span class="op">=</span><span class="fu">everything</span><span class="op">(</span><span class="op">)</span>, names_to<span class="op">=</span><span class="st">"location_type"</span>, values_to<span class="op">=</span><span class="st">"imd"</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">location_type</span>, <span class="va">imd</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span>count<span class="op">=</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">separate</span><span class="op">(</span>col<span class="op">=</span><span class="va">location_type</span>, into<span class="op">=</span><span class="st">"type"</span>, sep<span class="op">=</span><span class="st">"_"</span>, extra <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    type<span class="op">=</span><span class="fu">case_when</span><span class="op">(</span></span>
<span>      <span class="va">type</span><span class="op">==</span><span class="st">"casualty"</span> <span class="op">~</span> <span class="st">"pedestrian"</span>,</span>
<span>      <span class="va">type</span><span class="op">==</span><span class="st">"crash"</span> <span class="op">~</span> <span class="st">"location"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">type</span><span class="op">)</span>,</span>
<span>    type<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">type</span>, levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"location"</span>, <span class="st">"pedestrian"</span>, <span class="st">"driver"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_col</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">imd</span>, y<span class="op">=</span><span class="va">count</span><span class="op">)</span>, fill<span class="op">=</span><span class="st">"#003c8f"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_discrete</span><span class="op">(</span>labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"most"</span>,<span class="st">""</span>, <span class="st">"mid"</span>, <span class="st">""</span>, <span class="st">"least"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">type</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>ggplot2</code> code:</p>
<ol type="1">
<li>
<em>Data</em>: Select the three variables recording IMD class of crash location (<code>crash_quintile</code>), pedestrian (<code>casualty_quintile</code>) and driver (<code>driver_quintile</code>). <code>pivot_longer()</code> makes each row a crash record and IMD class; this dataset is then grouped in order to count frequencies of location, pedestrian and drivers by IMD class involved. <code>mutate()</code> is used to recode the <code>type</code> variable with more expressive labels for locations, pedestrians and drivers and to convert it to a factor in order to control the order in which variables appear in the faceted plot. </li>
<li>
<em>Encoding</em>: Bars positioned vertically (<code>y</code> position) on frequency and horizontally (<code>x</code> position) on <code>imd</code> class.</li>
<li>
<em>Marks</em>: <code>geom_col()</code> for drawing bars.</li>
<li>
<em>Facets</em>: <code>facet_wrap()</code> for faceting on the <code>type</code> variable (location, pedestrian or driver). </li>
</ol></section><section id="model-and-residual-pass-1" class="level3" data-number="4.3.4"><h3 data-number="4.3.4" class="anchored" data-anchor-id="model-and-residual-pass-1">
<span class="header-section-number">4.3.4</span> Model and residual: Pass 1</h3>
<p> To investigate how the characteristics of pedestrians and drivers <em>co</em>-vary, we can compute the joint frequency of each permutation of driver-pedestrian IMD quintile group. This results in <span class="math inline">5x5</span> combinations, as in the right of <a href="#fig-imd-freqs" class="quarto-xref">Figure&nbsp;<span>4.9</span></a>, and in <a href="#fig-imd-driver-cas" class="quarto-xref">Figure&nbsp;<span>4.10</span></a> these combinations are represented in a heatmap. Cells of the heatmap are ordered left-to-right on the IMD class of pedestrian and bottom-to-top on the IMD class of driver. Arranging cells in this way encourages linearity in the association to be emphasised. The darker blues in the diagonals demonstrate that an association between pedestrian-driver IMD characteristics exists: drivers and passengers living in similar types of neighbourhoods are involved in crashes with one another with greater frequency than those living in different types of neighbourhoods.</p>
<p>A consequence of the heavy concentration of crash counts, and thus colour, in the high-deprivation cells is that it is difficult to gauge variation and the strength of association in the lower deprivation cells. We can use exploratory models to support our analysis. In this case, our (unsophisticated) expectation is that crash frequencies distribute independently of the IMD class of the pedestrian-driver involved. We compute signed chi-scores describing how different the observed number of crashes in each cell position is from this expectation.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-imd-driver-cas" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-imd-driver-cas-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/04/imd_driver_cas.png" class="img-fluid figure-img" style="width:83.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-imd-driver-cas-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.10: Pedestrian casualties by IMD quintile of pedestrian and driver.
</figcaption></figure>
</div>
</div>
</div>
<p>The observed-versus-expected plot highlights the largest positive residuals are in the diagonals and the largest negative residuals are those furthest from the diagonals: we see higher crash frequencies between drivers and pedestrians living in the same or similar IMD quintiles and fewer between those in different quintiles than would be expected given no association between pedestrian-driver IMD characteristics. That the bottom left cell – high-deprivation-driver + high-deprivation-pedestrian – is dark red can be understood when remembering that signed chi-scores emphasise effect sizes that are large in absolute as well as relative number. Not only is there an association between the characteristics of drivers and casualties, but larger crash counts are recorded in locations containing the highest deprivation and so residuals here are large. The largest positive residuals are nevertheless recorded in the top right of the heatmap – and this is more surprising. Against an expectation of no association between the IMD characteristics of drivers and pedestrians, there is a particularly high number of crashes between drivers and pedestrians living in neighbourhoods containing the lowest deprivation. An alternative phrasing: the IMD characteristics of those involved in pedestrian crashes are most narrow between drivers and pedestrians who live in the lowest deprivation quintiles.</p>
<p>The code:</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_data</span> <span class="op">&lt;-</span> <span class="va">ped_veh_complete</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>grand_total<span class="op">=</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">driver_quintile</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>row_total<span class="op">=</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">casualty_quintile</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>col_total<span class="op">=</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">casualty_quintile</span>, <span class="va">driver_quintile</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span></span>
<span>    observed<span class="op">=</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    row_total<span class="op">=</span><span class="fu">first</span><span class="op">(</span><span class="va">row_total</span><span class="op">)</span>,</span>
<span>    col_total<span class="op">=</span><span class="fu">first</span><span class="op">(</span><span class="va">col_total</span><span class="op">)</span>,</span>
<span>    grand_total<span class="op">=</span><span class="fu">first</span><span class="op">(</span><span class="va">grand_total</span><span class="op">)</span>,</span>
<span>    expected<span class="op">=</span><span class="op">(</span><span class="va">row_total</span><span class="op">*</span><span class="va">col_total</span><span class="op">)</span><span class="op">/</span><span class="va">grand_total</span>,</span>
<span>    resid<span class="op">=</span><span class="op">(</span><span class="va">observed</span><span class="op">-</span><span class="va">expected</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">expected</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">max_resid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">model_data</span><span class="op">$</span><span class="va">resid</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">casualty_quintile</span>, y<span class="op">=</span><span class="va">driver_quintile</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_tile</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill<span class="op">=</span><span class="va">resid</span><span class="op">)</span>, colour<span class="op">=</span><span class="st">"#707070"</span>, size<span class="op">=</span><span class="fl">.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_distiller</span><span class="op">(</span></span>
<span>    palette<span class="op">=</span><span class="st">"RdBu"</span>, direction<span class="op">=</span><span class="op">-</span><span class="fl">1</span>,</span>
<span>    limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">max_resid</span>, <span class="va">max_resid</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The ggplot2 spec for <a href="#fig-imd-driver-cas" class="quarto-xref">Figure&nbsp;<span>4.10</span></a>:</p>
<ol type="1">
<li>
<em>Data</em>: We create a staged dataset for plotting. Observed values for each cell of the heatmap are computed, along with row and column marginals for deriving expected values. We assume that crash frequencies distribute independently of IMD class, and so calculate expected values for each cell of the heatmap (<span class="math inline">E_{ij}</span>) from its corresponding column (<span class="math inline">C_i</span>), row (<span class="math inline">R_j</span>) maginals and the grand total of crashes (<span class="math inline">GT</span>): <span class="math inline">E_i = \frac{C_i \times R_i}{GT}</span>. The graphics in the right margin of <a href="#fig-imd-driver-cas" class="quarto-xref">Figure&nbsp;<span>4.10</span></a> show how expectation is spread in this way. You will notice that <code>group_by()</code> does some heavy lifting to arrive at these row, column and cell-level totals. The way in which the signed chi-score residuals are calculated in the final <code>group_by()</code> follows that described earlier in the chapter.</li>
<li>
<em>Encoding</em>: Cells of the heatmap are arranged in <code>x</code> and <code>y</code> on the IMD class of pedestrians and drivers and filled according to signed chi-score residuals. .</li>
<li>
<em>Marks</em>: <code>geom_tile()</code> for drawing cells of the heatmap.</li>
<li>
<em>Scale</em>: <code>scale_fill_distiller()</code> for continuous ColorBrewer <span class="citation" data-cites="harrower_colorbrewerorg_2003">(<a href="references.html#ref-harrower_colorbrewerorg_2003" role="doc-biblioref">Harrower and Brewer 2003</a>)</span> diverging scheme, using the <code>RdBu</code> palette. To make the scheme centred on 0, the maximum absolute residual value in <code>model_data</code> is used.</li>
</ol>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task 1
</div>
</div>
<div class="callout-body-container callout-body">
<div class="line-block">You will see that data preparation with <code>dplyr</code> plays an important role in constructing data graphics in ggplot2. While the code to create <code>model_data</code> may seem somewhat cumbersome, you will find yourself reusing these data processing templates.<br><br>
Now that you have seen how observed, expected and residual values can be derived for cells of a heatmap, recreate the heatmap in the left column of <a href="#fig-borough-freqs-resids" class="quarto-xref">Figure&nbsp;<span>4.6</span></a> displaying differences from expectation in the number of pedestrian crashes by London borough, assuming that crashes distribute by borough independently of vehicle type.</div>
</div>
</div>
</section><section id="model-and-residual-pass-2" class="level3" data-number="4.3.5"><h3 data-number="4.3.5" class="anchored" data-anchor-id="model-and-residual-pass-2">
<span class="header-section-number">4.3.5</span> Model and residual: Pass 2</h3>
<p>An obvious confounding factor, neglected in the analysis above, is the IMD class of the <em>location</em> in which crashes occur. To explore this, we can condition (or facet) on the IMD class of crash location, laying out the faceted plot left-to-right on the ordered IMD classes. Eyeballing this graphic of observed counts (<a href="#fig-imd-driver-cas-crash" class="quarto-xref">Figure&nbsp;<span>4.11</span></a>) we see again the association between IMD characteristics for crashes occurring in the least deprived quintile and elsewhere slightly more ‘mixing’. Few pedestrians living outside the most deprived quintile are involved in crashes that occur in that quintile. Given the dominating pattern is of crashes occurring in the most deprived quintiles, however, it is difficult to see too much variation from the diagonal cell in the less-deprived quintiles. An easy adjustment would be to apply a local colour scale for each faceted plot and compare relative ‘leakage’ from the diagonal for each IMD crash location. The more interesting question, however, is whether this known association between pedestrian and driver characteristics is stronger for certain driver-pedestrian-location combinations than others: that is, net of the dominant pattern in the top row of <a href="#fig-imd-driver-cas-crash" class="quarto-xref">Figure&nbsp;<span>4.11</span></a>, in which cells are there greater or fewer crash counts?</p>
<p>The concept that we are exploring is whether crash counts vary depending on how different the IMD characteristics of pedestrians and drivers are from those of the locations in which crashes occur. We calculate a new variable measuring this distance: ‘geodemographic distance’, the euclidean distance between the IMD class of the driver-pedestrian-crash location, treating IMD as a continuous variable ranging from 1 to 5. The second row of <a href="#fig-imd-driver-cas-crash" class="quarto-xref">Figure&nbsp;<span>4.11</span></a> encodes this directly. We then specify a Poisson regression model, modelling crash counts in each driver-pedestrian-crash location cell as a function of geodemographic distance for that cell. Since the range of the crash count varies systematically location-type, the model is extended with with a group-level intercept that varies on the IMD class of the crash location. If regression modelling frameworks are new to you, don’t worry about the specifics. More important is our interpretation and analysis of the residuals. These residuals are expressed in the same way as in the signed-chi-score model and show whether there are greater or fewer crash counts in any pedestrian-driver-location combination than would be expected given the amount of geodemographic difference between individuals and locations involved. Our expectation is that crash counts vary inversely with geodemographic distance. In EDA, we are not overly concerned with confirming this to be the case; instead we use our data graphics to explore where in the distribution, and by how much, the observed data depart from this expectation.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-imd-driver-cas-crash" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-imd-driver-cas-crash-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/04/model_imd_location.png" class="img-fluid figure-img" style="width:90.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-imd-driver-cas-crash-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.11: Pedestrian casualties by IMD quintile of pedestrian, driver and crash location.
</figcaption></figure>
</div>
</div>
</div>
<p>The vertical block of red in the left column of the left-most matrix (crashes occurring in high-deprivation areas) indicates higher than expected crash counts for pedestrians living and being hit in the most deprived quintile, both by drivers living in that high-deprivation quintile and the less-deprived quintiles (especially the lowest quintiles). This pattern is important as it persists even after having modelled for ‘geodemographic distance’. There is much to unpick elsewhere in the graphic. Like many health issues, pedestrian road injuries have a heavy socio-economic element and our analysis has identified several patterns worthy of further investigation. However, this model-backed exploratory analysis provides direct evidence of the previously suggested “importing effect” of drivers from low-deprivation areas crashing and injuring predestrians in high-deprivation areas.</p>
<!-- It is replicated to a lesser extent for pedestrians living and being hit in the second most deprived quintile, but does not appear so strongly for the mid- and low-deprivation quintiles. Studying the plots closely there is a tendency for red cells to appear in the lower half of the cells for matrices describing the mid-low deprivation crash locations. This indicates that, net of geodemographic distance, drivers living in higher deprivation neighbourhoods are involved in road crashes with pedestrians in greater number than would be expected given geodemographic distance, and for crashes occurring in the lower deprivation areas in which they do not live. -->
<!-- Hopefully from this you get a sense of the common workflow for EDA:

* Expose pattern
* Model an expectation derived from pattern
* Show deviation from expectation -->
<p>The modelling is somewhat involved – a more gentle introduction to model-based visual analysis appears in Chapters <a href="06-model.html" class="quarto-xref"><span>6</span></a> and <a href="07-uncertainty.html" class="quarto-xref"><span>7</span></a> – but code for generating the model and graphics in <a href="#fig-imd-driver-cas-crash" class="quarto-xref">Figure&nbsp;<span>4.11</span></a> is below.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_data</span> <span class="op">&lt;-</span> <span class="va">ped_veh_complete</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    <span class="co"># Derive numeric values from IMD classes (ordered factor variable).</span></span>
<span>    <span class="fu">across</span><span class="op">(</span></span>
<span>      .cols<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">casualty_quintile</span>, <span class="va">driver_quintile</span>, <span class="va">crash_quintile</span><span class="op">)</span>,</span>
<span>      .fns<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>num<span class="op">=</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">.</span>, levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"1 most deprived"</span>, <span class="st">"2 more deprived"</span>, </span>
<span>        <span class="st">"3 mid deprived"</span>, <span class="st">"4 less deprived"</span>, <span class="st">"5 least deprived"</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># Calculate demog_distance.</span></span>
<span>    demog_dist<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span></span>
<span>      <span class="op">(</span><span class="va">casualty_quintile_num</span><span class="op">-</span><span class="va">driver_quintile_num</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span></span>
<span>      <span class="op">(</span><span class="va">casualty_quintile_num</span><span class="op">-</span><span class="va">crash_quintile_num</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span></span>
<span>      <span class="op">(</span><span class="va">driver_quintile_num</span><span class="op">-</span><span class="va">crash_quintile_num</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Calculate on observed cells: each ped-driver IMD class combination.</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">casualty_quintile</span>, <span class="va">driver_quintile</span>, <span class="va">crash_quintile</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span>crash_count<span class="op">=</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span>, demog_dist<span class="op">=</span><span class="fu">first</span><span class="op">(</span><span class="va">demog_dist</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Model crash count against demographic distance allowing the intercept</span></span>
<span><span class="co"># to vary on crash quintile, due to large differences in obs frequences.</span></span>
<span><span class="co"># between location quintiles.</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">lme4</span><span class="fu">::</span><span class="fu">glmer</span><span class="op">(</span><span class="va">crash_count</span> <span class="op">~</span> <span class="va">demog_dist</span> <span class="op">+</span> <span class="op">(</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">crash_quintile</span><span class="op">)</span>,</span>
<span>                     data<span class="op">=</span><span class="va">model_data</span>, family<span class="op">=</span><span class="va">poisson</span>, nAGQ <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract model residuals.</span></span>
<span><span class="va">model_data</span> <span class="op">&lt;-</span> <span class="va">model_data</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>ml_resids<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">model</span>, type<span class="op">=</span><span class="st">"pearson"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot.</span></span>
<span><span class="va">model_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">casualty_quintile</span>, y<span class="op">=</span><span class="va">driver_quintile</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_tile</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill<span class="op">=</span><span class="va">ml_resids</span><span class="op">)</span>, colour<span class="op">=</span><span class="st">"#707070"</span>, size<span class="op">=</span><span class="fl">.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_distiller</span><span class="op">(</span>palette<span class="op">=</span><span class="st">"RdBu"</span>, direction<span class="op">=</span><span class="op">-</span><span class="fl">1</span>,</span>
<span>  limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">model_data</span><span class="op">$</span><span class="va">ml_resids</span><span class="op">)</span><span class="op">)</span>, </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">model_data</span><span class="op">$</span><span class="va">ml_resids</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">crash_quintile</span>, nrow<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p> </p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task 2: Design challenge
</div>
</div>
<div class="callout-body-container callout-body">
<!-- This technical section was quite specialised visually-informed informing model development, but -->
<p></p>
<div class="line-block">Key to developing data graphics in any exploratory anaysis is proficiency in implementing strategies for comparison (e.g.&nbsp; <span><a href="#tbl-comparison-strategies" class="quarto-xref">Table&nbsp;<span>4.2</span></a></span>). <a href="#fig-age-imd-light" class="quarto-xref">Figure&nbsp;<span>4.12</span></a> makes use of juxtaposition (top graphic) and superposition + explicit encoding (bottom graphic) to compare pedestrian casualties taking place in daylight versus darkness and against the age of pedestrians injured and the IMD class of the crash location.<br><br>
As expected from the analysis at the start of this chapter, there is a peak in youger adults being injured in pedestrian road crashes. For crashes taking place in darkness, this peak is less extreme and shifts to slightly ‘older’ young adult ages.<br><br>
In total, 71% of recorded pedestrian crashes occur in daylight. The bottom graphic uses this proportion to explicitly encode an <em>expected</em> number of daylight crashes at each age group – e.g.&nbsp;if one were to randomly select an age and deprivation grouping, we would expect 71% of crashes to occur in daylight. This addition helps expose that there are slightly more crashes recorded in darkness for crashes taking place in mid-deprivation locations and involving younger and middle-age pedestrians. A more subtle pattern is of slightly fewer crashes in darkness than expected in older adults.<br>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-age-imd-light" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-age-imd-light-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/04/age_light_imd.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-age-imd-light-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.12: Pedestrian casualties by age of pedestrian, IMD quintile of crash location and level of darkness.
</figcaption></figure>
</div>
</div>
</div>
<p>Try writing some <code>dplyr</code> and ggplot2 code to generate data graphics similar to <a href="#fig-age-imd-light" class="quarto-xref">Figure&nbsp;<span>4.12</span></a>, or perhaps using the same layout and plot grammar but conditioning on some other category of interest in the <code>ped_veh</code> dataset. You will want to consider how the variables (<code>age_of_casualty</code>, <code>crash_quintile</code>, <code>light_conditions</code>) are mapped to visual channels via position, colour and spatial region.</p>
</div>
</div>
<p> </p>
</section></section><section id="conclusions" class="level2" data-number="4.4"><h2 data-number="4.4" class="anchored" data-anchor-id="conclusions">
<span class="header-section-number">4.4</span> Conclusions</h2>
<p>Exploratory data analysis (EDA) is an approach to analysis that aims to amplify knowledge and understanding of a dataset. The idea is to explore structure, and data-driven hypotheses, by quickly generating many often throwaway statistical and graphical summaries. In this chapter we discussed chart types for exposing distributions and relationships in a dataset, depending on data type. We also showed that EDA is not model-free. Data graphics help us to see dominant patterns and from here formulate expectations that are to be modelled. Different from so-called confirmatory data analysis, however, in an EDA the goal of model-building is not to “identify whether the model fits or not […] but rather to understand in what ways the fitted model departs from the data” <span class="citation" data-cites="gelman_exploratory_2004">(<a href="references.html#ref-gelman_exploratory_2004" role="doc-biblioref">Gelman 2004</a>)</span>. We covered visualization approaches to supporting comparison between data and expectation using juxtaposition, superimposition and explicit encoding <span class="citation" data-cites="gleicher_visual_2011">(<a href="references.html#ref-gleicher_visual_2011" role="doc-biblioref">Gleicher and Roberts 2011</a>)</span>. The chapter did not provide an exhaustive survey of EDA approaches, and certainly not an exhaustive set of chart types and model formulations for exposing distributions and relationships. By linking the chapter closely to the STATS19 dataset, we learnt a workflow for EDA that is common to most effective data analysis and communication activity:</p>
<ol type="1">
<li>Expose pattern</li>
<li>Model an expectation derived from that pattern</li>
<li>Show deviation from expectation</li>
</ol></section><section id="further-reading" class="level2" data-number="4.5"><h2 data-number="4.5" class="anchored" data-anchor-id="further-reading">
<span class="header-section-number">4.5</span> Further Reading</h2>
<p>For discussion of exploratory analysis and visual methods in modern data analysis:</p>
<ul>
<li>Hullman, J. and Gelman, A. 2021. “Designing for Interactive Exploratory Data Analysis Requires Theories of Graphical Inference” <em>Harvard Data Science Review</em>, 3(3). doi: 10.1162/99608f92.3ab8a587.</li>
</ul>
<p>Further discussion with implemented examples for road safety analysis:</p>
<ul>
<li>Beecham, R., and R. Lovelace. 2023. “A Framework for Inserting Visually-Supported Inferences into Geographical Analysis Workflow: Application to Road Safety Research” <em>Geographical Analysis</em>, 55: 344–366. doi: 10.1111/gean.12338.</li>
</ul>
<p>For an introduction to exploratory data analysis in the tidyverse:</p>
<ul>
<li>Wickham, H., Çetinkaya-Rundel, M., Grolemund, G. 2023, “R for Data Science, 2nd Edition”, <em>O’Reilly</em>.
<ul>
<li>Chapter 11.</li>
</ul>
</li>
<li>Ismay, C. and Kim, A. 2020. “Statistical Inference via Data Science: A ModernDive into r and the Tidyverse” <em>CRC Press</em>. doi: 10.1201/9780367409913.</li>
</ul>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-beecham_gridmappr_2023" class="csl-entry" role="listitem">
Beecham, R. 2023. <em>Gridmappr</em>. <a href="https://www.roger-beecham.com/gridmappr/">https://www.roger-beecham.com/gridmappr/</a>.
</div>
<div id="ref-beecham_vis_2022" class="csl-entry" role="listitem">
Beecham, R., and R. Lovelace. 2023. <span>“A Framework for Inserting Visually-Supported Inferences into Geographical Analysis Workflow: Application to Road Safety Research”</span> 55: 345–66. <a href="https://doi.org/10.1111/gean.12338">https://doi.org/10.1111/gean.12338</a>.
</div>
<div id="ref-brewer_beyond_1998" class="csl-entry" role="listitem">
Brewer, Cynthia, and Andrew J. Campbell. 1998. <span>“Beyond Graduated Circles: Varied Point Symbols for Representing Quantitative Data on Maps.”</span> <em>Cartographic Perspectives</em>, no. 29: 6–25.
</div>
<div id="ref-friendly_mosaic_1992" class="csl-entry" role="listitem">
Friendly, M. 1992. <span>“Mosaic Displays for Loglinear Models.”</span> In <em><span>ASA</span>, <span>Proceedings</span> of the <span>Statistical</span> <span>Graphics</span> <span>Section</span></em>, 61–68.
</div>
<div id="ref-gelman_exploratory_2004" class="csl-entry" role="listitem">
Gelman, A. 2004. <span>“Exploratory <span>Data</span> <span>Analysis</span> for <span>Complex</span> <span>Models</span>.”</span> <em>Journal of Computational and Graphical Statistics</em> 13 (4): 755–79. <a href="https://doi.org/10.1198/106186004X11435">https://doi.org/10.1198/106186004X11435</a>.
</div>
<div id="ref-gleicher_visual_2011" class="csl-entry" role="listitem">
Gleicher, Albers, M., and J. Roberts. 2011. <span>“Visual Comparison for Information Visualization. <span>Information</span> <span>Visualization</span>.”</span> <em>Information Visualization</em> 10 (4): 289–309.
</div>
<div id="ref-harrower_colorbrewerorg_2003" class="csl-entry" role="listitem">
Harrower, Mark, and Cynthia A. Brewer. 2003. <span>“ColorBrewer.org: An Online Tool for Selecting Colour Schemes for Maps.”</span> <em>The Cartographic Journal</em> 40 (1): 27–37. <a href="https://doi.org/10.1179/000870403235002042">https://doi.org/10.1179/000870403235002042</a>.
</div>
<div id="ref-jeppson_generalized_2023" class="csl-entry" role="listitem">
Jeppson, Haley, and Heike Hofmann. 2023. <span>“Generalized Mosaic Plots in the Ggplot2 Framework.”</span> <em>The R Journal</em> 14 (4): 50–78. <a href="https://doi.org/10.32614/RJ-2023-013">https://doi.org/10.32614/RJ-2023-013</a>.
</div>
<div id="ref-lovelace_stats19_2019" class="csl-entry" role="listitem">
Lovelace, Robin, Malcolm Morgan, Layik Hama, Mark Padgham, David Ranzolin, and Adam Sparks. 2019. <span>“Stats 19: A Package for Working with Open Road Crash Data.”</span> <em>The Journal of Open Source Software</em> 4 (33): 1181. <a href="https://doi.org/10.21105/joss.01181">https://doi.org/10.21105/joss.01181</a>.
</div>
<div id="ref-mcgill_variations_1978" class="csl-entry" role="listitem">
McGill, Tukey, R., and W. A. Larsen. 1978. <span>“Variations of Box Plots.”</span> <em>The American Statistician</em> 32: 12–16.
</div>
<div id="ref-munzner_visualization_2014" class="csl-entry" role="listitem">
Munzner, T. 2014. <em>Visualization <span>Analysis</span> and <span>Design</span></em>. <span>AK</span> <span>Peters</span> <span>Visualization</span> <span>Series</span>. Boca Raton, FL: CRC Press.
</div>
<div id="ref-noble_english_2019" class="csl-entry" role="listitem">
Noble, S., D. McLennan, M. Noble, E. Plunkett, N. Gutacker, M. Silk, and G. Wright. 2019. <span>“The English Indices of Deprivation 2019.”</span> <span>Ministry of Housing, Communities &amp; Local Government</span>. <a href="https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019">https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019</a>.
</div>
<div id="ref-tukey_exploratory_1977" class="csl-entry" role="listitem">
Tukey, J. W. 1977. <em>Exploratory <span>Data</span> <span>Analysis</span></em>. Reading, MA, USA: Addison-Wesley.
</div>
<div id="ref-tortosa_cycling_2021" class="csl-entry" role="listitem">
Vidal Tortosa, Eugeni, Robin Lovelace, Eva Heinen, and Richard P. Mann. 2021. <span>“Socioeconomic Inequalities in Cycling Safety: An Analysis of Cycling Injury Risk by Residential Deprivation Level in England.”</span> <em>Journal of Transport &amp; Health</em> 23: 101291. https://doi.org/<a href="https://doi.org/10.1016/j.jth.2021.101291">https://doi.org/10.1016/j.jth.2021.101291</a>.
</div>
<div id="ref-visalingam_signed_1981" class="csl-entry" role="listitem">
Visalingam, M. 1981. <span>“The Signed Chi-Score Measure for the Classification and Mapping of Plychotomous Data.”</span> <em>The Cartographic Journal</em> 18 (1): 32–43.
</div>
</div>
</section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p><code>https://vis4sds.github.io/vis4sds/files/04-template.qmd</code><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p><code>https://github.com/vis4sds/data</code><a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/vis4sds\/vis4sds");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./03-visual.html" class="pagination-link" aria-label="Visualization Fundamentals">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Visualization Fundamentals</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./05-network.html" class="pagination-link" aria-label="Geographic Networks">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Geographic Networks</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>