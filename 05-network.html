<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Visualization for Social Data Science - 5&nbsp; Networks</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./06-model.html" rel="next">
<link href="./04-explore.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="site_libs/kePrint-0.0.1/kePrint.js"></script><link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script><script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script><script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./05-network.html"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Networks</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Visualization for Social Data Science</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/vis4sds/vis4sds/" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="https://twitter.com/intent/tweet?url=%7Curl%7C" rel="" title="Twitter" class="quarto-navigation-tool px-1" aria-label="Twitter"><i class="bi bi-twitter"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Fundamentals</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-visual.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Visualization Fundamentals</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-explore.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Exploratory Data Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-network.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Networks</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-model.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-uncertainty.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Uncertainty</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-storytelling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Data Storytelling</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./a1-tasks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Task answers</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">5.1</span> Introduction</a></li>
  <li>
<a href="#concepts" id="toc-concepts" class="nav-link" data-scroll-target="#concepts"><span class="header-section-number">5.2</span> Concepts</a>
  <ul class="collapse">
<li><a href="#node-summary" id="toc-node-summary" class="nav-link" data-scroll-target="#node-summary"><span class="header-section-number">5.2.1</span> Node summary</a></li>
  <li><a href="#node-link-representations" id="toc-node-link-representations" class="nav-link" data-scroll-target="#node-link-representations"><span class="header-section-number">5.2.2</span> Node-link representations</a></li>
  <li><a href="#origin-destination-matrices" id="toc-origin-destination-matrices" class="nav-link" data-scroll-target="#origin-destination-matrices"><span class="header-section-number">5.2.3</span> Origin-Destination matrices</a></li>
  <li><a href="#origin-destination-maps" id="toc-origin-destination-maps" class="nav-link" data-scroll-target="#origin-destination-maps"><span class="header-section-number">5.2.4</span> Origin-Destination maps</a></li>
  </ul>
</li>
  <li>
<a href="#techniques" id="toc-techniques" class="nav-link" data-scroll-target="#techniques"><span class="header-section-number">5.3</span> Techniques</a>
  <ul class="collapse">
<li><a href="#import" id="toc-import" class="nav-link" data-scroll-target="#import"><span class="header-section-number">5.3.1</span> Import</a></li>
  <li><a href="#gridmap-layout" id="toc-gridmap-layout" class="nav-link" data-scroll-target="#gridmap-layout"><span class="header-section-number">5.3.2</span> Gridmap layout</a></li>
  <li><a href="#analysing-over-the-nodes-boroughs" id="toc-analysing-over-the-nodes-boroughs" class="nav-link" data-scroll-target="#analysing-over-the-nodes-boroughs"><span class="header-section-number">5.3.3</span> Analysing over the nodes (boroughs)</a></li>
  <li><a href="#analysing-over-edges" id="toc-analysing-over-edges" class="nav-link" data-scroll-target="#analysing-over-edges"><span class="header-section-number">5.3.4</span> Analysing over edges</a></li>
  </ul>
</li>
  <li><a href="#conclusions" id="toc-conclusions" class="nav-link" data-scroll-target="#conclusions"><span class="header-section-number">5.4</span> Conclusions</a></li>
  <li><a href="#further-reading" id="toc-further-reading" class="nav-link" data-scroll-target="#further-reading"><span class="header-section-number">5.5</span> Further Reading</a></li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/vis4sds/vis4sds/edit/master/05-network.qmd" class="toc-action">Edit this page</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="sec-network" class="quarto-section-identifier"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Networks</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><p>By the end of this chapter you should gain the following knowledge and practical skills.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Knowledge
</div>
</div>
<div class="callout-body-container callout-body">
<ul class="task-list">
<li>
<input type="checkbox">Understand the special structure and vocabulary used to represent network data.</li>
<li>
<input type="checkbox">Appreciate the strengths, weaknesses and trade-offs of network visualizations and of incorporating geographic context.</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Practical skills
</div>
</div>
<div class="callout-body-container callout-body">
<ul class="task-list">
<li>
<input type="checkbox">Write <code>ggplot2</code> specifications to analyse spatial network origin-destination data.</li>
</ul>
</div>
</div>
<section id="introduction" class="level2" data-number="5.1"><h2 data-number="5.1" class="anchored" data-anchor-id="introduction">
<span class="header-section-number">5.1</span> Introduction</h2>
<p>Networks are a special class of data used to represent things, entities, and how they relate to one another. Network data consist of two types of element: <em>nodes</em>, the entities themselves, and <em>edges</em>, the connections between nodes. Both nodes and edges can have additional information attached to them – counts, categories and directions. Network data are cumbersome to work with in R as they are not represented well by flat data frames. A common workflow is to split the data across two tables – one representing nodes and one representing edges <span class="citation" data-cites="wickham_ggplot2_2020">(<a href="references.html#ref-wickham_ggplot2_2020" role="doc-biblioref">Wickham, Navarro, and Lin Pedersen 2020</a>)</span>.</p>
<p>A category of network data used heavily in geospatial analysis is origin-destination (OD) data describing, for example, flows of bikes <span class="citation" data-cites="beecham_connected_2023">(<a href="references.html#ref-beecham_connected_2023" role="doc-biblioref">Beecham et al. 2023</a>)</span> and commuters <span class="citation" data-cites="beecham_characterising_2019">(<a href="references.html#ref-beecham_characterising_2019" role="doc-biblioref">Beecham and Slingsby 2019</a>)</span> around a city. These data consist of <em>nodes</em>, origin and destination locations, and <em>edges</em>, flows between those origins and destinations. Whilst statistics from Network Science can and have <span class="citation" data-cites="yang_understanding_2022">(<a href="references.html#ref-yang_understanding_2022" role="doc-biblioref">Yang et al. 2022</a>)</span> been deployed in the analysis of geospatial OD data, visualization techniques provide much assistance in exposing the types of complex structural patterns and relations that result from locating OD flows within geographic context.</p>
<p>In this chapter we will work with an accessible and widely used OD network dataset: Census travel-to-work data recording counts of individuals commuting between Census geographies of the UK based on their home and workplace. Specifically, we will work with data in London recording travel-to-work between the city’s 33 boroughs.</p>
</section><section id="concepts" class="level2" data-number="5.2"><h2 data-number="5.2" class="anchored" data-anchor-id="concepts">
<span class="header-section-number">5.2</span> Concepts</h2>
<section id="node-summary" class="level3" data-number="5.2.1"><h3 data-number="5.2.1" class="anchored" data-anchor-id="node-summary">
<span class="header-section-number">5.2.1</span> Node summary</h3>
<p>The <em>nodes</em> in this dataset are London’s 33 boroughs and the <em>edges</em> are directed OD pairs between these boroughs. In <a href="#fig-flows-bor">Figure&nbsp;<span>5.1</span></a> frequencies of the number of jobs available in each borough and workers living in each borough (the nodes) are represented. Note that job-rich boroughs in central London – Westminster, City of London, Camden, Tower Hamlets – contain many more jobs than workers residing in them. We can infer that there is a high level of in-commuting to those boroughs and the reverse, a high level of out-commuting, for worker-rich boroughs containing large numbers of workers relative to jobs.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-flows-bor" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/05/flows-bor.png" class="img-fluid figure-img" style="width:90.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;5.1: Barchart of jobs and workers contained in London boroughs.</figcaption></figure>
</div>
</div>
</div>
</section><section id="node-link-representations" class="level3" data-number="5.2.2"><h3 data-number="5.2.2" class="anchored" data-anchor-id="node-link-representations">
<span class="header-section-number">5.2.2</span> Node-link representations</h3>
<p>The most common class of network visualization used to represent network data are node-link diagrams. These depict graphs in two dimensions as a force-directed layout. Nodes are positioned such that those sharing greater connection – edges with greater frequencies – are closer than those that are less well-connected – that do not share edges with such large frequencies. Edges are drawn as lines connecting nodes, and so <em>node-link</em> diagrams.</p>
<p>The left graphic in <a href="#fig-lines-geog">Figure&nbsp;<span>5.2</span></a> uses a force-directed layout to represent the travel-to-work data. Nodes, London boroughs, are sized according to the number of jobs and workers they contain and edges, commutes between boroughs, are represented as lines sized by commute frequency. As is often the case with node-link diagrams, the graphic looks complex. Job-rich boroughs, Westminster and City of London, are labelled and have many connecting lines – most likely workers commuting-in from other London boroughs. Other more ‘residential’ boroughs are labelled. Lambeth and Wandsworth, for example, contain many connecting lines – likely residents commuting-out to other London boroughs for work. That these boroughs are close in geographic space as well as force-directed space suggests that, as expected, between-borough commuting is spatially dependent.</p>
<p>To investigate this more directly it makes sense to <em>position</em> nodes with a geographic arrangement. In the right column of <a href="#fig-lines-geog">Figure&nbsp;<span>5.2</span></a>, nodes (boroughs) are placed in their exact geographic position (geometric centroid of boroughs) and line width and colour is used to encode edge frequency. Nodes are again represented with circles sized according to frequency (the total number of jobs and workers contained in the borough) and flow <em>direction</em> is encoded by making flow lines asymmetric, following <span class="citation" data-cites="wood_visualizing_2011">Wood, Slingsby, and Dykes (<a href="references.html#ref-wood_visualizing_2011" role="doc-biblioref">2011</a>)</span>: the straight ends are origins, the curved ends destinations.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-lines-geog" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/05/flowlines.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;5.2: Flowlines with edges showing frequencies between London boroughs.</figcaption></figure>
</div>
</div>
</div>
<p>The geographic positioning of nodes adds context and the encoding of direction provides further detail. For example, the pattern of commuting into central London boroughs versus more peripheral boroughs, with asymmetric flows into Westminster just about detectable and a more symmetric pattern between outer London boroughs. However, there are problems that affect the usefulness of the graphic. Self-contained flows – those that describe individuals living and working in the same borough – are not shown. The graphic is cluttered with a ‘hairball’ effect due to multiple overlapping lines. Longer flows appear more visually dominant than do shorter flows, an unhelpful artefact of the encoding. Also, aggregating to the somewhat arbitrary geometric centre of boroughs and drawing lines between these locations implies an undue level of spatial precision – the geographic pattern of commuting would likely look very different were individual flows encoded with precise OD locations of home and workplace.</p>
</section><section id="origin-destination-matrices" class="level3" data-number="5.2.3"><h3 data-number="5.2.3" class="anchored" data-anchor-id="origin-destination-matrices">
<span class="header-section-number">5.2.3</span> Origin-Destination matrices</h3>
<p>An alternative way to represent these edge frequencies is origin-destination matrices, as in <a href="#fig-reordered-matrix">Figure&nbsp;<span>5.4</span></a>. The columns are destinations, London boroughs into which residents commute for work; the rows are origins, London boroughs from which residents commute out for work. Edge frequencies are encoded using colour value – the darker the colour, the larger the number of commutes between those boroughs. Boroughs are ordered left-to-right and top-to-bottom according to the total number of jobs accessed in each borough.</p>
<p>Whilst using colour lightness rather than line width to show flow magnitude is a less effective encoding channel <span class="citation" data-cites="munzner_visualization_2014">(following <a href="references.html#ref-munzner_visualization_2014" role="doc-biblioref">Munzner 2014</a>)</span>, there are obvious advantages. The salience bias of longer flows is removed – every OD pair, 1039 in total (<span class="math inline">33^2</span>), is given equal graphic saliency. Ordering cells of the matrix by destination size (number of jobs accessed in each borough) helps to emphasise patterns in the job-rich boroughs, but also encourages within and between borough comparison. For example, the lack of colour outside of the diagonals in the less job-rich boroughs, which also tend to be in outer London, suggests that labour markets there might be more self-contained. By applying a local scaling on destination (right plot), we can explore commutes into individual boroughs in a more detailed way. The vertical strips of blue for other job-rich central and inner London boroughs (Hammersmith &amp; Fulham and Kensington &amp; Chelsea), suggesting reasonably high-levels of in-commuting to access jobs there.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-matrices" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/05/matrices.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;5.3: Origin-destination matrices ordered according to borough size on number of jobs. A separate, local, colour scale is created for each destination borough.</figcaption></figure>
</div>
</div>
</div>
</section><section id="origin-destination-maps" class="level3" data-number="5.2.4"><h3 data-number="5.2.4" class="anchored" data-anchor-id="origin-destination-maps">
<span class="header-section-number">5.2.4</span> Origin-Destination maps</h3>
<p>The OD matrices expose new structure that could not be so easily inferred from the node-link visualizations. Although their layout is space-efficient, clearly for phenomena such as commuting geographic context is highly relevant. <a href="https://xeno.graphics/od-map/">OD maps</a> <span class="citation" data-cites="wood_visualisation_2010">(<a href="references.html#ref-wood_visualisation_2010" role="doc-biblioref">Wood, Dykes, and Slingsby 2010</a>)</span> are matrices that make better use of layout and position to support the spatial dimension of analysis. They take a little to get your head around, but the idea is elegant.</p>
<p>OD maps contains exactly the same cells as an OD matrix, but the cells are re-ordered with an approximate geographic arrangement, as in the right column of <a href="#fig-reordered-matrix">Figure&nbsp;<span>5.4</span></a>. So, for example, we may be interested in focussing on <em>destination</em>, or workplace, boroughs. In the first highlighted example, commutes into Westminster are considered (the left-most column of the OD matrix). Cells in the highlighted column are coloured according to the number of workers resident in each borough that travel into Westminster for work. In the inset map to the right these cells are then re-ordered with an approximate spatial arrangement. The geographic ordering allows us to see that residents access jobs in Westminster in large numbers from many boroughs in London, but especially from Wandsworth (Wns), Lambeth (Lmb) and Southwark (Sth) to the south of Westminster (Wst). In the second example, we focus on <em>origins</em>: commutes out of Hackney are considered (the middle row). Cells in the highlighted row are coloured according to the number of jobs accessed in each borough by residents travelling out of Hackney for work. Cells are again reordered in the inset map. This demonstrates that patterns of commuting are reasonably localised. The modal destination/workplace borough remains Westminster, but relatively large numbers of jobs are accessed in Camden (Cmd), Islington (Isl), Tower Hamlets (TwH) and the City of London (CoL).</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-reordered-matrix" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/05/reordered_matrix.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;5.4: Origin-destination matrices: highlighted destination (Westminster) and origin (Hackney) with geospatial arrangement.</figcaption></figure>
</div>
</div>
</div>
<p>OD maps extend this idea by displaying <em>all cells</em> of the OD matrix with a geographic arrangement. This is achieved via a ‘map-within-map’ layout (<a href="#fig-map-map">Figure&nbsp;<span>5.5</span></a>), made possible by the fact that the gridmap arrangement contains regularly-sized cells.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-map-map" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/05/map_map.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;5.5: Map-witin-map layout required for generating OD maps. The approximate spatial arrangement is generated with the <a href="https://www.roger-beecham.com/gridmappr/index.html">gridmappr</a> package <span class="citation" data-cites="beecham_gridmappr_2023">(<a href="references.html#ref-beecham_gridmappr_2023" role="doc-biblioref">Beecham 2023</a>)</span>.</figcaption></figure>
</div>
</div>
</div>
<p>In the destination-focussed example in <a href="#fig-odmap">Figure&nbsp;<span>5.6</span></a>, each larger (reference) cell identifies destinations and the smaller cells are coloured according to origins – the number of residents in each borough commuting into the reference cell for work. The map uses a local colour scaling, with same origin-destination cells removed. Flow counts are summarised over each reference borough (destination in this case) and normalised according to the maximum flow count for that reference borough. The local scaling allows us to characterise the geography of commuting into boroughs in some detail. The two job-rich boroughs, Westminster and City of London, clearly draw workers in large proportions across London boroughs and to a lesser extent this is the case for other central/inner boroughs such as Islington (Isl), Camden (Cmd) and Tower Hamlets (TwH). For outer London boroughs commuting patterns are more localised. Large numbers of available jobs are filled by workers living in immediately neighbouring boroughs. Readers familiar with London’s geography may notice that inner London boroughs south of the river – Lambeth (Lam), Wandsworth (Wnd), Southwark (Sth) – tend to draw workers in greater number from boroughs that are also south of the river.</p>
<!-- Most often this maximum flow count (darkest blue) is  the reference cell -- residents living and working in the same borough. The City of London, which contains many jobs but few residents, is the obvious exception. -->
<p><!-- As demonstrated in @fig-flows-bor, Westminster contains a large portion of jobs filled by London residents. Because of  this dominant pattern it would be difficult to read too much into the patterns of commuting outside of Westminster were a local scaling not used.  --></p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-odmap" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/05/od_map.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;5.6: Destination-focussed OD map of commutes between London boroughs with local scaling.</figcaption></figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task 1
</div>
</div>
<div class="callout-body-container callout-body">
<p>Although OD maps overcome several problems of flow-line based visualizations and share several of the characteristics of effective data graphics discussed in Chapter <a href="03-visual.html"><span>3</span></a>, they do require some interpretation, especially when seen for the first time.</p>
<p>Test your knowledge by completing the following look-up tasks based on <a href="#fig-odmap">Figure&nbsp;<span>5.6</span></a>):</p>
<ul>
<li><p>For jobs filled in the City of London (CoL) from which borough does the largest number of workers commute?</p></li>
<li><p>For jobs filled in Camden (Cmd) from which borough does the largest number of workers commute?</p></li>
<li><p>Eyeballing the graphic, identify the top 3 boroughs which appear to have the most localised labour markets in terms of in-commuting?</p></li>
</ul>
</div>
</div>
<!--
::: {.callout-note}
## OD maps versus node-link diagrams
The analysis above might give the impression that OD maps should be used in preference to node-link diagrams. As always, this depends on dataset and analysis task. In @fig-flowline-bike is a map displaying bikeshare flow data for the London Cycle Hire Scheme (LCHS), collected via the bikedata package. The LCHS consists of c.700 docking stations in London – so c. $700^2$ grid cells if the grid-within-grid layout of an OD map were to be used, which would certainly present a design challenge. If a synoptic overview of spatial patterns is necessary, the more intuitive node-link representation is perhaps more successful than the OD map in any case. Additionally, different from Census commutes, there is geographic precision in the spatial coordinates representing origins and destinations in the bikeshare dataset, and distance judgements seem important when exploring cycling trips -- an argument against the spatial distortion required by OD maps.
-->
<!-- In the graphic below, trips that take place in the morning peak are selected. The dominant pattern is of flows from London’s main commuter rail terminals – King’s Cross and Waterloo – to central London and City of London respectively. The asymmetric bezier curves efficiently communicate this and the reverse pattern when trips in the evening peak are filtered. -->
<!-- :::  -->
</section></section><section id="techniques" class="level2" data-number="5.3"><h2 data-number="5.3" class="anchored" data-anchor-id="techniques">
<span class="header-section-number">5.3</span> Techniques</h2>
<p>The technical element to this chapter continues in our analysis of 2011 Census travel-to-work data. After importing the dataset, we will organise the flow data into nodes and edges before creating graphics that summarise over the nodes (London boroughs in this case) and reveal spatial structure in the edges (OD flows between boroughs). A focus for the analysis is on how the geography of travel-to-work varies by occupation type.</p>
<section id="import" class="level3" data-number="5.3.1"><h3 data-number="5.3.1" class="anchored" data-anchor-id="import">
<span class="header-section-number">5.3.1</span> Import</h3>
<ul>
<li>Download the <a href="./files/05-template.qmd">05-template.qmd</a> file for this chapter and save it to your <code>vis4sds</code> project.</li>
<li>Open your <code>vis4sds</code> project in RStudio and load the template file by clicking <code>File</code> &gt; <code>Open File ...</code> &gt; <code>05-template.qmd</code>.</li>
</ul>
<p>A <code>.csv</code> file containing Census travel-to-work data in London has been stored in the book’s accompanying <a href="https://github.com/vis4sds/data">data repository</a>. Code for downloading the data is in the template file. The data can then be read into your session in the usual way.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Read in local copies of the Census travel-to-work data.</span></span>
<span><span class="va">od_pairs</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"london_ttw.csv"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In order to generate an approximate geographic arrangement of London boroughs we will use the <a href="https://www.roger-beecham.com/gridmappr/index.html"><code>gridmappr</code></a> R package <span class="citation" data-cites="beecham_gridmappr_2023">(<a href="references.html#ref-beecham_gridmappr_2023" role="doc-biblioref">Beecham 2023</a>)</span>. The development version can be downloaded with:</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">"rogerbeecham/gridmappr"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>od_pairs</code> dataset, <a href="#tbl-census-ods">Table&nbsp;<span>5.1</span></a>, has the following structure. This is effectively an <em>edges</em> table. Each observation is a unique OD pair summarising the total number of recorded commuters between a pair of London boroughs for a stated occupation type.</p>
<div class="cell">
<div class="cell-output-display">
<div id="tbl-census-ods" class="anchored">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<caption>Table&nbsp;5.1: Census OD travel-to-work data: edges (OD flows) table.</caption>
<thead><tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">o_bor</th>
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">d_bor</th>
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">occ_type</th>
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">count</th>
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">is_prof</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left; width: 8em;">Barnet</td>
<td style="text-align: left; width: 8em;">Westminster</td>
<td style="text-align: left; width: 8em;">1_managers_senior</td>
<td style="text-align: left; width: 8em;">2733</td>
<td style="text-align: left; width: 8em; font-family: Monospace;">TRUE</td>
</tr>
<tr class="even">
<td style="text-align: left; width: 8em;">Barnet</td>
<td style="text-align: left; width: 8em;">Westminster</td>
<td style="text-align: left; width: 8em;">2_professional</td>
<td style="text-align: left; width: 8em;">4055</td>
<td style="text-align: left; width: 8em; font-family: Monospace;">TRUE</td>
</tr>
<tr class="odd">
<td style="text-align: left; width: 8em;">Barnet</td>
<td style="text-align: left; width: 8em;">Westminster</td>
<td style="text-align: left; width: 8em;">3_associate_professional</td>
<td style="text-align: left; width: 8em;">2977</td>
<td style="text-align: left; width: 8em; font-family: Monospace;">TRUE</td>
</tr>
<tr class="even">
<td style="text-align: left; width: 8em;">Barnet</td>
<td style="text-align: left; width: 8em;">Westminster</td>
<td style="text-align: left; width: 8em;">4_administrative</td>
<td style="text-align: left; width: 8em;">2674</td>
<td style="text-align: left; width: 8em; font-family: Monospace;">FALSE</td>
</tr>
<tr class="odd">
<td style="text-align: left; width: 8em;">Barnet</td>
<td style="text-align: left; width: 8em;">Westminster</td>
<td style="text-align: left; width: 8em;">5_trade</td>
<td style="text-align: left; width: 8em;">687</td>
<td style="text-align: left; width: 8em; font-family: Monospace;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: left; width: 8em;">Barnet</td>
<td style="text-align: left; width: 8em;">Westminster</td>
<td style="text-align: left; width: 8em;">6_caring_leisure</td>
<td style="text-align: left; width: 8em;">755</td>
<td style="text-align: left; width: 8em; font-family: Monospace;">FALSE</td>
</tr>
<tr class="odd">
<td style="text-align: left; width: 8em;">Barnet</td>
<td style="text-align: left; width: 8em;">Westminster</td>
<td style="text-align: left; width: 8em;">7_sales_customer</td>
<td style="text-align: left; width: 8em;">1255</td>
<td style="text-align: left; width: 8em; font-family: Monospace;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: left; width: 8em;">Barnet</td>
<td style="text-align: left; width: 8em;">Westminster</td>
<td style="text-align: left; width: 8em;">8_machine_operatives</td>
<td style="text-align: left; width: 8em;">257</td>
<td style="text-align: left; width: 8em; font-family: Monospace;">FALSE</td>
</tr>
<tr class="odd">
<td style="text-align: left; width: 8em;">Barnet</td>
<td style="text-align: left; width: 8em;">Westminster</td>
<td style="text-align: left; width: 8em;">9_elementary</td>
<td style="text-align: left; width: 8em;">1309</td>
<td style="text-align: left; width: 8em; font-family: Monospace;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: left; width: 8em;">...</td>
<td style="text-align: left; width: 8em;">...</td>
<td style="text-align: left; width: 8em;">...</td>
<td style="text-align: left; width: 8em;">...</td>
<td style="text-align: left; width: 8em; font-family: Monospace;">...</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
<p>Nodes in the dataset are the 33 London boroughs. We can express commuters between these nodes in different ways, according to whether nodes are destinations or origins. In the code below, two tables are generated with OD data grouped by destination (<code>nodes_d</code>) and origin (<code>nodes_o</code>) and commuters into- and out of- boroughs counted respectively. These two data sets are then accumulated with <code>bind_rows()</code> and distinguished via the variable name <code>type</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nodes_d</span> <span class="op">&lt;-</span> <span class="va">od_pairs</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">d_bor</span>, <span class="va">occ_type</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span>count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span>, is_prof <span class="op">=</span> <span class="fu">first</span><span class="op">(</span><span class="va">is_prof</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">rename</span><span class="op">(</span>la <span class="op">=</span> <span class="va">d_bor</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>type<span class="op">=</span><span class="st">"jobs"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nodes_o</span> <span class="op">&lt;-</span> <span class="va">od_pairs</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">o_bor</span>, <span class="va">occ_type</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span>count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span>, is_prof <span class="op">=</span> <span class="fu">first</span><span class="op">(</span><span class="va">is_prof</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">rename</span><span class="op">(</span>la <span class="op">=</span> <span class="va">o_bor</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>type<span class="op">=</span><span class="st">"workers"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nodes</span>  <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">nodes_o</span>, <span class="va">nodes_d</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="tbl-nodes-table" class="anchored">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<caption>Table&nbsp;5.2: Census OD travel-to-work data: nodes (boroughs) table.</caption>
<thead><tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">local_authority</th>
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">is_prof</th>
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">count</th>
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">type</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left; width: 55%;">Barking and Dagenham</td>
<td style="text-align: left; font-family: Monospacewidth;">TRUE</td>
<td style="text-align: left; width: 15%;">3745</td>
<td style="text-align: left;">workers</td>
</tr>
<tr class="even">
<td style="text-align: left; width: 55%;">Barking and Dagenham</td>
<td style="text-align: left; font-family: Monospacewidth;">TRUE</td>
<td style="text-align: left; width: 15%;">7841</td>
<td style="text-align: left;">workers</td>
</tr>
<tr class="odd">
<td style="text-align: left; width: 55%;">Barking and Dagenham</td>
<td style="text-align: left; font-family: Monospacewidth;">TRUE</td>
<td style="text-align: left; width: 15%;">5243</td>
<td style="text-align: left;">workers</td>
</tr>
<tr class="even">
<td style="text-align: left; width: 55%;">Barking and Dagenham</td>
<td style="text-align: left; font-family: Monospacewidth;">FALSE</td>
<td style="text-align: left; width: 15%;">8592</td>
<td style="text-align: left;">workers</td>
</tr>
<tr class="odd">
<td style="text-align: left; width: 55%;">Barking and Dagenham</td>
<td style="text-align: left; font-family: Monospacewidth;">FALSE</td>
<td style="text-align: left; width: 15%;">3990</td>
<td style="text-align: left;">workers</td>
</tr>
<tr class="even">
<td style="text-align: left; width: 55%;">Barking and Dagenham</td>
<td style="text-align: left; font-family: Monospacewidth;">FALSE</td>
<td style="text-align: left; width: 15%;">6635</td>
<td style="text-align: left;">workers</td>
</tr>
<tr class="odd">
<td style="text-align: left; width: 55%;">Barking and Dagenham</td>
<td style="text-align: left; font-family: Monospacewidth;">FALSE</td>
<td style="text-align: left; width: 15%;">5797</td>
<td style="text-align: left;">workers</td>
</tr>
<tr class="even">
<td style="text-align: left; width: 55%;">Barking and Dagenham</td>
<td style="text-align: left; font-family: Monospacewidth;">FALSE</td>
<td style="text-align: left; width: 15%;">4396</td>
<td style="text-align: left;">workers</td>
</tr>
<tr class="odd">
<td style="text-align: left; width: 55%;">Barking and Dagenham</td>
<td style="text-align: left; font-family: Monospacewidth;">FALSE</td>
<td style="text-align: left; width: 15%;">7998</td>
<td style="text-align: left;">workers</td>
</tr>
<tr class="even">
<td style="text-align: left; width: 55%;">Barking and Dagenham</td>
<td style="text-align: left; font-family: Monospacewidth;">TRUE</td>
<td style="text-align: left; width: 15%;">2667</td>
<td style="text-align: left;">jobs</td>
</tr>
<tr class="odd">
<td style="text-align: left; width: 55%;">...</td>
<td style="text-align: left; font-family: Monospacewidth;">...</td>
<td style="text-align: left; width: 15%;">...</td>
<td style="text-align: left;">...</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
</section><section id="gridmap-layout" class="level3" data-number="5.3.2"><h3 data-number="5.3.2" class="anchored" data-anchor-id="gridmap-layout">
<span class="header-section-number">5.3.2</span> Gridmap layout</h3>
<p>We will analyse over the nodes and edges (flows) data by laying out data graphics with a geo-spatial arrangement. Such arrangements can be automatically created using the <a href="https://www.roger-beecham.com/gridmappr/index.html"><code>gridmappr</code></a> R package <span class="citation" data-cites="beecham_gridmappr_2023">(<a href="references.html#ref-beecham_gridmappr_2023" role="doc-biblioref">Beecham 2023</a>)</span>. Given a set of point locations the package creates a two-dimensional grid of user-specified dimensions and allocates points to the grid such that the distance between points in geographic and grid space is minimised. The main function to call is <code>points_to_grid()</code>. This takes a tibble of geographic points and returns grid cell positions (<em>row</em> and <em>column</em> identifiers). In the code below an 8x8 grid is used. The allocation is also constrained by a <em>compactness</em> parameter which determines the extent to which points are allocated to cells in the centre (<span class="math inline">compactness = 1</span>), edges (<span class="math inline">0</span>) or scaled geographic location (<span class="math inline">0.5</span>) within the grid.</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">gridmappr</span><span class="op">)</span></span>
<span><span class="va">n_row</span> <span class="op">&lt;-</span> <span class="fl">8</span></span>
<span><span class="va">n_col</span> <span class="op">&lt;-</span> <span class="fl">8</span></span>
<span><span class="va">pts</span> <span class="op">&lt;-</span> <span class="va">london_boroughs</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">st_drop_geometry</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">area_name</span>, x <span class="op">=</span> <span class="va">easting</span>, y <span class="op">=</span> <span class="va">northing</span><span class="op">)</span></span>
<span><span class="va">solution</span> <span class="op">&lt;-</span> <span class="fu">points_to_grid</span><span class="op">(</span><span class="va">pts</span>, <span class="va">n_row</span>, <span class="va">n_col</span>, compactness <span class="op">=</span> <span class="fl">.6</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once a layout is generated we create a corresponding polygon object so that it can be plotted. This is achieved with <code>make_grid()</code>. This function takes an <code>sf</code> data frame containing polygons with ‘real’ geography and returns an <code>sf</code> data frame representing a grid, with variables identifying column and row IDs (bottom left is origin) and geographic centroids of grid squares. The gridded object can then be joined on a gridmap solution returned from <code>points_to_grid()</code> in order to create an object in which each grid cell corresponds to a gridmap cell position.</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">grid</span> <span class="op">&lt;-</span> <span class="fu">make_grid</span><span class="op">(</span><span class="va">london_boroughs</span>, <span class="va">n_row</span>, <span class="va">n_col</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">inner_join</span><span class="op">(</span><span class="va">solution</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To evaluate different layouts that could be generated from differently specified grid dimensions and/or compactness values, it can be useful to encode explicitly the geographic distortion introduced when moving centroids to regularly sized grid cells. In the example below, displacement vectors are drawn connecting the centroid of each borough in London in <em>real</em> and <em>grid</em> space. This is achieved with <code>get_trajectory()</code> from the <a href="https://github.com/rogerbeecham/odvis"><code>odvis</code></a> package.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-displacements" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/05/displacements.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;5.7: Displacement vectors showing distortion introduced by candidate gridmap layouts</figcaption></figure>
</div>
</div>
</div>
<p>The code is slightly more advanced. Some concepts, for example functional-style programming with <code>map()</code>, are discussed in a more involved way in later chapters. First, we combine the real and grid geographies in a single data frame. Then we <code>map()</code> over each real-to-grid location pair calling <code>get_trajectory()</code> to generate a data frame of trajectories – origins, destinations and control points, which affect the path of the vectors so that they curve towards the destination. Finally trajectories are plotted with <code>geom_bezier()</code> from the <a href="https://ggforce.data-imaginist.com/"><code>ggforce</code></a> package extending ggplot2, with separate lines (<code>group=</code>) for each real-to-grid OD pair.</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Install odvis.</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">"rogerbeecham/odvis"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">odvis</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine the grid and london_boroughs (real geography)</span></span>
<span><span class="co"># objects into a single simple features data frame.</span></span>
<span><span class="va">lon_geogs</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span></span>
<span>  <span class="va">london_boroughs</span> <span class="op">|&gt;</span> <span class="fu">mutate</span><span class="op">(</span>type <span class="op">=</span> <span class="st">"real"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="va">area_name</span>, x <span class="op">=</span> <span class="va">easting</span>, y <span class="op">=</span> <span class="va">northing</span>, <span class="va">type</span><span class="op">)</span>,</span>
<span>  <span class="va">grid</span> <span class="op">|&gt;</span>  <span class="fu">mutate</span><span class="op">(</span>type <span class="op">=</span> <span class="st">"grid"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="va">area_name</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">type</span>, geometry <span class="op">=</span> <span class="va">geom</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create points for drawing trajectories</span></span>
<span><span class="co"># -- origin, destination and control point locations.</span></span>
<span><span class="va">trajectories</span> <span class="op">&lt;-</span> <span class="va">lon_geogs</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">st_drop_geometry</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">area_name</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">type</span>, values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>id <span class="op">=</span> <span class="fu">row_number</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">nest</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">area_name</span>, <span class="va">x_real</span>, <span class="va">y_real</span>, <span class="va">x_grid</span>, <span class="va">y_grid</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>trajectory <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">data</span>,</span>
<span>      <span class="op">~</span><span class="fu">get_trajectory</span><span class="op">(</span></span>
<span>        <span class="va">.x</span><span class="op">$</span><span class="va">x_real</span>, <span class="va">.x</span><span class="op">$</span><span class="va">y_real</span>, <span class="va">.x</span><span class="op">$</span><span class="va">x_grid</span>, <span class="va">.x</span><span class="op">$</span><span class="va">y_grid</span>, <span class="va">.x</span><span class="op">$</span><span class="va">area_name</span></span>
<span>        <span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">trajectory</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">unnest</span><span class="op">(</span>cols <span class="op">=</span> <span class="va">trajectory</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot displacement vectors.</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">lon_geogs</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">type</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"real"</span>, <span class="st">"grid"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">type</span>, colour <span class="op">=</span> <span class="va">type</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">.2</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggforce</span><span class="fu">::</span><span class="fu">geom_bezier</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">trajectories</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, group <span class="op">=</span> <span class="va">od_pair</span><span class="op">)</span>,</span>
<span>    colour <span class="op">=</span> <span class="st">"#08306b"</span>, linewidth <span class="op">=</span> <span class="fl">.4</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#f0f0f0"</span>, <span class="st">"transparent"</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_colour_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#FFFFFF"</span>, <span class="st">"#525252"</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="analysing-over-the-nodes-boroughs" class="level3" data-number="5.3.3"><h3 data-number="5.3.3" class="anchored" data-anchor-id="analysing-over-the-nodes-boroughs">
<span class="header-section-number">5.3.3</span> Analysing over the nodes (boroughs)</h3>
<p>In <a href="#fig-nodes-summary">Figure&nbsp;<span>5.8</span></a> are gridmaps summarising over the nodes (boroughs). The number of workers living in each borough (left column) and jobs available in each borough (right column) is encoded using circle size, with circles positioned in <em>x</em>, <em>y</em> at the centroids of the geospatial grid layout. Frequencies are shown separately for <em>professional</em> and <em>non-professional</em> occupation types. If you are familiar with London’s social geography the patterns can be understood. There are comparatively more non-professional workers living in the somewhat more affordable boroughs in outer and east London; and job-rich central London boroughs – Westminster Wst, Camden Cmd, City of London CoL, Tower Hamlets TwH – provide a large number of particularly <em>professional</em> jobs.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-nodes-summary" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/05/nodes_summary.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;5.8: Workers and jobs in London borough by occupation class. Bars counts are locally-scaled by borough.</figcaption></figure>
</div>
</div>
</div>
<p>The code for <a href="#fig-nodes-summary">Figure&nbsp;<span>5.8</span></a>:</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">grid</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">inner_join</span><span class="op">(</span></span>
<span>    <span class="va">nodes</span> <span class="op">|&gt;</span> <span class="fu">group_by</span><span class="op">(</span><span class="va">la</span>, <span class="va">is_prof</span>, <span class="va">type</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">summarise</span><span class="op">(</span>count<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"area_name"</span> <span class="op">=</span> <span class="st">"la"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    is_prof <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="fu">if_else</span><span class="op">(</span></span>
<span>      <span class="va">is_prof</span>, <span class="st">"professional"</span>, <span class="st">"non-professional"</span><span class="op">)</span>,</span>
<span>      levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"professional"</span>, <span class="st">"non-professional"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">type</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"workers"</span>, <span class="st">"jobs"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#EEEEEE"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>size <span class="op">=</span> <span class="va">count</span>, colour <span class="op">=</span> <span class="va">is_prof</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span></span>
<span>    <span class="fu">aes</span><span class="op">(</span>size <span class="op">=</span> <span class="va">count</span>, colour <span class="op">=</span> <span class="va">is_prof</span><span class="op">)</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"transparent"</span>, pch <span class="op">=</span> <span class="fl">21</span>, stroke <span class="op">=</span> <span class="fl">.5</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_grid</span><span class="op">(</span><span class="va">is_prof</span> <span class="op">~</span> <span class="va">type</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#67000d"</span>, <span class="st">"#08306b"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_colour_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#67000d"</span>, <span class="st">"#08306b"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>ggplot2</code> spec:</p>
<ol type="1">
<li>
<em>Data</em>: From the derived <code>nodes</code> tibble we count workers and jobs (<code>type</code>) by borough, collapsed over professional or non-professional occupation types (<code>is_prof</code>). Note that we also start by joining on <code>grid</code> in order to bring in the polygon file and coordinates of the generated gridmap. Converting <code>is_prof</code> and <code>type</code> to factor variables, the <code>mutate()</code>, gives us control over the order in which they appear in the plot.</li>
<li>
<em>Encoding</em>: the proportional symbols are positioned at the centroids of borough grid cells (<em>x, y</em>), sized according to count of jobs or workers and coloured according to occupation type (<code>is_prof</code>).</li>
<li>
<em>Marks</em>: <code>geom_point()</code> for proportional symbols and <code>geom_sf()</code> for grid outline – remember our dataset is now of class <code>sf</code> as we joined on the <code>grid</code> object.</li>
<li>
<em>Scale</em>: <code>scale_fill/colour_manual()</code> for associating occupation type.</li>
<li>
<em>Facets</em>: <code>facet_wrap()</code> on workers/jobs summary type and high-level occupation type (<code>is_prof</code>).</li>
</ol>
<p>In <a href="#fig-nodes-summary">Figure&nbsp;<span>5.8</span></a>, we collapsed over nine occupation types in order to plot proportional-symbol maps. Since gridmaps consist of regularly-sized cells, we can introduce more complex graphical summaries with a geographical arrangement. For example, <a href="#fig-nodes-bars">Figure&nbsp;<span>5.9</span></a> uses bar charts to analyse the number of workers (left-pointing bars) and jobs (right-pointing bars) by occupation type across the the full nine occupation classes. In the selected examples below, jobs and workers are differentiated by varying the direction of bars: pointing to the right for jobs, to the left for workers. The counts are locally (borough-level) scaled. For each borough, its modal category count of jobs/workers is found and bar length is scaled relative to this modal category. This encoding allows us to distinguish between job-rich boroughs with longer bars pointing to the right (Westminster); resident/worker-rich boroughs with longer bars pointing to the left (Wandsworth); and outer London boroughs that are more self-contained (Hillingdon).</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-nodes-bars" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/05/nodes_bars.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;5.9: Workers and jobs in selected London boroughs by full occupation classes</figcaption></figure>
</div>
</div>
</div>
<p>The code for <a href="#fig-nodes-bars">Figure&nbsp;<span>5.9</span></a>:</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="va">solution</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">inner_join</span><span class="op">(</span><span class="va">nodes</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"area_name"</span> <span class="op">=</span> <span class="st">"la"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">area_name</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>count <span class="op">=</span> <span class="va">count</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    count <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"jobs"</span>, <span class="va">count</span>, <span class="op">-</span><span class="va">count</span><span class="op">)</span>,</span>
<span>    occ_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">occ_type</span><span class="op">)</span>,</span>
<span>    occ_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu">fct_rev</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">occ_type</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">plot_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">area_name</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Wandsworth"</span>, <span class="st">"Westminster"</span>, <span class="st">"Bexley"</span>, <span class="st">"Hillingdon"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">occ_type</span>, y <span class="op">=</span> <span class="va">count</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_col</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">is_prof</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">.5</span>, width <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linewidth <span class="op">=</span> <span class="fl">.4</span>, colour <span class="op">=</span> <span class="st">"#ffffff"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">area_name</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#08306b"</span>, <span class="st">"#67000d"</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_flip</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The ggplot2 spec:</p>
<ol type="1">
<li>
<em>Data</em>: We create a staged dataset for plotting (<code>plot_data</code>). The different bar directions for workers/jobs is achieved by a slight hack – changing the polarity of counts by occupation depending on the summary <code>type</code>. Additionally in this staged dataset counts are further locally (borough-level) scaled. Note that we <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> on some selected boroughs.</li>
<li>
<em>Encoding</em>: Bars whose length (<code>y=</code>) varies according to <code>count</code> and categorical position (<code>x=)</code> according to <code>occ_type</code>, filled on high-level (professional / non-professional – <code>is_prof</code>) occupation type.</li>
<li>
<em>Marks</em>: <code>geom_col()</code> for bars.</li>
<li>
<em>Scale</em>: <code>scale_fill_manual()</code> for associating occupation type, <code>scale_x_continuous()</code> for making sure workers/jobs bars use the same scale.</li>
<li>
<em>Facets</em>: <code>facet_wrap()</code> on borough (<code>area_name</code>).</li>
<li>
<em>Setting</em>: <code>coord_flip()</code> for bars that are oriented horizontally.</li>
</ol>
<p>Adding a geospatial arrangement, as in <a href="#fig-nodes-gridmap">Figure&nbsp;<span>5.10</span></a>, can further help with exploring the geography to these different categories of borough. More balanced boroughs to the east (Barking and Dagenham BaD) and west (Hillingdon Hil); worker-rich boroughs (left-pointing bars) with large proportions of professional workers in west and south west London boroughs (Wandsworth Wnd, Richmond Upon Thames RuT); job-rich boroughs (right-pointing bars) in central London (Westminster Wst, Camden Cmd).</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-nodes-gridmap" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/05/nodes_gridmap.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;5.10: Workers and jobs in London boroughs by full occupation classes.</figcaption></figure>
</div>
</div>
</div>
<p>Different from the proportional-symbol maps, the spatial arrangement in <a href="#fig-nodes-gridmap">Figure&nbsp;<span>5.10</span></a> is generated using ggplot2’s in-built faceting rather than a spatial polygon file. This can be understood when remembering that gridmap layouts created by <code>points_to_grid()</code> define <em>row</em> and <em>column</em> identifiers for each spatial unit. The only update to the bar chart code is that we supply <em>row</em> and <em>col</em> identifiers to <code>facet_grid()</code>, with a slight hack on the <em>row</em> variable (<code>-row</code>) as <code>gridmappr</code>’s origin <em>[min-row, min-col]</em> is the bottom-left cell in the grid whereas for <code>facet_grid()</code> the origin is the top-left.</p>
<p>The code for <a href="#fig-nodes-gridmap">Figure&nbsp;<span>5.10</span></a> is below, simply updating the early code with a call to <code>facet_grid()</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">occ_type</span>, y <span class="op">=</span> <span class="va">count</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_col</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">is_prof</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">.5</span>, width <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linewidth <span class="op">=</span> <span class="fl">.4</span>, colour <span class="op">=</span> <span class="st">"#ffffff"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_grid</span><span class="op">(</span><span class="op">-</span><span class="va">row</span> <span class="op">~</span> <span class="va">col</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#08306b"</span>, <span class="st">"#67000d"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_flip</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="analysing-over-edges" class="level3" data-number="5.3.4"><h3 data-number="5.3.4" class="anchored" data-anchor-id="analysing-over-edges">
<span class="header-section-number">5.3.4</span> Analysing over edges</h3>
<p>To study the geography of flows between boroughs, we can update our ggplot2 specification to generate a full OD map. In the example in <a href="#fig-edges-odmap">Figure&nbsp;<span>5.11</span></a>, there is a little more thinking around patterns in the data that we wish to explore, borrowing from the ideas introduced in the previous chapter.</p>
<p>We’ve identified differences in where professional jobs and workers are located in London and it would reasonable to expect that flows between boroughs also have an uneven geography. To explore this, we can set up a model that assumes that commuter flows between boroughs distribute uniformly across London. Of all commutes between London boroughs, 51% are to access <em>professional</em> jobs (<code>global_prof</code>). Under an assumption of uniformity, were we to randomly sample an OD (borough-borough) commute pair, we would expect to see this proportion when counting up the number of professional and non-professional occupation types present in that commute. For each origin-destination pair (OD), we therefore generate expected counts by multiplying the total number of commuters present in an OD pair by this <code>global_prof</code>, and from here signed residuals (<code>resid</code>) identifying whether there are greater or fewer professionals commuting that OD pair than would be expected. Note that these are like the signed chi-scores in the previous chapter in that rather than expressing differences in observed counts as a straight proportion of expected counts (dividing by expected counts), we apply a power transform that is <span class="math inline">&lt;1.0</span> to the denominator. This has the effect of also giving saliency to differences that are large in absolute terms. You could try varying this exponent (maybe between 0.5-1.0) to see its effect on residuals when encoded using colour in the OD map.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-edges-odmap" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/05/edges_odmap.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;5.11: Commutes between London boroughs: difference maps by occupation type assuming <em>professional</em> and <em>non-professional</em> distribute uniformly across London.</figcaption></figure>
</div>
</div>
</div>
<p><a href="#fig-edges-odmap">Figure&nbsp;<span>5.11</span></a> is a D-OD map; the large reference cells are destination boroughs (workplaces) and the small cells origins (residences) from which workers travel to access jobs in the reference cell. From this we observe that job-rich boroughs in central London are associated more with professional occupations and draw professional commuters especially from ‘residential’ boroughs such as Wandsworth (Wnd), Hammersmith and Fulham (HaF). Note that the darker colours indicate that these job-rich boroughs also attract workers in large number from boroughs across London. By contrast, boroughs in outer London do not draw workers from other boroughs in such large number and the very dark blues in the reference cells suggest that, as might be expected, the labour market for non-professional jobs is more localised.</p>
<p>The code:</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">edges</span> <span class="op">&lt;-</span> <span class="va">od_pairs</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">o_bor</span>, <span class="va">d_bor</span><span class="op">)</span>  <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span></span>
<span>    commutes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span>,</span>
<span>    is_prof <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">[</span><span class="va">is_prof</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    prop_prof<span class="op">=</span> <span class="va">is_prof</span><span class="op">/</span><span class="va">commutes</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">grid</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"o_bor"</span><span class="op">=</span><span class="st">"area_name"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">st_drop_geometry</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">geom</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">rename</span><span class="op">(</span>o_x<span class="op">=</span><span class="va">x</span>, o_y<span class="op">=</span><span class="va">y</span>, o_col<span class="op">=</span><span class="va">col</span>, o_row<span class="op">=</span><span class="va">row</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">grid</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"d_bor"</span><span class="op">=</span><span class="st">"area_name"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">st_drop_geometry</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">geom</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">rename</span><span class="op">(</span>d_x<span class="op">=</span><span class="va">x</span>, d_y<span class="op">=</span><span class="va">y</span>, d_col<span class="op">=</span><span class="va">col</span>, d_row<span class="op">=</span><span class="va">row</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="va">edges</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    non_prof <span class="op">=</span> <span class="va">commutes</span><span class="op">-</span><span class="va">is_prof</span>,</span>
<span>    prof <span class="op">=</span> <span class="va">is_prof</span>,</span>
<span>    global_prof <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">prof</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">prof</span> <span class="op">+</span> <span class="va">non_prof</span><span class="op">)</span>,</span>
<span>    count <span class="op">=</span> <span class="va">prof</span> <span class="op">+</span> <span class="va">non_prof</span>,</span>
<span>    obs <span class="op">=</span> <span class="va">prof</span>,</span>
<span>    exp <span class="op">=</span> <span class="op">(</span><span class="va">global_prof</span> <span class="op">*</span> <span class="va">count</span><span class="op">)</span>,</span>
<span>    resid <span class="op">=</span> <span class="op">(</span><span class="va">obs</span> <span class="op">-</span> <span class="va">exp</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">exp</span><span class="op">^</span><span class="fl">.7</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Join on d_bor for an O-OD map.</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">grid</span> <span class="op">|&gt;</span> <span class="fu">select</span><span class="op">(</span><span class="va">area_name</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"o_bor"</span> <span class="op">=</span> <span class="st">"area_name"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    bor_label <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">o_bor</span> <span class="op">==</span> <span class="va">d_bor</span>, <span class="va">d_bor</span>, <span class="st">""</span><span class="op">)</span>,</span>
<span>    bor_focus <span class="op">=</span> <span class="va">o_bor</span> <span class="op">==</span> <span class="va">d_bor</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">st_as_sf</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bbox_grid</span> <span class="op">&lt;-</span> <span class="fu">st_bbox</span><span class="op">(</span><span class="va">grid</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill<span class="op">=</span><span class="va">resid</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"#616161"</span>, size <span class="op">=</span> <span class="fl">0.15</span>, alpha <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">.</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">bor_focus</span><span class="op">)</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"transparent"</span>, colour <span class="op">=</span> <span class="st">"#373737"</span>, size <span class="op">=</span> <span class="fl">0.3</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_text</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">plot_data</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">bor_focus</span><span class="op">)</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">o_x</span>, y <span class="op">=</span> <span class="va">o_y</span>, label <span class="op">=</span> <span class="fu">str_extract</span><span class="op">(</span><span class="va">o_bor</span>, <span class="st">"^.{1}"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    colour <span class="op">=</span> <span class="st">"#252525"</span>, alpha <span class="op">=</span> <span class="fl">0.9</span>, size <span class="op">=</span> <span class="fl">2.1</span>,</span>
<span>    hjust <span class="op">=</span> <span class="st">"centre"</span>, vjust <span class="op">=</span> <span class="st">"middle"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_text</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">plot_data</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">bor_focus</span><span class="op">)</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">bbox_grid</span><span class="op">$</span><span class="va">xmax</span>, y <span class="op">=</span> <span class="va">bbox_grid</span><span class="op">$</span><span class="va">ymin</span>, label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/abbreviate.html">abbreviate</a></span><span class="op">(</span><span class="va">o_bor</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    colour <span class="op">=</span> <span class="st">"#252525"</span>, alpha <span class="op">=</span> <span class="fl">0.9</span>, size <span class="op">=</span> <span class="fl">3.5</span>,</span>
<span>    hjust <span class="op">=</span> <span class="st">"right"</span>, vjust <span class="op">=</span> <span class="st">"bottom"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>crs <span class="op">=</span> <span class="fu">st_crs</span><span class="op">(</span><span class="va">plot_data</span><span class="op">)</span>, datum <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_grid</span><span class="op">(</span><span class="op">-</span><span class="va">d_row</span> <span class="op">~</span> <span class="va">d_col</span>, shrink <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_distiller</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"RdBu"</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>ggplot2</code> spec:</p>
<ul>
<li>Data:
<ul>
<li>Calculate the proportion of professional jobs in the dataset (<code>global_prof</code>).</li>
<li>Then for each destination (workplace) borough calculate the expected number of commutes for any OD pair by multiplying the number of jobs contained in that OD pair by <code>global_prof</code> and express the difference between the actual number of professional jobs as rate with power transform (<code>(obs-exp) / (exp^.7)</code>).</li>
<li>Take the staged dataset and join twice on the <code>gridmap</code> dataset.</li>
<li>Then join the with the gridded polygon file (<code>grid</code>) on <code>o_bor</code> – in this OD map the small cells are origins.</li>
<li>Finally in the <code>mutate()</code> we generate a new variable identifying the borough in focus (<code>bor_focus</code>), destination in this case, and a text label variable for annotating plots on this (<code>bor_label</code>).</li>
</ul>
</li>
<li>Encoding:
<ul>
<li>Gridmap cells are coloured according to the calculated residuals (<code>fill=resid</code>).</li>
<li>Text labels for focus (workplace) boroughs are drawn in the bottom-right corner of larger cells. Note that the coordinate space here is that from the gridmap dataset and so the <em>x,y</em> location of borough labels are derived from the bounding box object (<code>bbox_grid</code>), calculated during data staging. Single letter annotations are also positioned where small origin cells match the focus borough. These additional labels are positioned using the grid centroids <code>o_x</code>, <code>o_y</code> from plot_data.</li>
</ul>
</li>
<li>Marks: <code>geom_sf()</code> for drawing the small grid-cell maps; <code>geom_text()</code> for drawing the labels.</li>
<li>Scale: <code>scale_fill_distiller()</code> for a diverging colour scheme using the ColorBrewer <span class="citation" data-cites="harrower_colorbrewerorg_2003">(<a href="references.html#ref-harrower_colorbrewerorg_2003" role="doc-biblioref">Harrower and Brewer 2003</a>)</span> <code>RdBu</code> palette and made symmetrical on 0 by manually setting <code>limits()</code>.</li>
<li>Facets: <code>facet_grid()</code> for effecting the map-within-map layout.</li>
</ul>
<p>Once the data staging and <code>ggplot2</code> code for the OD map is generated, it is very easy to adapt and extend the code to explore different assumptions and elements of the dataset. For example, the assumption of a uniform distribution across London in the relative number of commutes by occupation type is a flawed one since we know that there is some variation in the proportion of professional jobs available in each borough. In the City of London (CoL) 74% of jobs are professional whereas in Bexley (Bxl), Havering (Hvr) and Barking and Dagenham (BaD) that figure is c.30%. We can easily adapt the data staging code to instead generate local expectations for each destination borough by moving the assignment of <code>global_prof</code> into a <code>group_by()</code> on destination borough. The expectation is now that the relative number of professional commutes present in any OD pair should be proportionally equivalent to the number of professional jobs available at that OD pair’s reference, destination, borough. Colouring cells of the OD map according to this new quantity (<a href="#fig-edges-odmap-borough">Figure&nbsp;<span>5.12</span></a>) exposes patterns that relate to London’s social geography. Higher than expected <em>non-professional</em> workers from more affordable boroughs to the east of London and into job-rich boroughs in central London and a reverse pattern for origin boroughs supplying higher than expected <em>professional</em> workers.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-edges-odmap-borough" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/05/edges_odmap_within.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;5.12: Commutes between London boroughs: difference maps by occupation type assuming <em>professional</em> and <em>non-professional</em> distribute uniformly within boroughs.</figcaption></figure>
</div>
</div>
</div>
</section></section><section id="conclusions" class="level2" data-number="5.4"><h2 data-number="5.4" class="anchored" data-anchor-id="conclusions">
<span class="header-section-number">5.4</span> Conclusions</h2>
<p>Network data are challenging to represent, work with and analyse. It is for this reason that visual approaches are often used in their analysis. A common pitfall to many network visualizations is that they simply re-present that complexity without exposing useful structure or insight into the phenomena being analysed. Through an analysis of 2011 Census travel-to-work data in London, this chapter demonstrated approaches to analysing and inferring structure in a category of network data common to geographers: spatial origin-destination data. Spatially-arranged node-link diagrams are highly intuitive and can support a kind of synoptic overview of a network, but were of limited success in representing detailed patterns in travel-to-work within and between London boroughs. Instead we used matrix-based views, including spatially arranged matrices or OD Maps. As ever, the appropriateness of either approach, node-link based or matrix-based representations, depends on data, analysis purpose and audience.</p>
</section><section id="further-reading" class="level2" data-number="5.5"><h2 data-number="5.5" class="anchored" data-anchor-id="further-reading">
<span class="header-section-number">5.5</span> Further Reading</h2>
<p>For working with network data in tidyverse and ggplot2:</p>
<ul>
<li>Wickham, H., Navarro, D. and Lin Pedersen, T. 2023. “ggplot2: Elegant Graphics for Data Analysis Third Edition.” <em>Springer</em>.</li>
</ul>
<p>For the original OD maps paper:</p>
<ul>
<li>Wood, J., Dykes, J. and Slingsby, A. 2010. “Visualisation of Origins, Destinations and Flows with OD Maps.” <em>The Cartographic Journal</em>, 47(2): 117–29. doi: <a href="https://doi.org/10.1179/000870410X12658023467367">10.1179/000870410X12658023467367</a>.</li>
</ul>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./04-explore.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Exploratory Data Analysis</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./06-model.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Models</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>